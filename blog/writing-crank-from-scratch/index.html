<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>Crank.js | Writing Crank from Scratch</title><link rel="shortcut icon" href="/static/favicon-eefec412b1f6cade.ico"><style>.css-yop4go{position:relative;width:60px;height:32px;border-radius:16px;border:1px solid var(--text-color);background:transparent;cursor:pointer;padding:0 4px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;font-size:16px;}.css-yop4go:focus{outline:none;border-color:var(--highlight-color);}.css-zj66tk{position:absolute;width:26px;height:26px;border-radius:50%;border:1px solid var(--text-color);background:var(--bg-color);-webkit-transition:left 0.2s;transition:left 0.2s;display:none;}.css-1l1hcps{position:fixed;top:0;left:0;right:0;height:50px;z-index:999;gap:1em;}.css-1n0j5y9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;gap:1em;}.css-1xmwt0h{border-bottom:1px solid var(--text-color);overflow-x:auto;background-color:inherit;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;gap:1em;}.css-1xmwt0h a{-webkit-text-decoration:none;text-decoration:none;font-weight:bold;}@media screen and (min-width: 800px){.css-1xmwt0h{padding:0 2em;}}.css-1nd56js{background-color:var(--bg-color);border-top:1px solid var(--text-color);padding:2em;text-align:center;font-size:14px;}.css-nf2n4z{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;gap:2em;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-bottom:1em;}.css-1st8n6b{margin:0;color:var(--text-color);opacity:0.7;}.css-1xzghkg{position:absolute;top:0.5em;right:0.5em;z-index:10;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;gap:8px;}.css-1y5ulpa{height:24px;padding:0 8px;border-radius:4px;border:1px solid var(--text-color);background:transparent;font-size:10px;font-family:monospace;cursor:pointer;opacity:0.7;-webkit-transition:opacity 0.2s;transition:opacity 0.2s;}.css-1y5ulpa:hover{opacity:1;}.css-i7rnhw{overflow-x:auto;}.css-1y4o4pq{position:relative;min-height:100%;width:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;background-color:var(--bg-color);}.css-84ojsb{display:contents;}.css-1ashatc{-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;word-break:break-all;overflow-wrap:anywhere;line-break:anywhere;white-space:pre-wrap;white-space:break-spaces;font-size:16px;}.css-1flouoi{border-bottom:1px dotted #333;}.color-scheme-light .css-1flouoi{border-bottom:1px dotted #ddd;}.css-zdhcu5{max-width:900px;margin:0 auto;padding:80px 1rem 3rem;}@media (min-width: 800px){.css-zdhcu5{padding:100px 2rem 4rem;}}.css-x4gmui{margin-bottom:2rem;}.css-1n45enn{color:var(--highlight-color);-webkit-text-decoration:none;text-decoration:none;font-size:0.95rem;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;gap:0.5rem;}.css-1n45enn:hover{-webkit-text-decoration:underline;text-decoration:underline;}.css-1gworah{max-width:800px;margin-top:2rem;}.css-9hlwm{max-width:800px;margin-top:3rem;padding-top:2rem;border-top:1px solid var(--text-color);}.css-46rcdh{max-width:800px;}.css-v1f5ct{margin-bottom:2.5rem;padding-bottom:2rem;border-bottom:1px solid var(--text-color);}.css-1kfm06i{font-size:2.25rem;line-height:1.2;margin:0 0 1rem;color:var(--highlight-color);}@media (min-width: 600px){.css-1kfm06i{font-size:2.75rem;}}.css-1nw8vb3{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;gap:0.5rem 1rem;font-size:0.95rem;color:var(--text-color);opacity:0.7;}.css-1hygmuu{color:var(--highlight-color);-webkit-text-decoration:none;text-decoration:none;}.css-1hygmuu:hover{-webkit-text-decoration:underline;text-decoration:underline;}.css-1q673rb{font-size:1.2rem;line-height:1.6;color:var(--text-color);opacity:0.85;margin:1.5rem 0 0;font-style:italic;}.css-19mvv3y{font-size:1.1rem;line-height:1.75;}.css-19mvv3y h2{font-size:1.75rem;margin:2.5rem 0 1rem;color:var(--highlight-color);}.css-19mvv3y h3{font-size:1.35rem;margin:2rem 0 0.75rem;}.css-19mvv3y p{margin:1.25rem 0;}.css-19mvv3y a{color:var(--highlight-color);}.css-19mvv3y blockquote{margin:1.5rem 0;padding:1rem 1.5rem;border-left:3px solid var(--highlight-color);background:rgba(128, 128, 128, 0.1);font-style:italic;}.css-19mvv3y blockquote p{margin:0;}.css-19mvv3y ul,.css-19mvv3y ol{margin:1.25rem 0;padding-left:1.5rem;}.css-19mvv3y li{margin:0.5rem 0;}.css-19mvv3y img{max-width:100%;height:auto;border-radius:4px;}.css-19mvv3y hr{border:none;border-top:1px solid var(--text-color);opacity:0.3;margin:2.5rem 0;}.css-19mvv3y .code-block-live{width:100vw;max-width:1400px;position:relative;left:50%;-webkit-transform:translateX(-50%);-moz-transform:translateX(-50%);-ms-transform:translateX(-50%);transform:translateX(-50%);padding:0 1rem;box-sizing:border-box;}@media (min-width: 800px){.css-19mvv3y .code-block-live{padding:0 2rem;}}.css-19mvv3y .code-block-container:not(.code-block-live){max-width:100%;}.css-1vm8pxc{max-width:min(100%, 1000px);}.css-1s1lac9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;font-size:16px;}@media (min-width: 1300px){.css-1s1lac9{-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-1lyfw13{position:relative;-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;width:100%;border:1px solid var(--text-color);border-radius:4px;overflow:hidden;}.css-vrpffa{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;gap:0.5rem;font-size:0.9rem;color:var(--text-color);opacity:0.6;-webkit-text-decoration:none;text-decoration:none;-webkit-transition:opacity 0.2s ease;transition:opacity 0.2s ease;}.css-vrpffa:hover{opacity:1;color:var(--highlight-color);}</style><link rel="stylesheet" type="text/css" href="/static/client-3f2e47bea41770a9.css"><meta name="description" content="A step-by-step guide to building Crank.js from the ground up, demonstrating how virtual DOM libraries work and showcasing advanced techniques with iterators and promises."><meta property="og:title" content="Crank.js | Writing Crank from Scratch"><meta property="og:url" content="https:/crank.js.org/blog/writing-crank-from-scratch"><meta property="og:description" content="A step-by-step guide to building Crank.js from the ground up, demonstrating how virtual DOM libraries work and showcasing advanced techniques with iterators and promises."><meta property="og:type" content="website"><meta property="og:site_name" content="Crank.js"><meta property="og:image" content="/static/logo-9c727b9c5ba929af.svg"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Crank.js | Writing Crank from Scratch"><meta name="twitter:description" content="A step-by-step guide to building Crank.js from the ground up, demonstrating how virtual DOM libraries work and showcasing advanced techniques with iterators and promises."><meta name="twitter:image" content="/static/logo-9c727b9c5ba929af.svg"></head><body><script>(() => { const s = sessionStorage.getItem("color-scheme");
		const scheme = s === "dark" || s === "light" ? s :
			(window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
		const isDark = scheme === "dark";
		document.documentElement.dataset.theme = scheme;
		document.documentElement.style.setProperty("--bg-color", isDark ? "#0a0e1f" : "#e7f4f5");
		document.documentElement.style.setProperty("--text-color", isDark ? "#f5f9ff" : "#0a0e1f");
		if (!isDark) document.documentElement.classList.add("color-scheme-light"); })()</script><div id="navbar-root"><nav class="
				blur-background
				css-1l1hcps
				css-1xmwt0h
			"><div class="css-1n0j5y9"><div><a class="css-1n0j5y9" style="gap: 0.3em" href="/"><svg style="flex: none;" fill="none" viewBox="-200 -200 400 400" width="1.9em" height="1.9em" xmlns="http://www.w3.org/2000/svg"><defs><mask id="wedge-mask"><rect x="-200" y="-200" width="400" height="400" fill="white"></rect><path stroke="none" fill="black" d="
							M 0 0
							L 245.74561328669753 172.07293090531383
							L 245.74561328669753 -172.07293090531383
							z
						"></path></mask></defs><g stroke="none" fill="var(--highlight-color)"><path transform="rotate(0)" d="M 149.39 -16.97 M 149.62 -16.98 M 150.29 -17 M 151.42 -16.97 M 153 -16.85 M 155.02 -16.57 M 157.46 -16.1 M 160.32 -15.39 M 163.56 -14.39 M 167.17 -13.06 M 171.11 -11.35 M 175.36 -9.23 M 179.88 -6.66 M 179.88 6.66 M 175.36 9.23 M 171.11 11.35 M 167.17 13.06 M 163.56 14.39 M 160.32 15.39 M 157.46 16.1 M 155.02 16.57 M 153 16.85 M 151.42 16.97 M 150.29 17 M 149.62 16.98 M 149.39 16.97 A 8 8 0 0 0 144.51 41.5 L 144.73 41.57 L 145.36 41.81 L 146.39 42.27 L 147.8 42.99 L 149.56 44.01 L 151.64 45.38 L 154 47.13 L 156.62 49.29 L 159.44 51.9 L 162.43 54.99 L 165.54 58.58 L 168.73 62.69 L 163.64 74.98 L 158.48 75.64 L 153.74 75.97 L 149.44 76.04 L 145.6 75.89 L 142.22 75.57 L 139.31 75.14 L 136.88 74.63 L 134.91 74.11 L 133.4 73.63 L 132.35 73.22 L 131.73 72.95 L 131.53 72.84 A 8 8 0 0 0 117.63 93.64 L 117.8 93.79 L 118.3 94.25 L 119.07 95.07 L 120.1 96.28 L 121.33 97.9 L 122.73 99.96 L 124.24 102.48 L 125.83 105.48 L 127.44 108.97 L 129.02 112.96 L 130.52 117.47 L 131.9 122.49 L 122.49 131.9 L 117.47 130.52 L 112.96 129.02 L 108.97 127.44 L 105.48 125.83 L 102.48 124.24 L 99.96 122.73 L 97.9 121.33 L 96.28 120.1 L 95.07 119.07 L 94.25 118.3 L 93.79 117.8 L 93.64 117.63 A 8 8 0 0 0 72.84 131.53 L 72.95 131.73 L 73.22 132.35 L 73.63 133.4 L 74.11 134.91 L 74.63 136.88 L 75.14 139.31 L 75.57 142.22 L 75.89 145.6 L 76.04 149.44 L 75.97 153.74 L 75.64 158.48 L 74.98 163.64 L 62.69 168.73 L 58.58 165.54 L 54.99 162.43 L 51.9 159.44 L 49.29 156.62 L 47.13 154 L 45.38 151.64 L 44.01 149.56 L 42.99 147.8 L 42.27 146.39 L 41.81 145.36 L 41.57 144.73 L 41.5 144.51 A 8 8 0 0 0 16.97 149.39 L 16.98 149.62 L 17 150.29 L 16.97 151.42 L 16.85 153 L 16.57 155.02 L 16.1 157.46 L 15.39 160.32 L 14.39 163.56 L 13.06 167.17 L 11.35 171.11 L 9.23 175.36 L 6.66 179.88 L -6.66 179.88 L -9.23 175.36 L -11.35 171.11 L -13.06 167.17 L -14.39 163.56 L -15.39 160.32 L -16.1 157.46 L -16.57 155.02 L -16.85 153 L -16.97 151.42 L -17 150.29 L -16.98 149.62 L -16.97 149.39 A 8 8 0 0 0 -41.5 144.51 L -41.57 144.73 L -41.81 145.36 L -42.27 146.39 L -42.99 147.8 L -44.01 149.56 L -45.38 151.64 L -47.13 154 L -49.29 156.62 L -51.9 159.44 L -54.99 162.43 L -58.58 165.54 L -62.69 168.73 L -74.98 163.64 L -75.64 158.48 L -75.97 153.74 L -76.04 149.44 L -75.89 145.6 L -75.57 142.22 L -75.14 139.31 L -74.63 136.88 L -74.11 134.91 L -73.63 133.4 L -73.22 132.35 L -72.95 131.73 L -72.84 131.53 A 8 8 0 0 0 -93.64 117.63 L -93.79 117.8 L -94.25 118.3 L -95.07 119.07 L -96.28 120.1 L -97.9 121.33 L -99.96 122.73 L -102.48 124.24 L -105.48 125.83 L -108.97 127.44 L -112.96 129.02 L -117.47 130.52 L -122.49 131.9 L -131.9 122.49 L -130.52 117.47 L -129.02 112.96 L -127.44 108.97 L -125.83 105.48 L -124.24 102.48 L -122.73 99.96 L -121.33 97.9 L -120.1 96.28 L -119.07 95.07 L -118.3 94.25 L -117.8 93.79 L -117.63 93.64 A 8 8 0 0 0 -131.53 72.84 L -131.73 72.95 L -132.35 73.22 L -133.4 73.63 L -134.91 74.11 L -136.88 74.63 L -139.31 75.14 L -142.22 75.57 L -145.6 75.89 L -149.44 76.04 L -153.74 75.97 L -158.48 75.64 L -163.64 74.98 L -168.73 62.69 L -165.54 58.58 L -162.43 54.99 L -159.44 51.9 L -156.62 49.29 L -154 47.13 L -151.64 45.38 L -149.56 44.01 L -147.8 42.99 L -146.39 42.27 L -145.36 41.81 L -144.73 41.57 L -144.51 41.5 A 8 8 0 0 0 -149.39 16.97 L -149.62 16.98 L -150.29 17 L -151.42 16.97 L -153 16.85 L -155.02 16.57 L -157.46 16.1 L -160.32 15.39 L -163.56 14.39 L -167.17 13.06 L -171.11 11.35 L -175.36 9.23 L -179.88 6.66 L -179.88 -6.66 L -175.36 -9.23 L -171.11 -11.35 L -167.17 -13.06 L -163.56 -14.39 L -160.32 -15.39 L -157.46 -16.1 L -155.02 -16.57 L -153 -16.85 L -151.42 -16.97 L -150.29 -17 L -149.62 -16.98 L -149.39 -16.97 A 8 8 0 0 0 -144.51 -41.5 L -144.73 -41.57 L -145.36 -41.81 L -146.39 -42.27 L -147.8 -42.99 L -149.56 -44.01 L -151.64 -45.38 L -154 -47.13 L -156.62 -49.29 L -159.44 -51.9 L -162.43 -54.99 L -165.54 -58.58 L -168.73 -62.69 L -163.64 -74.98 L -158.48 -75.64 L -153.74 -75.97 L -149.44 -76.04 L -145.6 -75.89 L -142.22 -75.57 L -139.31 -75.14 L -136.88 -74.63 L -134.91 -74.11 L -133.4 -73.63 L -132.35 -73.22 L -131.73 -72.95 L -131.53 -72.84 A 8 8 0 0 0 -117.63 -93.64 L -117.8 -93.79 L -118.3 -94.25 L -119.07 -95.07 L -120.1 -96.28 L -121.33 -97.9 L -122.73 -99.96 L -124.24 -102.48 L -125.83 -105.48 L -127.44 -108.97 L -129.02 -112.96 L -130.52 -117.47 L -131.9 -122.49 L -122.49 -131.9 L -117.47 -130.52 L -112.96 -129.02 L -108.97 -127.44 L -105.48 -125.83 L -102.48 -124.24 L -99.96 -122.73 L -97.9 -121.33 L -96.28 -120.1 L -95.07 -119.07 L -94.25 -118.3 L -93.79 -117.8 L -93.64 -117.63 A 8 8 0 0 0 -72.84 -131.53 L -72.95 -131.73 L -73.22 -132.35 L -73.63 -133.4 L -74.11 -134.91 L -74.63 -136.88 L -75.14 -139.31 L -75.57 -142.22 L -75.89 -145.6 L -76.04 -149.44 L -75.97 -153.74 L -75.64 -158.48 L -74.98 -163.64 L -62.69 -168.73 L -58.58 -165.54 L -54.99 -162.43 L -51.9 -159.44 L -49.29 -156.62 L -47.13 -154 L -45.38 -151.64 L -44.01 -149.56 L -42.99 -147.8 L -42.27 -146.39 L -41.81 -145.36 L -41.57 -144.73 L -41.5 -144.51 A 8 8 0 0 0 -16.97 -149.39 L -16.98 -149.62 L -17 -150.29 L -16.97 -151.42 L -16.85 -153 L -16.57 -155.02 L -16.1 -157.46 L -15.39 -160.32 L -14.39 -163.56 L -13.06 -167.17 L -11.35 -171.11 L -9.23 -175.36 L -6.66 -179.88 L 6.66 -179.88 L 9.23 -175.36 L 11.35 -171.11 L 13.06 -167.17 L 14.39 -163.56 L 15.39 -160.32 L 16.1 -157.46 L 16.57 -155.02 L 16.85 -153 L 16.97 -151.42 L 17 -150.29 L 16.98 -149.62 L 16.97 -149.39 A 8 8 0 0 0 41.5 -144.51 L 41.57 -144.73 L 41.81 -145.36 L 42.27 -146.39 L 42.99 -147.8 L 44.01 -149.56 L 45.38 -151.64 L 47.13 -154 L 49.29 -156.62 L 51.9 -159.44 L 54.99 -162.43 L 58.58 -165.54 L 62.69 -168.73 L 74.98 -163.64 L 75.64 -158.48 L 75.97 -153.74 L 76.04 -149.44 L 75.89 -145.6 L 75.57 -142.22 L 75.14 -139.31 L 74.63 -136.88 L 74.11 -134.91 L 73.63 -133.4 L 73.22 -132.35 L 72.95 -131.73 L 72.84 -131.53 A 8 8 0 0 0 93.64 -117.63 L 93.79 -117.8 L 94.25 -118.3 L 95.07 -119.07 L 96.28 -120.1 L 97.9 -121.33 L 99.96 -122.73 L 102.48 -124.24 L 105.48 -125.83 L 108.97 -127.44 L 112.96 -129.02 L 117.47 -130.52 L 122.49 -131.9 L 131.9 -122.49 L 130.52 -117.47 L 129.02 -112.96 L 127.44 -108.97 L 125.83 -105.48 L 124.24 -102.48 L 122.73 -99.96 L 121.33 -97.9 L 120.1 -96.28 L 119.07 -95.07 L 118.3 -94.25 L 117.8 -93.79 L 117.63 -93.64 A 8 8 0 0 0 131.53 -72.84 L 131.73 -72.95 L 132.35 -73.22 L 133.4 -73.63 L 134.91 -74.11 L 136.88 -74.63 L 139.31 -75.14 L 142.22 -75.57 L 145.6 -75.89 L 149.44 -76.04 L 153.74 -75.97 L 158.48 -75.64 L 163.64 -74.98 L 168.73 -62.69 L 165.54 -58.58 L 162.43 -54.99 L 159.44 -51.9 L 156.62 -49.29 L 154 -47.13 L 151.64 -45.38 L 149.56 -44.01 L 147.8 -42.99 L 146.39 -42.27 L 145.36 -41.81 L 144.73 -41.57 L 144.51 -41.5 A 8 8 0 0 0 149.39 -16.97 L 149.62 -16.98 L 150.29 -17 L 151.42 -16.97 L 153 -16.85 L 155.02 -16.57 L 157.46 -16.1 L 160.32 -15.39 L 163.56 -14.39 L 167.17 -13.06 L 171.11 -11.35 L 175.36 -9.23 L 179.88 -6.66 L 179.88 6.66 L 175.36 9.23 L 171.11 11.35 L 167.17 13.06 L 163.56 14.39 L 160.32 15.39 L 157.46 16.1 L 155.02 16.57 L 153 16.85 L 151.42 16.97 L 150.29 17 L 149.62 16.98 L 149.39 16.97
			  M -110 0
				a 110 110 0 1 0 220 0
				a 110 110 0 1 0 -220 0
			" mask="url(#wedge-mask)" stroke="none" stroke-width="4"></path><circle cx="0" cy="0" r="60" stroke="none"></circle><path d="
						M 0 -28
						L 160 -14
						L 160 14
						L 0 28
						Z
					"></path></g></svg>Crank.js</a></div><div><a href="/guides/getting-started">Guides</a></div><div><a href="/api">API</a></div><div><a href="/blog/" aria-current="page">Blog</a></div><div><a href="/playground/">Playground</a></div></div><div class="css-1n0j5y9"><div><a href="https://github.com/bikeshaving/crank">GitHub</a></div><div><a href="http://npm.im/@b9g/crank">NPM</a></div><button role="switch" aria-label="toggle color scheme" aria-checked="true" class="css-yop4go"><span>üåô</span><span>üí°</span><span class="css-zj66tk"></span></button></div></nav></div><main class="css-zdhcu5"><nav class="css-x4gmui"><a href="/blog" class="css-1n45enn">‚Üê Back to Blog</a></nav><article class="css-46rcdh"><header class="css-v1f5ct"><h1 class="css-1kfm06i">Writing Crank from Scratch</h1><div class="css-1nw8vb3"><span>By <a href="https://github.com/brainkim" rel="author" class="css-1hygmuu">Brian Kim</a></span><span style="opacity: 0.5">/</span><span>October 13, 2020</span><span style="opacity: 0.5">/</span><span>83 min read</span></div><p class="css-1q673rb">A step-by-step guide to building Crank.js from the ground up, demonstrating how virtual DOM libraries work and showcasing advanced techniques with iterators and promises.</p></header><div class="css-19mvv3y"><p>One of my goals when authoring Crank.js was to create a framework which was so simple that any intermediate JavaScript developer could conceivably write it from scratch. What I think makes this uniquely achievable for Crank is that its component model is built on top of JavaScript‚Äôs two main control flow abstractions, iterators and promises, allowing developers to write components exclusively with sync and async functions and generator functions.</p><p>The following is an attempt to prove that I‚Äôve met this goal by rewriting the bulk of Crank‚Äôs core logic as a series of additive commits, with explanations for what I‚Äôm doing at each step.</p><p>Even if you don‚Äôt plan on using Crank, this essay may yet prove informative in that it will demonstrate the basics of how virtual DOM libraries work, and show you some advanced techniques for working with iterators and promises. I will also attempt to justify some of the design decisions I made along the way, as I make them. Moreover, the end result won‚Äôt just be a toy library, but something which looks very similar to Crank‚Äôs actual source code, making the jump from reading this essay to contributing to the project much easier, should you be so inclined.</p><p>At each step, we‚Äôll edit a single file which serves as the Crank module, and present a unified diff of the changes. We‚Äôll also provide a link to the relevant commit and snapshot for each step in <a href="https://github.com/brainkim/crank-from-scratch">this companion repository</a>.</p><p>You can try out the module we create by referencing it from the following HTML file.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> <span class="token constant">HTML</span><span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">&lt;</span>html<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code><span class="token operator">&lt;</span>head<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>  <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;utf-8&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Crank from Scratch<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>  <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://unpkg.com/@babel/standalone/babel.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>Babel<span class="token punctuation">.</span><span class="token function">registerPreset</span><span class="token punctuation">(</span><span class="token string">&quot;crank&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>  <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>    <span class="token punctuation">[</span>Babel<span class="token punctuation">.</span>availablePresets<span class="token punctuation">.</span>react<span class="token punctuation">,</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>      <span class="token literal-property property">runtime</span><span class="token operator">:</span> <span class="token string">&quot;classic&quot;</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>      <span class="token literal-property property">pragma</span><span class="token operator">:</span> <span class="token string">&quot;createElement&quot;</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>      <span class="token literal-property property">pragmaFrag</span><span class="token operator">:</span> <span class="token string">&quot;&#039;&#039;&quot;</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code>  <span class="token punctuation">]</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code>  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code><span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code>  <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;app&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code>  <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;text/babel&quot;</span> data<span class="token operator">-</span>type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span> data<span class="token operator">-</span>presets<span class="token operator">=</span><span class="token string">&quot;crank&quot;</span><span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>createElement<span class="token punctuation">,</span> Renderer<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./crank.js&quot;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code><span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Renderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code><span class="token keyword">const</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><code>  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Hello <span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token string">&quot;color: red;&quot;</span><span class="token operator">&gt;</span>world<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><code>  app<span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><code><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><code>  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="29"><code><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="30"><code><span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-14" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-14'] = {"code":"\u003C!DOCTYPE HTML\u003E\n\u003Chtml\u003E\n\u003Chead\u003E\n  \u003Cmeta charset=\"utf-8\"\u002F\u003E\n  \u003Ctitle\u003ECrank from Scratch\u003C\u002Ftitle\u003E\n  \u003Cscript src=\"https:\u002F\u002Funpkg.com\u002F@babel\u002Fstandalone\u002Fbabel.min.js\"\u003E\u003C\u002Fscript\u003E\n  \u003Cscript\u003E\nBabel.registerPreset(\"crank\", {\n  presets: [\n    [Babel.availablePresets.react, {\n      runtime: \"classic\",\n      pragma: \"createElement\",\n      pragmaFrag: \"''\",\n    }],\n  ],\n});\n  \u003C\u002Fscript\u003E\n\u003C\u002Fhead\u003E\n\u003Cbody\u003E\n  \u003Cdiv id=\"app\"\u003E\u003C\u002Fdiv\u003E\n  \u003Cscript type=\"text\u002Fbabel\" data-type=\"module\" data-presets=\"crank\"\u003E\nimport {createElement, Renderer} from \".\u002Fcrank.js\";\nconst renderer = new Renderer();\nconst app = document.getElementById(\"app\");\nrenderer.render(\n  \u003Cdiv\u003EHello \u003Cspan style=\"color: red;\"\u003Eworld\u003C\u002Fspan\u003E\u003C\u002Fdiv\u003E,\n  app,\n);\n  \u003C\u002Fscript\u003E\n\u003C\u002Fbody\u003E\n\u003C\u002Fhtml\u003E","lang":"html"};
		</script></div><p>This file uses the <a href="https://babeljs.io/docs/en/babel-standalone">Babel standalone transpiler</a> to transpile <a href="https://facebook.github.io/jsx/">JSX</a> on the fly. We don‚Äôt transpile modern ECMAScript features, so you will need to open the file from an up-to-date browser. Alternatively, if you don‚Äôt want to use JSX, you can use the <a href="https://github.com/developit/htm">HTM template tag</a>, which requires no transpilation. The examples in this essay will use JSX, but you are free to use HTM or any other alternative.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> <span class="token constant">HTML</span><span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">&lt;</span>html<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code><span class="token operator">&lt;</span>head<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>  <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;utf-8&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Crank from Scratch<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code><span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>  <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;app&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>  <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span><span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code><span class="token keyword">import</span> htm <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/htm?module&quot;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>createElement<span class="token punctuation">,</span> Renderer<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./crank.js&quot;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code><span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">htm</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>createElement<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Renderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code><span class="token keyword">const</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code>  html<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;Hello &lt;span style=&quot;color: red;&quot;&gt;world&lt;/span&gt;&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code>  app<span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code>  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code><span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-15" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-15'] = {"code":"\u003C!DOCTYPE HTML\u003E\n\u003Chtml\u003E\n\u003Chead\u003E\n  \u003Cmeta charset=\"utf-8\"\u002F\u003E\n  \u003Ctitle\u003ECrank from Scratch\u003C\u002Ftitle\u003E\n\u003C\u002Fhead\u003E\n\u003Cbody\u003E\n  \u003Cdiv id=\"app\"\u003E\u003C\u002Fdiv\u003E\n  \u003Cscript type=\"module\"\u003E\nimport htm from \"https:\u002F\u002Funpkg.com\u002Fhtm?module\";\nimport {createElement, Renderer} from \".\u002Fcrank.js\";\nconst html = htm.bind(createElement);\nconst renderer = new Renderer();\nconst app = document.getElementById(\"app\");\nrenderer.render(\n  html`\u003Cdiv\u003EHello \u003Cspan style=\"color: red;\"\u003Eworld\u003C\u002Fspan\u003E\u003C\u002Fdiv\u003E`,\n  app,\n);\n  \u003C\u002Fscript\u003E\n\u003C\u002Fbody\u003E\n\u003C\u002Fhtml\u003E","lang":"html"};
		</script></div><p>This essay assumes an intermediate level of JavaScript experience, as well as some experience with a virtual DOM framework like React.</p><h2 id="step-1-creating-dom-nodes">Step 1: Creating DOM Nodes</h2><p>The first thing we‚Äôll need to do is to implement a <code class="inline">createElement()</code> function, so that the module works with JSX. While the React team is <a href="https://reactjs.org/blog/2020/09/22/introducing-the-new-jsx-transform.html">working on an alterative JSX output</a>, we‚Äôll stick to its original transpilation, where JSX element expressions are transpiled to <code class="inline">createElement()</code> calls, with the <em>tag</em>, <em>props</em> and <em>children</em> of the syntax transpiled to the first, second, and remaining arguments of the <code class="inline">createElement()</code> call respectively.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">const</span> el <span class="token operator">=</span> <span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;greeting&quot;</span><span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>    Hello <span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token string">&quot;color: red;&quot;</span><span class="token operator">&gt;</span>World<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code><span class="token comment">// transpiles to:</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code><span class="token keyword">const</span> el <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>  <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>  <span class="token punctuation">{</span><span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&quot;greeting&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>  <span class="token string">&quot;Hello &quot;</span><span class="token punctuation">,</span> <span class="token function">createElement</span><span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>    <span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>    <span class="token punctuation">{</span><span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token string">&quot;color: red;&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code>    <span class="token string">&quot;World&quot;</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code>  <span class="token punctuation">)</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-16" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-16'] = {"code":"const el = (\n  \u003Cdiv id=\"greeting\"\u003E\n    Hello \u003Cspan style=\"color: red;\"\u003EWorld\u003C\u002Fspan\u003E\n  \u003C\u002Fdiv\u003E\n);\n\n\u002F\u002F transpiles to:\n\nconst el = createElement(\n  \"div\",\n  {id: \"greeting\"},\n  \"Hello \", createElement(\n    \"span\",\n    {style: \"color: red;\"},\n    \"World\",\n  ),\n);","lang":"jsx"};
		</script></div><p>The other thing we‚Äôll need is a renderer, a JavaScript class which reads element trees and does the actual work of creating and mutating DOM nodes. Importantly, the renderer has a <code class="inline">render()</code> method, which allows us to write code like the following to render a JSX expression into a DOM node.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Hello <span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token string">&quot;color: red;&quot;</span><span class="token operator">&gt;</span>world<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-17" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-17'] = {"code":"renderer.render(\n  \u003Cdiv\u003EHello \u003Cspan style=\"color: red;\"\u003Eworld\u003C\u002Fspan\u003E\u003C\u002Fdiv\u003E,\n  document.getElementById(\"app\"),\n);","lang":"jsx"};
		</script></div><h3 id="implementation">Implementation</h3><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">/</span>dev<span class="token operator">/</span><span class="token keyword">null</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>@@ <span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">99</span> @@</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code><span class="token operator">+</span>  <span class="token keyword">return</span> value <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> value <span class="token operator">:</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code><span class="token operator">+</span><span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code><span class="token operator">+</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code><span class="token operator">+</span><span class="token keyword">export</span> <span class="token keyword">const</span> Portal <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;crank.Portal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code><span class="token operator">+</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code><span class="token operator">+</span>  props <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code><span class="token operator">+</span>    props<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code><span class="token operator">+</span>    props<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code><span class="token operator">+</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><code><span class="token operator">+</span><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Renderer</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><code><span class="token operator">+</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">children<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="29"><code><span class="token operator">+</span>    <span class="token keyword">const</span> portal <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>Portal<span class="token punctuation">,</span> <span class="token punctuation">{</span>root<span class="token punctuation">}</span><span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="30"><code><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> portal<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="31"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="32"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="33"><code><span class="token operator">+</span>  <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="34"><code><span class="token operator">+</span>    <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="35"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="36"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="37"><code><span class="token operator">+</span>  <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="38"><code><span class="token operator">+</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="39"><code><span class="token operator">+</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">&quot;children&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="40"><code><span class="token operator">+</span>        <span class="token keyword">continue</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="41"><code><span class="token operator">+</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="42"><code><span class="token operator">+</span>        name <span class="token operator">=</span> <span class="token string">&quot;className&quot;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="43"><code><span class="token operator">+</span>      <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="44"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="45"><code><span class="token operator">+</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="46"><code><span class="token operator">+</span>        node<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="47"><code><span class="token operator">+</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="48"><code><span class="token operator">+</span>        node<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="49"><code><span class="token operator">+</span>      <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="50"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="51"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="52"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="53"><code><span class="token operator">+</span>  <span class="token function">arrange</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> node<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="54"><code><span class="token operator">+</span>    <span class="token keyword">let</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>firstChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="55"><code><span class="token operator">+</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> newChild <span class="token keyword">of</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="56"><code><span class="token operator">+</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">===</span> newChild<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="57"><code><span class="token operator">+</span>        child <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="58"><code><span class="token operator">+</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="59"><code><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> child<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> Node<span class="token punctuation">.</span><span class="token constant">TEXT_NODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="60"><code><span class="token operator">+</span>          child<span class="token punctuation">.</span>nodeValue <span class="token operator">=</span> newChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="61"><code><span class="token operator">+</span>          child <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="62"><code><span class="token operator">+</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="63"><code><span class="token operator">+</span>          node<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="64"><code><span class="token operator">+</span>        <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="65"><code><span class="token operator">+</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="66"><code><span class="token operator">+</span>        node<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newChild<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="67"><code><span class="token operator">+</span>      <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="68"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="69"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="70"><code><span class="token operator">+</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="71"><code><span class="token operator">+</span>      <span class="token keyword">const</span> nextSibling <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="72"><code><span class="token operator">+</span>      node<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="73"><code><span class="token operator">+</span>      child <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="74"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="75"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="76"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="77"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="78"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="79"><code><span class="token operator">+</span>  <span class="token keyword">const</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="80"><code><span class="token operator">+</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> child <span class="token keyword">of</span> <span class="token function">wrap</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="81"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="82"><code><span class="token operator">+</span>      values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">update</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="83"><code><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="84"><code><span class="token operator">+</span>      values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="85"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="86"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="87"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="88"><code><span class="token operator">+</span>  <span class="token keyword">return</span> <span class="token function">commit</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="89"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="90"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="91"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="92"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> Portal<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="93"><code><span class="token operator">+</span>    renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>root<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="94"><code><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="95"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="96"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="97"><code><span class="token operator">+</span>  <span class="token keyword">const</span> node <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="98"><code><span class="token operator">+</span>  renderer<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="99"><code><span class="token operator">+</span>  renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> node<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="100"><code><span class="token operator">+</span>  <span class="token keyword">return</span> node<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="101"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-18" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-18'] = {"code":"--- \u002Fdev\u002Fnull\n+++ b\u002Fcrank.js\n@@ -0,0 +1,99 @@\n+function wrap(value) {\n+  return value === undefined ? [] : Array.isArray(value) ? value : [value];\n+}\n+\n+class Element {\n+  constructor(tag, props) {\n+    this.tag = tag;\n+    this.props = props;\n+  }\n+}\n+\n+export const Portal = Symbol.for(\"crank.Portal\");\n+\n+export function createElement(tag, props, ...children) {\n+  props = Object.assign({}, props);\n+  if (children.length === 1) {\n+    props.children = children[0];\n+  } else if (children.length \u003E 1) {\n+    props.children = children;\n+  }\n+\n+  return new Element(tag, props);\n+}\n+\n+export class Renderer {\n+  render(children, root) {\n+    const portal = createElement(Portal, {root}, children);\n+    return update(this, portal);\n+  }\n+\n+  create(el) {\n+    return document.createElement(el.tag);\n+  }\n+\n+  patch(el, node) {\n+    for (let [name, value] of Object.entries(el.props)) {\n+      if (name === \"children\") {\n+        continue;\n+      } else if (name === \"class\") {\n+        name = \"className\";\n+      }\n+\n+      if (name in node) {\n+        node[name] = value;\n+      } else {\n+        node.setAttribute(name, value);\n+      }\n+    }\n+  }\n+\n+  arrange(el, node, children) {\n+    let child = node.firstChild;\n+    for (const newChild of children) {\n+      if (child === newChild) {\n+        child = child.nextSibling;\n+      } else if (typeof newChild === \"string\") {\n+        if (child !== null && child.nodeType === Node.TEXT_NODE) {\n+          child.nodeValue = newChild;\n+          child = child.nextSibling;\n+        } else {\n+          node.insertBefore(document.createTextNode(newChild), child);\n+        }\n+      } else {\n+        node.insertBefore(newChild, child);\n+      }\n+    }\n+\n+    while (child !== null) {\n+      const nextSibling = child.nextSibling;\n+      node.removeChild(child);\n+      child = child.nextSibling;\n+    }\n+  }\n+}\n+\n+function update(renderer, el) {\n+  const values = [];\n+  for (const child of wrap(el.props.children)) {\n+    if (child instanceof Element) {\n+      values.push(update(renderer, child));\n+    } else if (child) {\n+      values.push(child);\n+    }\n+  }\n+\n+  return commit(renderer, el, values);\n+}\n+\n+function commit(renderer, el, values) {\n+  if (el.tag === Portal) {\n+    renderer.arrange(el, el.props.root, values);\n+    return undefined;\n+  }\n+\n+  const node = renderer.create(el);\n+  renderer.patch(el, node);\n+  renderer.arrange(el, node, values);\n+  return node;\n+}","lang":"diff"};
		</script></div><p><a href="https://github.com/brainkim/crank-from-scratch/commit/80683e84ac529022c898fdaa72c47d6c26a2cef2">Diff</a> <a href="https://github.com/brainkim/crank-from-scratch/blob/80683e84ac529022c898fdaa72c47d6c26a2cef2/crank.js">File</a></p><p>The <code class="inline">createElement()</code> function creates an <code class="inline">Element</code> instance which has two members, <code class="inline">tag</code> and <code class="inline">props</code>. The <code class="inline">createElement()</code> function‚Äôs main responsibility is to create an object for the element‚Äôs <code class="inline">props</code> if none are passed in, and to collect any remaining arguments under the name ‚Äúchildren‚Äù on the <code class="inline">props</code> object.</p><p>The <code class="inline">Element</code> class should not be confused with the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element"><code class="inline">Element</code> base class</a> provided by the DOM. It‚Äôs an unfortunate name collision, but I also couldn‚Äôt bring myself to name the return value of a function named ‚ÄúcreateElement‚Äù anything else. These virtual elements are more or less plain JavaScript objects, and we only use a class to keep track of the element‚Äôs properties in one place. When referring to actual DOM nodes, we‚Äôll use the term ‚Äúnode‚Äù in identifiers and properties instead.</p><p>As far as rendering goes, we‚Äôve divided the process into the methods <code class="inline">create()</code>, <code class="inline">patch()</code> and <code class="inline">arrange()</code>, and the functions <code class="inline">update()</code> and <code class="inline">commit()</code>. Currently, we could probably inline all of this logic as a single function, but by using the power of hindsight I‚Äôve structured the code so that we‚Äôll mostly add to these functions as we implement more features.</p><p>The <code class="inline">create()</code>, <code class="inline">patch()</code> and <code class="inline">arrange()</code> methods are the only places in the module where we perform actual DOM operations. The <code class="inline">create()</code> method creates DOM nodes, the <code class="inline">patch()</code> method updates their properties and attributes, and the <code class="inline">arrange()</code> method manages the insertion and removal of DOM nodes. These methods are defined on the <code class="inline">Renderer</code> class because it‚Äôs possible that we might want to subclass it for custom DOM behavior, or to render to environments besides the DOM.</p><p>On the other hand, while we could have defined the <code class="inline">update()</code> and <code class="inline">commit()</code> functions as renderer methods as well, we make them functions private to the module because there will never be a need to expose them. We‚Äôll see this technique for ‚Äúmethod‚Äù privacy used more often later.</p><p>The <code class="inline">update()</code> and <code class="inline">commit()</code> functions represent the two phases of walking the element tree to create DOM nodes. The <code class="inline">update()</code> function walks the tree by calling <code class="inline">update()</code> recursively on each element child, collects the results of these calls in a <code class="inline">values</code> array, and calls the <code class="inline">commit()</code> function with this array of values. The <code class="inline">commit()</code> function is where the actual DOM mutations happen in the form of <code class="inline">create()</code>, <code class="inline">patch()</code>, and <code class="inline">arrange()</code> method calls. Finally, the <code class="inline">update()</code> and <code class="inline">commit()</code> functions return the created DOM nodes for each element so the same process can occur higher in the call stack.</p><p><strong>Notes:</strong></p><ol><li>In the <code class="inline">render()</code> method, we create a special <code class="inline">Portal</code> element to serve as the root of the element tree. In Crank, a <code class="inline">Portal</code> is a special element tag which can be used to render into multiple user-provided DOM nodes at the same time. This can be helpful for use-cases such as tooltips or modals, and mirrors a <a href="https://reactjs.org/docs/portals.html">similar API in React</a>. Here, we mainly use it as a way to identify the root element so that we can call the <code class="inline">arrange()</code> method but not the <code class="inline">create()</code> or <code class="inline">patch()</code> methods. The latter two methods wouldn‚Äôt make sense at the root.</li><li>In the <code class="inline">createElement()</code> function, we unwrap the children array if it has a length of one, and don‚Äôt assign it if it has a length of zero. This is a theme we‚Äôll see throughout the implementation, where we unwrap arrays of length zero or one just before we retain them in memory. The reason we do this is that if you look at a typical JSX tree, most of the elements in the tree will have zero or one children, so by not retaining this extra array we can save on runtime memory costs. When we need to actually iterate over the <code class="inline">children</code> prop, we call the utility function <code class="inline">wrap()</code> to create an array on the fly, so we don‚Äôt have to explicitly handle elements with zero or one children.</li></ol><h2 id="step-2-element-diffing">Step 2: Element Diffing</h2><p>Our renderer works, but will recreate every DOM node in the tree for every render. Not only is this inefficient but also incorrect, insofar as the renderer will reset stateful DOM nodes like form or media elements. We need a way to somehow preserve as much of the DOM as possible between renders.</p><p>Thankfully, we can diff entire trees efficiently because of an observation first made by the React authors, which is that for any two element subtrees, different root tags will usually indicate different substructures. For instance, a <code class="inline">table</code> element will almost certainly have different children as compared to a <code class="inline">ul</code> element. Therefore, we use an algorithm which recursively compares element tags at each level of the tree and throws away subtrees whose root tags don‚Äôt match.</p><h3 id="implementation">Implementation</h3><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>@@ <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">10</span> <span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">20</span> @@ <span class="token keyword">function</span> <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>   <span class="token keyword">return</span> value <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> value <span class="token operator">:</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code><span class="token operator">+</span>  <span class="token keyword">return</span> arr<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token operator">?</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> arr<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code> <span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_node <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_children <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code><span class="token operator">+</span>    <span class="token comment">// flags</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code>@@ <span class="token operator">-</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">78</span> <span class="token operator">+</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">133</span> @@ <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code>   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">narrow</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">&quot;boolean&quot;</span> <span class="token operator">||</span> value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="29"><code><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="30"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> value <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="31"><code><span class="token operator">+</span>    <span class="token keyword">return</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="32"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="33"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="34"><code><span class="token operator">+</span>  <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="35"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="36"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="37"><code> <span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Renderer</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="38"><code><span class="token operator">+</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="39"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="40"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="41"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="42"><code>   <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">children<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="43"><code><span class="token operator">-</span>    <span class="token keyword">const</span> portal <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>Portal<span class="token punctuation">,</span> <span class="token punctuation">{</span>root<span class="token punctuation">}</span><span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="44"><code><span class="token operator">+</span>    <span class="token keyword">let</span> portal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="45"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>portal<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="46"><code><span class="token operator">+</span>      portal<span class="token punctuation">.</span>props <span class="token operator">=</span> <span class="token punctuation">{</span>root<span class="token punctuation">,</span> children<span class="token punctuation">}</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="47"><code><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="48"><code><span class="token operator">+</span>      portal <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>Portal<span class="token punctuation">,</span> <span class="token punctuation">{</span>root<span class="token punctuation">,</span> children<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="49"><code><span class="token operator">+</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>_cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> portal<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="50"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="51"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="52"><code>     <span class="token keyword">return</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> portal<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="53"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="54"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="55"><code>   <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="56"><code>     <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="57"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="58"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="59"><code>   <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="60"><code>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="61"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">&quot;children&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="62"><code>         <span class="token keyword">continue</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="63"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="64"><code>         name <span class="token operator">=</span> <span class="token string">&quot;className&quot;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="65"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="66"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="67"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="68"><code>         node<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="69"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="70"><code>         node<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="71"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="72"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="73"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="74"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="75"><code>   <span class="token function">arrange</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> node<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="76"><code>     <span class="token keyword">let</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>firstChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="77"><code>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> newChild <span class="token keyword">of</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="78"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">===</span> newChild<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="79"><code>         child <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="80"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="81"><code>         <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> child<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> Node<span class="token punctuation">.</span><span class="token constant">TEXT_NODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="82"><code>           child<span class="token punctuation">.</span>nodeValue <span class="token operator">=</span> newChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="83"><code>           child <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="84"><code>         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="85"><code>           node<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="86"><code>         <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="87"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="88"><code>         node<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newChild<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="89"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="90"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="91"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="92"><code>     <span class="token keyword">while</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="93"><code>       <span class="token keyword">const</span> nextSibling <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="94"><code>       node<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="95"><code>       child <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="96"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="97"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="98"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="99"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="100"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="101"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="102"><code><span class="token operator">+</span>    oldChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="103"><code><span class="token operator">+</span>    newChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="104"><code><span class="token operator">+</span>    oldChild<span class="token punctuation">.</span>tag <span class="token operator">===</span> newChild<span class="token punctuation">.</span>tag</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="105"><code><span class="token operator">+</span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="106"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChild <span class="token operator">!==</span> newChild<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="107"><code><span class="token operator">+</span>      oldChild<span class="token punctuation">.</span>props <span class="token operator">=</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="108"><code><span class="token operator">+</span>      newChild <span class="token operator">=</span> oldChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="109"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="110"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="111"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="112"><code><span class="token operator">+</span>  <span class="token keyword">let</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="113"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="114"><code><span class="token operator">+</span>    value <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="115"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="116"><code><span class="token operator">+</span>    value <span class="token operator">=</span> newChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="117"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="118"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="119"><code><span class="token operator">+</span>  <span class="token keyword">return</span> <span class="token punctuation">[</span>newChild<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="120"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="121"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="122"><code> <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="123"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="124"><code><span class="token operator">+</span>    el <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">...</span>el<span class="token punctuation">.</span>props<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="125"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="126"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="127"><code><span class="token operator">+</span>  <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="128"><code><span class="token operator">+</span>  <span class="token keyword">const</span> newChildren <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="129"><code><span class="token operator">+</span>  <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="130"><code>   <span class="token keyword">const</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="131"><code><span class="token operator">-</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> child <span class="token keyword">of</span> <span class="token function">wrap</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="132"><code><span class="token operator">-</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="133"><code><span class="token operator">-</span>      values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">update</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="134"><code><span class="token operator">-</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="135"><code><span class="token operator">-</span>      values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="136"><code><span class="token operator">+</span>  <span class="token keyword">const</span> length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">,</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="137"><code><span class="token operator">+</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="138"><code><span class="token operator">+</span>    <span class="token keyword">const</span> oldChild <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="139"><code><span class="token operator">+</span>    <span class="token keyword">const</span> newChild <span class="token operator">=</span> <span class="token function">narrow</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="140"><code><span class="token operator">+</span>    <span class="token keyword">const</span> <span class="token punctuation">[</span>child<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="141"><code><span class="token operator">+</span>    children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="142"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="143"><code><span class="token operator">+</span>      values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="144"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="145"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="146"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="147"><code><span class="token operator">+</span>  el<span class="token punctuation">.</span>_children <span class="token operator">=</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="148"><code>   <span class="token keyword">return</span> <span class="token function">commit</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="149"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="150"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="151"><code> <span class="token keyword">function</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="152"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> Portal<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="153"><code>     renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>root<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="154"><code>     <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="155"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>_node<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="156"><code><span class="token operator">+</span>    el<span class="token punctuation">.</span>_node <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="157"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="158"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="159"><code><span class="token operator">-</span>  <span class="token keyword">const</span> node <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="160"><code><span class="token operator">-</span>  renderer<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="161"><code><span class="token operator">-</span>  renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> node<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="162"><code><span class="token operator">-</span>  <span class="token keyword">return</span> node<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="163"><code><span class="token operator">+</span>  renderer<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="164"><code><span class="token operator">+</span>  renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="165"><code><span class="token operator">+</span>  <span class="token keyword">return</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="166"><code> <span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-19" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-19'] = {"code":"--- a\u002Fcrank.js\n+++ b\u002Fcrank.js\n@@ -2,10 +2,20 @@ function wrap(value) {\n   return value === undefined ? [] : Array.isArray(value) ? value : [value];\n }\n\n+function unwrap(arr) {\n+  return arr.length \u003C= 1 ? arr[0] : arr;\n+}\n+\n class Element {\n   constructor(tag, props) {\n     this.tag = tag;\n     this.props = props;\n+\n+    this._node = undefined;\n+    this._children = undefined;\n+\n+    \u002F\u002F flags\n+    this._isMounted = false;\n   }\n }\n\n@@ -22,78 +32,133 @@ export function createElement(tag, props, ...children) {\n   return new Element(tag, props);\n }\n\n+function narrow(value) {\n+  if (typeof value === \"boolean\" || value == null) {\n+    return undefined;\n+  } else if (typeof value === \"string\" || value instanceof Element) {\n+    return value;\n+  }\n+\n+  return value.toString();\n+}\n+\n export class Renderer {\n+  constructor() {\n+    this._cache = new WeakMap();\n+  }\n+\n   render(children, root) {\n-    const portal = createElement(Portal, {root}, children);\n+    let portal = this._cache.get(root);\n+    if (portal) {\n+      portal.props = {root, children};\n+    } else {\n+      portal = createElement(Portal, {root, children});\n+      this._cache.set(root, portal);\n+    }\n+\n     return update(this, portal);\n   }\n\n   create(el) {\n     return document.createElement(el.tag);\n   }\n\n   patch(el, node) {\n     for (let [name, value] of Object.entries(el.props)) {\n       if (name === \"children\") {\n         continue;\n       } else if (name === \"class\") {\n         name = \"className\";\n       }\n\n       if (name in node) {\n         node[name] = value;\n       } else {\n         node.setAttribute(name, value);\n       }\n     }\n   }\n\n   arrange(el, node, children) {\n     let child = node.firstChild;\n     for (const newChild of children) {\n       if (child === newChild) {\n         child = child.nextSibling;\n       } else if (typeof newChild === \"string\") {\n         if (child !== null && child.nodeType === Node.TEXT_NODE) {\n           child.nodeValue = newChild;\n           child = child.nextSibling;\n         } else {\n           node.insertBefore(document.createTextNode(newChild), child);\n         }\n       } else {\n         node.insertBefore(newChild, child);\n       }\n     }\n\n     while (child !== null) {\n       const nextSibling = child.nextSibling;\n       node.removeChild(child);\n       child = child.nextSibling;\n     }\n   }\n }\n\n+function diff(renderer, oldChild, newChild) {\n+  if (\n+    oldChild instanceof Element &&\n+    newChild instanceof Element &&\n+    oldChild.tag === newChild.tag\n+  ) {\n+    if (oldChild !== newChild) {\n+      oldChild.props = newChild.props;\n+      newChild = oldChild;\n+    }\n+  }\n+\n+  let value;\n+  if (newChild instanceof Element) {\n+    value = update(renderer, newChild);\n+  } else {\n+    value = newChild;\n+  }\n+\n+  return [newChild, value];\n+}\n+\n function update(renderer, el) {\n+  if (el._isMounted) {\n+    el = createElement(el, {...el.props});\n+  }\n+\n+  const oldChildren = wrap(el._children);\n+  const newChildren = wrap(el.props.children);\n+  const children = [];\n   const values = [];\n-  for (const child of wrap(el.props.children)) {\n-    if (child instanceof Element) {\n-      values.push(update(renderer, child));\n-    } else if (child) {\n-      values.push(child);\n+  const length = Math.max(oldChildren.length, newChildren.length);\n+  for (let i = 0; i \u003C length; i++) {\n+    const oldChild = oldChildren[i];\n+    const newChild = narrow(newChildren[i]);\n+    const [child, value] = diff(renderer, oldChild, newChild);\n+    children.push(child);\n+    if (value) {\n+      values.push(value);\n     }\n   }\n\n+  el._children = unwrap(children);\n   return commit(renderer, el, values);\n }\n\n function commit(renderer, el, values) {\n   if (el.tag === Portal) {\n     renderer.arrange(el, el.props.root, values);\n     return undefined;\n+  } else if (!el._node) {\n+    el._node = renderer.create(el);\n   }\n\n-  const node = renderer.create(el);\n-  renderer.patch(el, node);\n-  renderer.arrange(el, node, values);\n-  return node;\n+  renderer.patch(el, el._node);\n+  renderer.arrange(el, el._node, values);\n+  return el._node;\n }","lang":"diff"};
		</script></div><p><a href="https://github.com/brainkim/crank-from-scratch/commit/c5299409736081d37a66de9a91b1db0e2883bc46">Diff</a> <a href="https://github.com/brainkim/crank-from-scratch/blob/c5299409736081d37a66de9a91b1db0e2883bc46/crank.js">File</a></p><p>To diff old and new trees, we need to retain old elements and DOM nodes so that we can make comparisons. At the renderer level, we use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakMap">a weakmap</a> to store the <code class="inline">Portal</code> elements we created in <code class="inline">render()</code> by the DOM node which we rendered into. At the element level, we store an element‚Äôs previously rendered children directly on the element under its <code class="inline">_children</code> property, and an element‚Äôs previously created DOM node under its <code class="inline">_node</code> property. We use leading underscores to indicate that these properties should be private to the module.</p><p>The <code class="inline">diff()</code> function compares old and new children by position, and if elements appear in the same position with the same tag, we simply copy the new element‚Äôs props over to the old element. Finally, in the <code class="inline">commit()</code> function, we check to see if an element has a DOM node defined on it before creating new ones.</p><p><strong>Notes:</strong></p><ol><li><p>Element trees can contain almost any value: <code class="inline">true</code>, <code class="inline">false</code>, <code class="inline">null</code> and <code class="inline">undefined</code> are erased, while numbers and non-element objects are converted to strings.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">const</span> el <span class="token operator">=</span> <span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token keyword">undefined</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [&quot;a&quot;, 2, true, false, null, undefined]</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;div&gt;a2&lt;/div&gt;</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-20" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-20'] = {"code":"const el = (\n  \u003Cdiv\u003E{\"a\"}{1 + 1}{true}{false}{null}{undefined}\u003C\u002Fdiv\u003E\n);\n\nconsole.log(el.props.children); \u002F\u002F [\"a\", 2, true, false, null, undefined]\nrenderer.render(app);\nconsole.log(app.innerHTML); \u002F\u002F \u003Cdiv\u003Ea2\u003C\u002Fdiv\u003E","lang":"jsx"};
		</script></div><p>Therefore, we use the helper function <code class="inline">narrow()</code> to reduce the members of element trees to elements, strings, and <code class="inline">undefined</code>. This greatly simplifies the number of cases we need to handle when diffing.</p></li><li><p>You might think mutating virtual elements directly is a little suspicious, as opposed to having some sort of separate internal node data structure. The fact is, most virtual elements which are created are thrown away every render, so retaining and mutating them is both more efficient and easier to implement, especially because any internal node type would have many of the same properties as elements anyways. Additionally, we can use a boolean flag (<code class="inline">_isMounted</code>) to defensively clone elements if we ever detect that they‚Äôre being reused.</p></li></ol><h2 id="step-3-function-components">Step 3: Function Components</h2><p>The renderer can now efficiently create and mutate DOM nodes. However, we currently have to call the <code class="inline">render()</code> method with a full tree which looks more or less exactly like the HTML we want to render. The feature which makes JSX shine is that we can use the same syntax and diffing algorithm to encapsulate parts of the tree as <em>components.</em> To do this in Crank, we make the tags of elements reference a <em>function</em> rather than a string, and call that function with the element‚Äôs props when walking the element tree.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">function</span> <span class="token function">Greeting</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>color<span class="token punctuation">,</span> children<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">return</span> <span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>      Hello <span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">color: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>color<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>  <span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Greeting color<span class="token operator">=</span><span class="token string">&quot;red&quot;</span><span class="token operator">&gt;</span>World<span class="token operator">&lt;</span><span class="token operator">/</span>Greeting<span class="token operator">&gt;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-21" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-21'] = {"code":"function Greeting({color, children}) {\n  return (\n    \u003Cdiv\u003E\n      Hello \u003Cspan style={`color: ${color};`}\u003E{children}\u003C\u002Fspan\u003E\n    \u003C\u002Fdiv\u003E\n  );\n}\n\nrenderer.render(\u003CGreeting color=\"red\"\u003EWorld\u003C\u002FGreeting\u003E, app);","lang":"jsx"};
		</script></div><p>We use PascalCase when defining components because JSX transpilation is determined by the casing of the first letter of the tag: upper-case means the tag is an identifier in the current scope, and lower-case means the tag is a string.</p><h3 id="implementation">Implementation</h3><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>@@ <span class="token operator">-</span><span class="token number">129</span><span class="token punctuation">,</span><span class="token number">36</span> <span class="token operator">+</span><span class="token number">129</span><span class="token punctuation">,</span><span class="token number">45</span> @@ <span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code> <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>     el <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">...</span>el<span class="token punctuation">.</span>props<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>   <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code><span class="token operator">-</span>  <span class="token keyword">const</span> newChildren <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code><span class="token operator">+</span>  <span class="token keyword">let</span> newChildren<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token operator">+</span>    newChildren <span class="token operator">=</span> el<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code><span class="token operator">+</span>    newChildren <span class="token operator">=</span> el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code><span class="token operator">+</span>  newChildren <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code>   <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code>   <span class="token keyword">const</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code>   <span class="token keyword">const</span> length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">,</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code>     <span class="token keyword">const</span> oldChild <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code>     <span class="token keyword">const</span> newChild <span class="token operator">=</span> <span class="token function">narrow</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code>     <span class="token keyword">const</span> <span class="token punctuation">[</span>child<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><code>     children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><code>       values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="29"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="30"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="31"><code>   el<span class="token punctuation">.</span>_children <span class="token operator">=</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="32"><code>   <span class="token keyword">return</span> <span class="token function">commit</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="33"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="34"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="35"><code> <span class="token keyword">function</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="36"><code><span class="token operator">-</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> Portal<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="37"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="38"><code><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="39"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> Portal<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="40"><code>     renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>root<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="41"><code>     <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="42"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>_node<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="43"><code>     el<span class="token punctuation">.</span>_node <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="44"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="45"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="46"><code>   renderer<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="47"><code>   renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="48"><code>   <span class="token keyword">return</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="49"><code> <span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-22" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-22'] = {"code":"--- a\u002Fcrank.js\n+++ b\u002Fcrank.js\n@@ -129,36 +129,45 @@ function diff(renderer, oldChild, newChild) {\n function update(renderer, el) {\n   if (el._isMounted) {\n     el = createElement(el, {...el.props});\n   }\n\n   const oldChildren = wrap(el._children);\n-  const newChildren = wrap(el.props.children);\n+  let newChildren;\n+  if (typeof el.tag === \"function\") {\n+    newChildren = el.tag(el.props);\n+  } else {\n+    newChildren = el.props.children;\n+  }\n+\n+  newChildren = wrap(newChildren);\n   const children = [];\n   const values = [];\n   const length = Math.max(oldChildren.length, newChildren.length);\n   for (let i = 0; i \u003C length; i++) {\n     const oldChild = oldChildren[i];\n     const newChild = narrow(newChildren[i]);\n     const [child, value] = diff(renderer, oldChild, newChild);\n     children.push(child);\n     if (value) {\n       values.push(value);\n     }\n   }\n\n   el._children = unwrap(children);\n   return commit(renderer, el, values);\n }\n\n function commit(renderer, el, values) {\n-  if (el.tag === Portal) {\n+  if (typeof el.tag === \"function\") {\n+    return unwrap(values);\n+  } else if (el.tag === Portal) {\n     renderer.arrange(el, el.props.root, values);\n     return undefined;\n   } else if (!el._node) {\n     el._node = renderer.create(el);\n   }\n\n   renderer.patch(el, el._node);\n   renderer.arrange(el, el._node, values);\n   return el._node;\n }","lang":"diff"};
		</script></div><p><a href="https://github.com/brainkim/crank-from-scratch/commit/af10d458baf4f504eff9a0b821e05c4b5cebe2fd">Diff</a> <a href="https://github.com/brainkim/crank-from-scratch/blob/af10d458baf4f504eff9a0b821e05c4b5cebe2fd/crank.js">File</a></p><p>As you can see, implementing function components is relatively easy; when encountering tags which are functions, rather than recursing over the element‚Äôs <code class="inline">children</code> prop, we invoke the function with the element‚Äôs props and use the return value as the element‚Äôs children instead. This is why we will often refer to the return value of a function component as the component element‚Äôs ‚Äúchildren.‚Äù As an additional note on terminology, we can now distinguish elements based on the type of their tag: we refer to elements with function tags as <em>component elements</em>, while we refer to elements which correspond to DOM nodes as <em>host elements</em>.</p><p>Using functions as tags meshes nicely with the element diffing algorithm, insofar as different functions are likely to produce different child structures.</p><h2 id="step-4-iterables-and-fragments">Step 4: Iterables and Fragments</h2><p>Here, we‚Äôll take a slight detour in our implementation of components to handle iterables in the element tree. Crank allows any collection which implements the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols">iterable interface</a> to be rendered as well. To review, an <em>iterable</em> is any JavaScript object which implements a <code class="inline">[Symbol.iterator]()</code> method. This includes arrays, sets, and any other data structure which you can iterate over using a <code class="inline">for‚Ä¶of</code> statement.</p><p>Currently, our module converts these data structures to strings using their <code class="inline">toString</code> method, but what we really want is to diff and render their contents recursively.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token keyword">const</span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span>arr<span class="token punctuation">}</span> <span class="token punctuation">{</span>set<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>  app<span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code><span class="token comment">// Expected: &quot;&lt;div&gt;123 abc&lt;/div&gt;&quot;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code><span class="token comment">// Actual: &quot;&lt;div&gt;1,2,3 [object Set]&lt;/div&gt;&quot;</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-23" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-23'] = {"code":"const arr = [1, 2, 3];\nconst set = new Set([\"a\", \"b\", \"c\"]);\nrenderer.render(\n  \u003Cdiv\u003E{arr} {set}\u003C\u002Fdiv\u003E,\n  app,\n);\n\nconsole.log(app.innerHTML);\n\u002F\u002F Expected: \"\u003Cdiv\u003E123 abc\u003C\u002Fdiv\u003E\"\n\u002F\u002F Actual: \"\u003Cdiv\u003E1,2,3 [object Set]\u003C\u002Fdiv\u003E\"","lang":"jsx"};
		</script></div><p>Iterables can appear anywhere in the element tree: as the child of a host element, as the return value of a component, or even nested in another iterable. Therefore, the easiest way to implement this feature is to treat every iterable we find in the element tree as though it were an element itself. To achieve this, we define a special element tag <code class="inline">Fragment</code>, and whenever we find an iterable, we wrap it in a <code class="inline">Fragment</code> element using a <code class="inline">createElement</code> call, with the iterable as the element‚Äôs children.</p><p>One added benefit of this approach is that we can use the <code class="inline">Fragment</code> tag directly, by referencing the tag like a component, or by using JSX‚Äôs special fragment syntax (<code class="inline">&lt;&gt;{children}&lt;/&gt;</code>) with the proper transpiler configuation.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token comment">// explicit reference</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token operator">&lt;</span>Fragment<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>  <span class="token operator">&lt;</span><span class="token operator">/</span>Fragment<span class="token operator">&gt;</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>  app<span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;&lt;div&gt;1&lt;/div&gt;&lt;div&gt;2&lt;/div&gt;&quot;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code><span class="token comment">// JSX fragment syntax</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>  <span class="token operator">&lt;</span><span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code>    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code>  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code>  app<span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;&lt;div&gt;1&lt;/div&gt;&lt;div&gt;2&lt;/div&gt;&quot;</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-24" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-24'] = {"code":"\u002F\u002F explicit reference\nrenderer.render(\n  \u003CFragment\u003E\n    \u003Cdiv\u003E1\u003C\u002Fdiv\u003E\n    \u003Cdiv\u003E2\u003C\u002Fdiv\u003E\n  \u003C\u002FFragment\u003E,\n  app,\n);\nconsole.log(document.body.innerHTML); \u002F\u002F \"\u003Cdiv\u003E1\u003C\u002Fdiv\u003E\u003Cdiv\u003E2\u003C\u002Fdiv\u003E\"\n\n\u002F\u002F JSX fragment syntax\nrenderer.render(\n  \u003C\u003E\n    \u003Cdiv\u003E1\u003C\u002Fdiv\u003E\n    \u003Cdiv\u003E2\u003C\u002Fdiv\u003E\n  \u003C\u002F\u003E,\n  app,\n);\n\nconsole.log(document.body.innerHTML); \u002F\u002F \"\u003Cdiv\u003E1\u003C\u002Fdiv\u003E\u003Cdiv\u003E2\u003C\u002Fdiv\u003E\"","lang":"jsx"};
		</script></div><h3 id="implementation">Implementation</h3><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>@@ <span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">14</span> @@ <span class="token keyword">function</span> <span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>   <span class="token keyword">return</span> arr<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token operator">?</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> arr<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">arrayify</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code><span class="token operator">+</span>  <span class="token keyword">return</span> value <span class="token operator">==</span> <span class="token keyword">null</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code><span class="token operator">+</span>    <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code><span class="token operator">+</span>    <span class="token operator">:</span> <span class="token keyword">typeof</span> value <span class="token operator">!==</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code><span class="token operator">+</span>    <span class="token operator">?</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code><span class="token operator">+</span>    <span class="token operator">:</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code> <span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code>@@ <span class="token operator">-</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">8</span> @@ <span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code> <span class="token keyword">export</span> <span class="token keyword">const</span> Portal <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;crank.Portal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code><span class="token operator">+</span><span class="token keyword">export</span> <span class="token keyword">const</span> Fragment <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code> <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code>   props <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><code>@@ <span class="token operator">-</span><span class="token number">35</span><span class="token punctuation">,</span><span class="token number">13</span> <span class="token operator">+</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">55</span> @@ <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><code> <span class="token keyword">function</span> <span class="token function">narrow</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">&quot;boolean&quot;</span> <span class="token operator">||</span> value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="29"><code>     <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="30"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> value <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="31"><code>     <span class="token keyword">return</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="32"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="33"><code><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token function">createElement</span><span class="token punctuation">(</span>Fragment<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="34"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="35"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="36"><code>   <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="37"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="38"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="39"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token parameter">values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="40"><code><span class="token operator">+</span>  <span class="token keyword">const</span> values1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="41"><code><span class="token operator">+</span>  <span class="token keyword">let</span> buffer<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="42"><code><span class="token operator">+</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> value <span class="token keyword">of</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="43"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="44"><code><span class="token operator">+</span>      <span class="token comment">// pass</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="45"><code><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="46"><code><span class="token operator">+</span>      buffer <span class="token operator">=</span> <span class="token punctuation">(</span>buffer <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="47"><code><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="48"><code><span class="token operator">+</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="49"><code><span class="token operator">+</span>        values1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="50"><code><span class="token operator">+</span>        buffer <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="51"><code><span class="token operator">+</span>      <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="52"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="53"><code><span class="token operator">+</span>      values1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="54"><code><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="55"><code><span class="token operator">+</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> value1 <span class="token keyword">of</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="56"><code><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>value1<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="57"><code><span class="token operator">+</span>          <span class="token comment">// pass</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="58"><code><span class="token operator">+</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value1 <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="59"><code><span class="token operator">+</span>          buffer <span class="token operator">=</span> <span class="token punctuation">(</span>buffer <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> value1<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="60"><code><span class="token operator">+</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="61"><code><span class="token operator">+</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="62"><code><span class="token operator">+</span>            values1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="63"><code><span class="token operator">+</span>            buffer <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="64"><code><span class="token operator">+</span>          <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="65"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="66"><code><span class="token operator">+</span>          values1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value1<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="67"><code><span class="token operator">+</span>        <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="68"><code><span class="token operator">+</span>      <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="69"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="70"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="71"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="72"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="73"><code><span class="token operator">+</span>    values1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="74"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="75"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="76"><code><span class="token operator">+</span>  <span class="token keyword">return</span> values1<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="77"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="78"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="79"><code> <span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Renderer</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="80"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="81"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="82"><code>@@ <span class="token operator">-</span><span class="token number">129</span><span class="token punctuation">,</span><span class="token number">45</span> <span class="token operator">+</span><span class="token number">181</span><span class="token punctuation">,</span><span class="token number">45</span> @@ <span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="83"><code> <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="84"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="85"><code>     el <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">...</span>el<span class="token punctuation">.</span>props<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="86"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="87"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="88"><code>   <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="89"><code>   <span class="token keyword">let</span> newChildren<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="90"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="91"><code>     newChildren <span class="token operator">=</span> el<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="92"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="93"><code>     newChildren <span class="token operator">=</span> el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="94"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="95"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="96"><code><span class="token operator">-</span>  newChildren <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="97"><code><span class="token operator">+</span>  newChildren <span class="token operator">=</span> <span class="token function">arrayify</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="98"><code>   <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="99"><code>   <span class="token keyword">const</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="100"><code>   <span class="token keyword">const</span> length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">,</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="101"><code>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="102"><code>     <span class="token keyword">const</span> oldChild <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="103"><code><span class="token operator">-</span>    <span class="token keyword">const</span> newChild <span class="token operator">=</span> <span class="token function">narrow</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="104"><code><span class="token operator">+</span>    <span class="token keyword">let</span> newChild <span class="token operator">=</span> <span class="token function">narrow</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="105"><code>     <span class="token keyword">const</span> <span class="token punctuation">[</span>child<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="106"><code>     children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="107"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="108"><code>       values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="109"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="110"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="111"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="112"><code>   el<span class="token punctuation">.</span>_children <span class="token operator">=</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="113"><code><span class="token operator">-</span>  <span class="token keyword">return</span> <span class="token function">commit</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="114"><code><span class="token operator">+</span>  <span class="token keyword">return</span> <span class="token function">commit</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> <span class="token function">normalize</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="115"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="116"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="117"><code> <span class="token keyword">function</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="118"><code><span class="token operator">-</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="119"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">||</span> el<span class="token punctuation">.</span>tag <span class="token operator">===</span> Fragment<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="120"><code>     <span class="token keyword">return</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="121"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> Portal<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="122"><code>     renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>root<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="123"><code>     <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="124"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>_node<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="125"><code>     el<span class="token punctuation">.</span>_node <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="126"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="127"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="128"><code>   renderer<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="129"><code>   renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="130"><code>   <span class="token keyword">return</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="131"><code> <span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-25" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-25'] = {"code":"--- a\u002Fcrank.js\n+++ b\u002Fcrank.js\n@@ -6,6 +6,14 @@ function unwrap(arr) {\n   return arr.length \u003C= 1 ? arr[0] : arr;\n }\n\n+function arrayify(value) {\n+  return value == null\n+    ? []\n+    : typeof value !== \"string\" && typeof value[Symbol.iterator] === \"function\"\n+    ? Array.from(value)\n+    : [value];\n+}\n+\n class Element {\n   constructor(tag, props) {\n     this.tag = tag;\n@@ -21,6 +29,8 @@ class Element {\n\n export const Portal = Symbol.for(\"crank.Portal\");\n\n+export const Fragment = \"\";\n+\n export function createElement(tag, props, ...children) {\n   props = Object.assign({}, props);\n   if (children.length === 1) {\n@@ -35,13 +45,55 @@ export function createElement(tag, props, ...children) {\n function narrow(value) {\n   if (typeof value === \"boolean\" || value == null) {\n     return undefined;\n   } else if (typeof value === \"string\" || value instanceof Element) {\n     return value;\n+  } else if (typeof value[Symbol.iterator] === \"function\") {\n+    return createElement(Fragment, null, value);\n   }\n\n   return value.toString();\n }\n\n+function normalize(values) {\n+  const values1 = [];\n+  let buffer;\n+  for (const value of values) {\n+    if (!value) {\n+      \u002F\u002F pass\n+    } else if (typeof value === \"string\") {\n+      buffer = (buffer || \"\") + value;\n+    } else if (!Array.isArray(value)) {\n+      if (buffer) {\n+        values1.push(buffer);\n+        buffer = undefined;\n+      }\n+\n+      values1.push(value);\n+    } else {\n+      for (const value1 of value) {\n+        if (!value1) {\n+          \u002F\u002F pass\n+        } else if (typeof value1 === \"string\") {\n+          buffer = (buffer || \"\") + value1;\n+        } else {\n+          if (buffer) {\n+            values1.push(buffer);\n+            buffer = undefined;\n+          }\n+\n+          values1.push(value1);\n+        }\n+      }\n+    }\n+  }\n+\n+  if (buffer) {\n+    values1.push(buffer);\n+  }\n+\n+  return values1;\n+}\n+\n export class Renderer {\n   constructor() {\n     this._cache = new WeakMap();\n@@ -129,45 +181,45 @@ function diff(renderer, oldChild, newChild) {\n function update(renderer, el) {\n   if (el._isMounted) {\n     el = createElement(el, {...el.props});\n   }\n\n   const oldChildren = wrap(el._children);\n   let newChildren;\n   if (typeof el.tag === \"function\") {\n     newChildren = el.tag(el.props);\n   } else {\n     newChildren = el.props.children;\n   }\n\n-  newChildren = wrap(newChildren);\n+  newChildren = arrayify(newChildren);\n   const children = [];\n   const values = [];\n   const length = Math.max(oldChildren.length, newChildren.length);\n   for (let i = 0; i \u003C length; i++) {\n     const oldChild = oldChildren[i];\n-    const newChild = narrow(newChildren[i]);\n+    let newChild = narrow(newChildren[i]);\n     const [child, value] = diff(renderer, oldChild, newChild);\n     children.push(child);\n     if (value) {\n       values.push(value);\n     }\n   }\n\n   el._children = unwrap(children);\n-  return commit(renderer, el, values);\n+  return commit(renderer, el, normalize(values));\n }\n\n function commit(renderer, el, values) {\n-  if (typeof el.tag === \"function\") {\n+  if (typeof el.tag === \"function\" || el.tag === Fragment) {\n     return unwrap(values);\n   } else if (el.tag === Portal) {\n     renderer.arrange(el, el.props.root, values);\n     return undefined;\n   } else if (!el._node) {\n     el._node = renderer.create(el);\n   }\n\n   renderer.patch(el, el._node);\n   renderer.arrange(el, el._node, values);\n   return el._node;\n }","lang":"diff"};
		</script></div><p><a href="https://github.com/brainkim/crank-from-scratch/commit/90091832ee9558d3eec5f8bbee566c55e82b3e41">Diff</a> <a href="https://github.com/brainkim/crank-from-scratch/blob/90091832ee9558d3eec5f8bbee566c55e82b3e41/crank.js">File</a></p><p>To implement fragments, we adjust the <code class="inline">narrow</code> function so that any time a non-string iterable is detected we wrap it in a <code class="inline">createElement</code> call. We need to be careful to exclude strings from our iterable detection logic. Strings are iterable but we don‚Äôt want to iterate over them because we would end up diffing each string found in the element tree character by character, which would be inefficient.</p><p><strong>Notes:</strong></p><ol><li>We define the helper function <code class="inline">normalize()</code>, which is similar to the DOM‚Äôs <a href="https://developer.mozilla.org/en-US/docs/Web/API/Node/normalize"><code class="inline">Node.prototype.normalize()</code></a> method. It is called on the <code class="inline">values</code> array in the <code class="inline">update()</code> function, and will shallowly flatten the array, as well as concatenate adjacent strings and remove any <code class="inline">undefined</code> values. This is what allows arrays of values to be returned from the <code class="inline">update()</code> and <code class="inline">commit()</code> functions, as would happen in the case of <code class="inline">Fragment</code> elements. We only need to flatten the array shallowly because <code class="inline">normalize()</code> is called at each level of the element tree.</li><li>We also define another helper function <code class="inline">arrayify()</code>, which basically does the same thing as <code class="inline">wrap()</code> but handles iterables.</li><li>In Crank, the <code class="inline">Fragment</code> tag is actually just the empty string. I believe that every JSX framework/library could make their <code class="inline">Fragment</code> equivalent the empty string without any major changes to their codebase or API. The empty string makes the most sense as the default for JSX fragment syntax, and adopting this convention would lessen configuration overhead for developers.</li></ol><h2 id="step-5-generator-components">Step 5: Generator Components</h2><p>We now have basic rendering and components, but components need to do more than just group parts of the element tree; nowadays, we expect any component abstraction to be able to encapsulate state, so that we can write components which respond to user input or timers, for instance.</p><p>In Crank, we use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function*">generator functions</a> to write stateful components. As a quick review, generator functions are a separate function syntax which adds a star after the <code class="inline">function</code> keyword (<code class="inline">function *</code>). Inside a generator function, you can not only <em>return</em> values but also <em>yield</em> values as well using the <code class="inline">yield</code> operator.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">let</span> current <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> next <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>    <span class="token keyword">yield</span> current<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>    <span class="token punctuation">[</span>current<span class="token punctuation">,</span> next<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>next<span class="token punctuation">,</span> current <span class="token operator">+</span> next<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code><span class="token keyword">const</span> iter <span class="token operator">=</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code><span class="token comment">// Nothing happens yet because we haven‚Äôt used the iterator.</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> n <span class="token keyword">of</span> iter<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>    <span class="token keyword">break</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code>  arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [0, 1, 1, 2, 3, 5, 8, 13, 21]</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-26" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-26'] = {"code":"function *fibonacci() {\n  let current = 0, next = 1;\n  while (true) {\n    yield current;\n    [current, next] = [next, current + next];\n  }\n}\n\nconst iter = fib();\n\u002F\u002F Nothing happens yet because we haven‚Äôt used the iterator.\nconst arr = [];\nfor (const n of iter) {\n  if (n \u003E 30) {\n    break;\n  }\n  arr.push(n);\n}\n\nconsole.log(arr); \u002F\u002F [0, 1, 1, 2, 3, 5, 8, 13, 21]","lang":"js"};
		</script></div><p>This example, which defines and calls a <a href="https://en.wikipedia.org/wiki/Fibonacci_number">fibonacci number</a> generator function, demonstrates some important qualities of generator functions.</p><ol><li><p><strong>Generator functions execute lazily.</strong> Calling a generator function does not execute its body; rather, it returns a <em>generator object</em>. Until this object is somehow used, the generator function does not run.</p></li><li><p><strong>Generator functions can model infinite sequences.</strong> If we didn‚Äôt include the <code class="inline">break</code> statement in the loop over the generator object, this program would never terminate because the <code class="inline">fibonacci()</code> function never returns.</p></li><li><p><strong>Generator functions can hold internal state.</strong> The <code class="inline">current</code> and <code class="inline">next</code> variables are local to the generator function‚Äôs scope, and are preserved between iterations.</p></li></ol><p>Crank takes advantage of all three of these features by allowing components to be written as generator functions which <em>yield</em> element trees. By retaining generator objects just like we retained DOM nodes and children, we can preserve the local scope of the generator for component elements.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>    <span class="token keyword">yield</span> <span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Rendered <span class="token punctuation">{</span>i<span class="token operator">++</span><span class="token punctuation">}</span> <span class="token function">time</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>    <span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Counter <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Counter <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Counter <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;div&gt;Rendered 2 time(s)&lt;/div&gt;</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-27" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-27'] = {"code":"function *Counter() {\n  let i = 0;\n  while (true) {\n    yield (\n      \u003Cdiv\u003ERendered {i++} time(s)\u003C\u002Fdiv\u003E\n    );\n  }\n}\n\nrenderer.render(\u003CCounter \u002F\u003E, app);\nrenderer.render(\u003CCounter \u002F\u003E, app);\nrenderer.render(\u003CCounter \u002F\u003E, app);\nconsole.log(app.innerHTML); \u002F\u002F \u003Cdiv\u003ERendered 2 time(s)\u003C\u002Fdiv\u003E","lang":"jsx"};
		</script></div><h3 id="iterables-vs-iterators">Iterables vs Iterators</h3><p>Before we dive into the code, we need to make a distinction between <em>iterables</em> and <em>iterators.</em> As explained previously, an iterable is any object which implements the <code class="inline">[Symbol.iterator]()</code> method. On the other hand, an <em>iterator</em> is any object which implements a <code class="inline">next()</code> method, and optionally <code class="inline">return()</code> and <code class="inline">throw()</code> methods. To conform to the iterator interface, these methods must return <em>iterations</em>, objects which have <code class="inline">value</code> and <code class="inline">done</code> properties, with <code class="inline">done</code> being a boolean which indicates whether the iterator has <em>returned</em>.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">const</span> iter <span class="token operator">=</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {value: 0, done: false}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {value: 1, done: false}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {value: 1, done: false}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {value: 2, done: false}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-28" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-28'] = {"code":"const iter = fibonacci();\nconsole.log(iter.next()); \u002F\u002F {value: 0, done: false}\nconsole.log(iter.next()); \u002F\u002F {value: 1, done: false}\nconsole.log(iter.next()); \u002F\u002F {value: 1, done: false}\nconsole.log(iter.next()); \u002F\u002F {value: 2, done: false}","lang":"js"};
		</script></div><p>Iterables and iterators are related in that the <code class="inline">[Symbol.iterator]()</code> method must return an iterator. This means that you can trivially make any iterator <em>iterable</em> by adding a <code class="inline">[Symbol.iterator]()</code> method to it which returns <code class="inline">this</code>. The <code class="inline">for‚Ä¶of</code> statement uses the <code class="inline">[Symbol.iterator]()</code> method under the hood, so the following two code snippets are roughly equivalent.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> n <span class="token keyword">of</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>    <span class="token keyword">break</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code><span class="token comment">// is roughly equivalent to:</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code><span class="token keyword">const</span> iterator <span class="token operator">=</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code><span class="token keyword">let</span> iteration <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token keyword">try</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>iteration<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code>    <span class="token keyword">const</span> n <span class="token operator">=</span> iteration<span class="token punctuation">.</span>value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code>    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code>      <span class="token keyword">break</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code><span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>iteration<span class="token punctuation">.</span>done <span class="token operator">&amp;&amp;</span> iterator<span class="token punctuation">.</span>return<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code>    iterator<span class="token punctuation">.</span><span class="token function">return</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-29" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-29'] = {"code":"for (const n of fibonacci()) {\n  if (n \u003E 30) {\n    break;\n  }\n\n  console.log(n);\n}\n\n\u002F\u002F is roughly equivalent to:\n\nconst iterator = fibonacci()[Symbol.iterator]();\nlet iteration = iterator.next();\ntry {\n  while (!iteration.done) {\n    const n = iteration.value;\n    if (n \u003E 30) {\n      break;\n    }\n    console.log(n);\n  }\n} finally {\n  if (!iteration.done && iterator.return) {\n    iterator.return();\n  }\n}","lang":"js"};
		</script></div><p>Generator objects implement both the iterable and iterator interfaces; in other words, generator objects are <em>iterable iterators.</em> This means you can both use generator objects in <code class="inline">for‚Ä¶of</code> loops, and also call the iterator methods directly. We‚Äôll do the latter, because this approach is more flexible.</p><h3 id="implementation">Implementation</h3><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>@@ <span class="token operator">-</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span> <span class="token operator">+</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">20</span> @@ <span class="token keyword">function</span> <span class="token function">arrayify</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>     <span class="token operator">:</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">isIteratorLike</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code><span class="token operator">+</span>  <span class="token keyword">return</span> value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value<span class="token punctuation">.</span>next <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code> <span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_node <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_children <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_ctx <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code>     <span class="token comment">// flags</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code>@@ <span class="token operator">-</span><span class="token number">181</span><span class="token punctuation">,</span><span class="token number">30</span> <span class="token operator">+</span><span class="token number">186</span><span class="token punctuation">,</span><span class="token number">35</span> @@ <span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code> <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><code>     el <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">...</span>el<span class="token punctuation">.</span>props<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="29"><code><span class="token operator">-</span>  <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="30"><code><span class="token operator">-</span>  <span class="token keyword">let</span> newChildren<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="31"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="32"><code><span class="token operator">-</span>    newChildren <span class="token operator">=</span> el<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="33"><code><span class="token operator">-</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="34"><code><span class="token operator">-</span>    newChildren <span class="token operator">=</span> el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="35"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>_ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="36"><code><span class="token operator">+</span>      el<span class="token punctuation">.</span>_ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="37"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="38"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="39"><code><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token function">updateCtx</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="40"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="41"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="42"><code><span class="token operator">+</span>  <span class="token keyword">return</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="43"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="44"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="45"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="46"><code><span class="token operator">+</span>  <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="47"><code>   newChildren <span class="token operator">=</span> <span class="token function">arrayify</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="48"><code>   <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="49"><code>   <span class="token keyword">const</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="50"><code>   <span class="token keyword">const</span> length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">,</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="51"><code>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="52"><code>     <span class="token keyword">const</span> oldChild <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="53"><code>     <span class="token keyword">let</span> newChild <span class="token operator">=</span> <span class="token function">narrow</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="54"><code>     <span class="token keyword">const</span> <span class="token punctuation">[</span>child<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="55"><code>     children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="56"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="57"><code>       values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="58"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="59"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="60"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="61"><code>   el<span class="token punctuation">.</span>_children <span class="token operator">=</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="62"><code>   <span class="token keyword">return</span> <span class="token function">commit</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> <span class="token function">normalize</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="63"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="64"><code>@@ <span class="token operator">-</span><span class="token number">223</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token operator">+</span><span class="token number">233</span><span class="token punctuation">,</span><span class="token number">29</span> @@ <span class="token keyword">function</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="65"><code>   renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="66"><code>   <span class="token keyword">return</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="67"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="68"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="69"><code><span class="token operator">+</span><span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="70"><code><span class="token operator">+</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="71"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_renderer <span class="token operator">=</span> renderer<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="72"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_el <span class="token operator">=</span> el<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="73"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_iter <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="74"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="75"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="76"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="77"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">updateCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="78"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="79"><code><span class="token operator">+</span>    <span class="token keyword">const</span> value <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="80"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIteratorLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="81"><code><span class="token operator">+</span>      ctx<span class="token punctuation">.</span>_iter <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="82"><code><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="83"><code><span class="token operator">+</span>      <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="84"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="85"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="86"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="87"><code><span class="token operator">+</span>  <span class="token keyword">const</span> iteration <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="88"><code><span class="token operator">+</span>  <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> iteration<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="89"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="90"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="91"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="92"><code><span class="token operator">+</span>  <span class="token keyword">return</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_renderer<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">,</span> <span class="token function">narrow</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="93"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-30" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-30'] = {"code":"--- a\u002Fcrank.js\n+++ b\u002Fcrank.js\n@@ -14,15 +14,20 @@ function arrayify(value) {\n     : [value];\n }\n\n+function isIteratorLike(value) {\n+  return value != null && typeof value.next === \"function\";\n+}\n+\n class Element {\n   constructor(tag, props) {\n     this.tag = tag;\n     this.props = props;\n\n     this._node = undefined;\n     this._children = undefined;\n+    this._ctx = undefined;\n\n     \u002F\u002F flags\n     this._isMounted = false;\n   }\n }\n@@ -181,30 +186,35 @@ function diff(renderer, oldChild, newChild) {\n function update(renderer, el) {\n   if (el._isMounted) {\n     el = createElement(el, {...el.props});\n   }\n\n-  const oldChildren = wrap(el._children);\n-  let newChildren;\n   if (typeof el.tag === \"function\") {\n-    newChildren = el.tag(el.props);\n-  } else {\n-    newChildren = el.props.children;\n+    if (!el._ctx) {\n+      el._ctx = new Context(renderer, el);\n+    }\n+\n+    return updateCtx(el._ctx);\n   }\n\n+  return updateChildren(renderer, el, el.props.children);\n+}\n+\n+function updateChildren(renderer, el, newChildren) {\n+  const oldChildren = wrap(el._children);\n   newChildren = arrayify(newChildren);\n   const children = [];\n   const values = [];\n   const length = Math.max(oldChildren.length, newChildren.length);\n   for (let i = 0; i \u003C length; i++) {\n     const oldChild = oldChildren[i];\n     let newChild = narrow(newChildren[i]);\n     const [child, value] = diff(renderer, oldChild, newChild);\n     children.push(child);\n     if (value) {\n       values.push(value);\n     }\n   }\n\n   el._children = unwrap(children);\n   return commit(renderer, el, normalize(values));\n }\n@@ -223,3 +233,29 @@ function commit(renderer, el, values) {\n   renderer.arrange(el, el._node, values);\n   return el._node;\n }\n+\n+class Context {\n+  constructor(renderer, el) {\n+    this._renderer = renderer;\n+    this._el = el;\n+    this._iter = undefined;\n+  }\n+}\n+\n+function updateCtx(ctx) {\n+  if (!ctx._iter) {\n+    const value = ctx._el.tag(ctx._el.props);\n+    if (isIteratorLike(value)) {\n+      ctx._iter = value;\n+    } else {\n+      return updateCtxChildren(ctx, value);\n+    }\n+  }\n+\n+  const iteration = ctx._iter.next();\n+  return updateCtxChildren(ctx, iteration.value);\n+}\n+\n+function updateCtxChildren(ctx, children) {\n+  return updateChildren(ctx._renderer, ctx._el, narrow(children));\n+}","lang":"diff"};
		</script></div><p><a href="https://github.com/brainkim/crank-from-scratch/commit/d89c229f2492817d26c6b96237bc5087c15bf5e9">Diff</a> <a href="https://github.com/brainkim/crank-from-scratch/blob/d89c229f2492817d26c6b96237bc5087c15bf5e9/crank.js">File</a></p><p>In this step, we‚Äôve encapsulated the execution of components in a helper class called the <code class="inline">Context</code>. This will be where we store all state which is required to execute component functions from now on. So far, we‚Äôve stored the renderer, the element, and any iterator returned by the component, directly on this context class.</p><p>We could also try to retain this state directly on component <em>elements</em>, but by storing them on contexts, we indirectly reduce the size of elements themselves. In a typical application, the number of host elements might exceed the number of component elements by 10:1, so it makes sense to put component-specific data in its own abstraction.</p><p>To detect generator components, we check that the return value of the component is ‚Äúiterator-like,‚Äù which just means that it is an object which defines a <code class="inline">next()</code> method. Although generators are both iterators and iterable, we check for the iterator interface, because, as explained previously, we interpret iterables as fragments wherever they appear in the element tree. If we determined any component which returns an <em>iterable</em> was also a generator component, we would get suprising behavior where the following component renders the strings <code class="inline">&quot;a&quot;</code>, <code class="inline">&quot;b&quot;</code> and <code class="inline">&quot;c&quot;</code> in successive renders, rather than all at once as siblings.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">function</span> <span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-31" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-31'] = {"code":"function Component() {\n  return [\"a\", \"b\", \"c\"];\n}","lang":"jsx"};
		</script></div><p>While there may be ways to distinguish generator functions from normal functions without calling them, doing so is an anti-pattern because it precludes components which return generator objects from being generator components. This theme of inspecting the return values of component functions to determine their type will continue as we implement more component types.</p><p><strong>Notes:</strong></p><ol><li>We divided the <code class="inline">update()</code> function into <code class="inline">update()</code> and <code class="inline">updateChildren()</code>, and created analogous functions <code class="inline">updateCtx()</code> and <code class="inline">updateCtxChildren()</code> for component contexts. These functions use the ‚Äúprivate method‚Äù pattern described previously. The <code class="inline">updateCtxChildren()</code> function is primarily used so that we can wrap yielded/returned children in a <code class="inline">narrow()</code> call for diffing purposes.</li></ol><h2 id="step-6-refreshing">Step 6: Refreshing</h2><p>We now have stateful components via generators, but these generator functions only rerender based on top-level <code class="inline">render()</code> calls. To write interactive components, we need a way for components to rerender themselves. In Crank, we pass in the context object we created in the previous step as the <code class="inline">this</code> value of component functions, and implement a <code class="inline">refresh()</code> method on it which re-executes the component. This allows us to write components like the following.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">const</span> <span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>    i<span class="token operator">++</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>  <span class="token punctuation">}</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>    <span class="token keyword">yield</span> <span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>      <span class="token operator">&lt;</span>button onclick<span class="token operator">=</span><span class="token punctuation">{</span>onclick<span class="token punctuation">}</span><span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>        Button pressed <span class="token punctuation">{</span>i<span class="token punctuation">}</span> <span class="token function">time</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>      <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>    <span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-32" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-32'] = {"code":"function *Counter() {\n  let i = 0;\n  const onclick = () =\u003E {\n    i++;\n    this.refresh();\n  };\n\n  while (true) {\n    yield (\n      \u003Cbutton onclick={onclick}\u003E\n        Button pressed {i} time(s).\n      \u003C\u002Fbutton\u003E\n    );\n  }\n}","lang":"jsx"};
		</script></div><p>We‚Äôve already implemented basic event handling thanks to the DOM‚Äôs <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Event_handlers"><code class="inline">onevent</code> handlers</a> and the logic in the renderer‚Äôs <code class="inline">patch()</code> method, so all we need to do is pass the context in as <code class="inline">this</code> using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/call"><code class="inline">Function.prototype.call</code></a> and implement the <code class="inline">refresh()</code> method on the context class.</p><h3 id="implementation">Implementation</h3><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>@@ <span class="token operator">-</span><span class="token number">237</span><span class="token punctuation">,</span><span class="token number">21</span> <span class="token operator">+</span><span class="token number">237</span><span class="token punctuation">,</span><span class="token number">25</span> @@ <span class="token keyword">function</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_renderer <span class="token operator">=</span> renderer<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_el <span class="token operator">=</span> el<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_iter <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code><span class="token operator">+</span>  <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token function">updateCtx</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code> <span class="token keyword">function</span> <span class="token function">updateCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code><span class="token operator">-</span>    <span class="token keyword">const</span> value <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code><span class="token operator">+</span>    <span class="token keyword">const</span> value <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIteratorLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code>       ctx<span class="token punctuation">.</span>_iter <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code>       <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><code>   <span class="token keyword">const</span> iteration <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><code>   <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> iteration<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><code> <span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-33" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-33'] = {"code":"--- a\u002Fcrank.js\n+++ b\u002Fcrank.js\n@@ -237,21 +237,25 @@ function commit(renderer, el, values) {\n class Context {\n   constructor(renderer, el) {\n     this._renderer = renderer;\n     this._el = el;\n     this._iter = undefined;\n   }\n+\n+  refresh() {\n+    return updateCtx(this);\n+  }\n }\n\n function updateCtx(ctx) {\n   if (!ctx._iter) {\n-    const value = ctx._el.tag(ctx._el.props);\n+    const value = ctx._el.tag.call(ctx, ctx._el.props);\n     if (isIteratorLike(value)) {\n       ctx._iter = value;\n     } else {\n       return updateCtxChildren(ctx, value);\n     }\n   }\n\n   const iteration = ctx._iter.next();\n   return updateCtxChildren(ctx, iteration.value);\n }","lang":"diff"};
		</script></div><p><a href="https://github.com/brainkim/crank-from-scratch/commit/cfd60c84ebd38549d3bbf4829c28c0e8f96847ec">Diff</a> <a href="https://github.com/brainkim/crank-from-scratch/blob/cfd60c84ebd38549d3bbf4829c28c0e8f96847ec/crank.js">File</a></p><p>After Crank‚Äôs release, multiple people objected to this unusual usage of <code class="inline">this</code>. As an alternative to using <code class="inline">this</code>, some suggested passing the context in directly as a parameter. There are many reasons why I think using <code class="inline">this</code> is the best choice for component API design, and I‚Äôll outline a few of them here.</p><ol><li><p><strong>Using <code class="inline">this</code> makes it harder for developers to call components directly.</strong> As we‚Äôve seen so far, components can either return children or an iterator which yields children. Because both these cases need to be handled, we need to take care to make sure that people don‚Äôt call components directly. Additionally, direct calls of components is an anti-pattern even if you know the component is a regular function which returns elements, because as we‚Äôve learned, we use the functions themselves to identify subtrees for our diffing algorithm. Passing contexts in as <code class="inline">this</code> is a natural barrier which prevents developers from attempting to call components directly, insofar as you would need to use the <code class="inline">Function.prototype.call()</code> method.</p></li><li><p><strong>Using <code class="inline">this</code> makes it harder for developers to destructure the context.</strong> If we passed the context in as a parameter, there would always be a chance for developers to destructure the context parameter just as they destructured props.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token comment">// Destructuring the proposed context parameter.</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">MyComponent</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>myProp<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>refresh<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token comment">/* ‚Ä¶ */</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>  <span class="token keyword">const</span> <span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>    <span class="token comment">/* ‚Ä¶ */</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>    <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>  <span class="token punctuation">}</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>  <span class="token comment">/* ‚Ä¶ */</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-34" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-34'] = {"code":"\u002F\u002F Destructuring the proposed context parameter.\nfunction *MyComponent({myProp}, {refresh}) {\n  \u002F* ‚Ä¶ *\u002F\n  const onclick = () =\u003E {\n    \u002F* ‚Ä¶ *\u002F\n    refresh();\n  };\n  \u002F* ‚Ä¶ *\u002F\n}","lang":"jsx"};
		</script></div><p>To make this example work, we would either need to eagerly bind the <code class="inline">refresh()</code> method to the context, or alternatively define the <code class="inline">refresh()</code> method as a function which references the context in a closure. In either case, we would need to create a unique <code class="inline">refresh()</code> function for every component instance, which would increase the memory requirements for each component. Even worse, this would have to be done for every single method we wanted to define on the context. Insofar as destructuring <code class="inline">this</code> would require an extra line of code, its usage again provides a natural barrier which prevents developers from destructuring contexts and inadvertently losing method receivers.</p></li><li><p><strong>Components are a special construct which are somewhere between a class and a function.</strong> While all components in Crank are defined with functions, we need a way to define ‚Äúinstance‚Äù methods and properties like <code class="inline">refresh()</code> and have them available within component declarations. I like to reference <a href="https://twitter.com/dan_abramov/status/1093694465917751298">this tweet thread</a> by React maintainer Dan Abramov, about components as an abstraction. He writes:</p><blockquote><p>React is traditionally described either in FP terms (pure functions) or in OOP terms (stateful classes). Both are only approximations ‚Ä¶ Why are these models insufficient to describe React? ‚ÄúPure function‚Äù model doesn‚Äôt describe local state which is an essential React feature. ‚ÄúClass‚Äù model doesn‚Äôt explain pure-ish render, disawoving inheritance, lack of direct instantiation, and ‚Äúreceiving‚Äù props ‚Ä¶</p><p>What is a component? ‚Ä¶ It‚Äôs a thing of its own. A stateful function with effects. Your language just doesn‚Äôt have a primitive to express it.</p></blockquote><p>Abramov goes on to use this observation to justify React hooks, whereas of course, I would use the same line of reasoning to justify the usage of generator functions. Nevertheless, I think the observations he makes are valid, and that neither functions nor classes alone fully capture what we want from a component abstraction.</p><p>Calling component functions with <code class="inline">this</code> set to a framework-provided context object is a great way to model this half-function, half-class quality of components. It provides both the convenience of inheritance and the terseness of function declarations, and captures the uniqueness of component abstractions in a way which is still ‚Äújust JavaScript.‚Äù</p></li></ol><p>There are of course other reasons for and against using the <code class="inline">this</code> value as the context in components. At its root, I believe most arguments <em>against</em> using <code class="inline">this</code> are driven by a desire to define all functions as top-level arrow function assignments (<code class="inline">const MyComponent = (props) =&gt; </code>). While I don‚Äôt think I‚Äôll be able to convince people of the benefit of one or the other style of coding in the general case, hopefully I‚Äôve convinced you as to why using <code class="inline">this</code> like we do in Crank might make sense for a component framework.</p><p>A second controversial design decison was the usage of explicit <code class="inline">refresh()</code> calls rather than some kind of ‚Äúreactive‚Äù  <code class="inline">setState()</code>- or proxy-based system. I will probably write another essay at some point explaining why I think explicit, opt-in rerendering is preferable to any other system for a component framework, but for now, note that it‚Äôs easier to implement: the <code class="inline">refresh()</code> method is currently a one-liner!</p><h2 id="step-7-rearranging">Step 7: Rearranging</h2><p>Our generator components have a subtle bug which we need to fix before continuing. Components which render different roots on refresh will not rerender. For instance, the following component should cycle rendering <code class="inline">h1</code> through <code class="inline">h6</code> elements when clicked.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">CyclingHeader</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">const</span> <span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>    i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">6</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>  <span class="token punctuation">}</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>    <span class="token keyword">const</span> Header <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">h</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>    <span class="token keyword">yield</span> <span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>      <span class="token operator">&lt;</span>Header onclick<span class="token operator">=</span><span class="token punctuation">{</span>onclick<span class="token punctuation">}</span><span class="token operator">&gt;</span>Heading level <span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Header<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>    <span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code>  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code>    <span class="token operator">&lt;</span>CyclingHeader <span class="token operator">/</span><span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code>  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code>  app<span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code>app<span class="token punctuation">.</span>firstChild<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code>app<span class="token punctuation">.</span>firstChild<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><code><span class="token comment">// Expected: &lt;div&gt;&lt;h3&gt;Heading level 3&lt;/h3&gt;&lt;/div&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><code><span class="token comment">// Actual:   &lt;div&gt;&lt;h1&gt;Heading level 1&lt;/h1&gt;&lt;/div&gt;</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-35" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-35'] = {"code":"function *CyclingHeader({name}) {\n  let i = 0;\n  const onclick = () =\u003E {\n    i = (i + 1) % 6;\n    this.refresh();\n  };\n\n  while (true) {\n    const Header = `h${i + 1}`;\n    yield (\n      \u003CHeader onclick={onclick}\u003EHeading level {i + 1}\u003C\u002FHeader\u003E\n    );\n  }\n}\n\nrenderer.render(\n  \u003Cdiv\u003E\n    \u003CCyclingHeader \u002F\u003E\n  \u003C\u002Fdiv\u003E,\n  app,\n);\n\napp.firstChild.click();\napp.firstChild.click();\nconsole.log(app.innerHTML);\n\u002F\u002F Expected: \u003Cdiv\u003E\u003Ch3\u003EHeading level 3\u003C\u002Fh3\u003E\u003C\u002Fdiv\u003E\n\u002F\u002F Actual:   \u003Cdiv\u003E\u003Ch1\u003EHeading level 1\u003C\u002Fh1\u003E\u003C\u002Fdiv\u003E","lang":"jsx"};
		</script></div><p>If you run this component, you‚Äôll notice that clicking on the header doesn‚Äôt actually do anything. The problem is that we haven‚Äôt called the <code class="inline">arrange()</code> method on the component‚Äôs <em>nearest ancestor host element.</em> We can confirm that this is the cause of the bug by wrapping the component‚Äôs yield value in an extra <code class="inline">div</code> element. In that case, rendering would work correctly because <code class="inline">arrange()</code> is called on all of a component‚Äôs children for each refresh.</p><h3 id="implementation">Implementation</h3><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>@@ <span class="token operator">-</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token number">167</span> <span class="token operator">+</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token number">216</span> @@ <span class="token keyword">function</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token parameter">values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>   <span class="token keyword">return</span> values1<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> Portal<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> el<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span>tag <span class="token operator">!==</span> Fragment<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code><span class="token operator">+</span>    <span class="token keyword">return</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code><span class="token operator">+</span>  <span class="token keyword">return</span> <span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token function">getChildValues</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">getChildValues</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code><span class="token operator">+</span>  <span class="token keyword">const</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code><span class="token operator">+</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> child <span class="token keyword">of</span> <span class="token function">wrap</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> child <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code><span class="token operator">+</span>      values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> child <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code><span class="token operator">+</span>      values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">getValue</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><code><span class="token operator">+</span>  <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="29"><code> <span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Renderer</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="30"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="31"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="32"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="33"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="34"><code>   <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">children<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="35"><code>     <span class="token keyword">let</span> portal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="36"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>portal<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="37"><code>       portal<span class="token punctuation">.</span>props <span class="token operator">=</span> <span class="token punctuation">{</span>root<span class="token punctuation">,</span> children<span class="token punctuation">}</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="38"><code>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="39"><code>       portal <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>Portal<span class="token punctuation">,</span> <span class="token punctuation">{</span>root<span class="token punctuation">,</span> children<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="40"><code>       <span class="token keyword">this</span><span class="token punctuation">.</span>_cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> portal<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="41"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="42"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="43"><code><span class="token operator">-</span>    <span class="token keyword">return</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> portal<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="44"><code><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> portal<span class="token punctuation">,</span> portal<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="45"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="46"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="47"><code>   <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="48"><code>     <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="49"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="50"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="51"><code>   <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="52"><code>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="53"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">&quot;children&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="54"><code>         <span class="token keyword">continue</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="55"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="56"><code>         name <span class="token operator">=</span> <span class="token string">&quot;className&quot;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="57"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="58"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="59"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="60"><code>         node<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="61"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="62"><code>         node<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="63"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="64"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="65"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="66"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="67"><code>   <span class="token function">arrange</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> node<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="68"><code>     <span class="token keyword">let</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>firstChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="69"><code>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> newChild <span class="token keyword">of</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="70"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">===</span> newChild<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="71"><code>         child <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="72"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="73"><code>         <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> child<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> Node<span class="token punctuation">.</span><span class="token constant">TEXT_NODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="74"><code>           child<span class="token punctuation">.</span>nodeValue <span class="token operator">=</span> newChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="75"><code>           child <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="76"><code>         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="77"><code>           node<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="78"><code>         <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="79"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="80"><code>         node<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newChild<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="81"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="82"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="83"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="84"><code>     <span class="token keyword">while</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="85"><code>       <span class="token keyword">const</span> nextSibling <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="86"><code>       node<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="87"><code>       child <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="88"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="89"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="90"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="91"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="92"><code><span class="token operator">-</span><span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="93"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> oldChild<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="94"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="95"><code>     oldChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="96"><code>     newChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="97"><code>     oldChild<span class="token punctuation">.</span>tag <span class="token operator">===</span> newChild<span class="token punctuation">.</span>tag</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="98"><code>   <span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="99"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChild <span class="token operator">!==</span> newChild<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="100"><code>       oldChild<span class="token punctuation">.</span>props <span class="token operator">=</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="101"><code>       newChild <span class="token operator">=</span> oldChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="102"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="103"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="104"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="105"><code>   <span class="token keyword">let</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="106"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="107"><code><span class="token operator">-</span>    value <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="108"><code><span class="token operator">+</span>    value <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="109"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="110"><code>     value <span class="token operator">=</span> newChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="111"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="112"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="113"><code>   <span class="token keyword">return</span> <span class="token punctuation">[</span>newChild<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="114"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="115"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="116"><code><span class="token operator">-</span><span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="117"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="118"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="119"><code>     el <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">...</span>el<span class="token punctuation">.</span>props<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="120"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="121"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="122"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="123"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>_ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="124"><code><span class="token operator">-</span>      el<span class="token punctuation">.</span>_ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="125"><code><span class="token operator">+</span>      el<span class="token punctuation">.</span>_ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="126"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="127"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="128"><code>     <span class="token keyword">return</span> <span class="token function">updateCtx</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="129"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">!==</span> Fragment<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="130"><code><span class="token operator">+</span>    host <span class="token operator">=</span> el<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="131"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="132"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="133"><code><span class="token operator">-</span>  <span class="token keyword">return</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="134"><code><span class="token operator">+</span>  <span class="token keyword">return</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="135"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="136"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="137"><code><span class="token operator">-</span><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="138"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="139"><code>   <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="140"><code>   newChildren <span class="token operator">=</span> <span class="token function">arrayify</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="141"><code>   <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="142"><code>   <span class="token keyword">const</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="143"><code>   <span class="token keyword">const</span> length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">,</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="144"><code>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="145"><code>     <span class="token keyword">const</span> oldChild <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="146"><code>     <span class="token keyword">let</span> newChild <span class="token operator">=</span> <span class="token function">narrow</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="147"><code><span class="token operator">-</span>    <span class="token keyword">const</span> <span class="token punctuation">[</span>child<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="148"><code><span class="token operator">+</span>    <span class="token keyword">const</span> <span class="token punctuation">[</span>child<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="149"><code>     children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="150"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="151"><code>       values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="152"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="153"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="154"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="155"><code>   el<span class="token punctuation">.</span>_children <span class="token operator">=</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="156"><code>   <span class="token keyword">return</span> <span class="token function">commit</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> <span class="token function">normalize</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="157"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="158"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="159"><code> <span class="token keyword">function</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="160"><code><span class="token operator">-</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">||</span> el<span class="token punctuation">.</span>tag <span class="token operator">===</span> Fragment<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="161"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="162"><code><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token function">commitCtx</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_ctx<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="163"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> Fragment<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="164"><code>     <span class="token keyword">return</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="165"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> Portal<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="166"><code>     renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>root<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="167"><code>     <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="168"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>_node<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="169"><code>     el<span class="token punctuation">.</span>_node <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="170"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="171"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="172"><code>   renderer<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="173"><code>   renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="174"><code>   <span class="token keyword">return</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="175"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="176"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="177"><code> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="178"><code><span class="token operator">-</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="179"><code><span class="token operator">+</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="180"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_renderer <span class="token operator">=</span> renderer<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="181"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_host <span class="token operator">=</span> host<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="182"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_el <span class="token operator">=</span> el<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="183"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_iter <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="184"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="185"><code><span class="token operator">+</span>    <span class="token comment">// flags</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="186"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_isUpdating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="187"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="188"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="189"><code>   <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="190"><code><span class="token operator">-</span>    <span class="token keyword">return</span> <span class="token function">updateCtx</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="191"><code><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="192"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="193"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="194"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="195"><code><span class="token operator">-</span><span class="token keyword">function</span> <span class="token function">updateCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="196"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="197"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="198"><code>     <span class="token keyword">const</span> value <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="199"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIteratorLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="200"><code>       ctx<span class="token punctuation">.</span>_iter <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="201"><code>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="202"><code>       <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="203"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="204"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="205"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="206"><code>   <span class="token keyword">const</span> iteration <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="207"><code>   <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> iteration<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="208"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="209"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="210"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">updateCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="211"><code><span class="token operator">+</span>  ctx<span class="token punctuation">.</span>_isUpdating <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="212"><code><span class="token operator">+</span>  <span class="token keyword">return</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="213"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="214"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="215"><code> <span class="token keyword">function</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="216"><code><span class="token operator">-</span>  <span class="token keyword">return</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_renderer<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">,</span> <span class="token function">narrow</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="217"><code><span class="token operator">+</span>  <span class="token keyword">return</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_renderer<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>_host<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">,</span> <span class="token function">narrow</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="218"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="219"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="220"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">commitCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="221"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_isUpdating<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="222"><code><span class="token operator">+</span>    ctx<span class="token punctuation">.</span>_renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="223"><code><span class="token operator">+</span>      ctx<span class="token punctuation">.</span>_host<span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="224"><code><span class="token operator">+</span>      ctx<span class="token punctuation">.</span>_host<span class="token punctuation">.</span>tag <span class="token operator">===</span> Portal <span class="token operator">?</span> ctx<span class="token punctuation">.</span>_host<span class="token punctuation">.</span>props<span class="token punctuation">.</span>root <span class="token operator">:</span> ctx<span class="token punctuation">.</span>_host<span class="token punctuation">.</span>_node<span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="225"><code><span class="token operator">+</span>      <span class="token function">getChildValues</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_host<span class="token punctuation">)</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="226"><code><span class="token operator">+</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="227"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="228"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="229"><code><span class="token operator">+</span>  ctx<span class="token punctuation">.</span>_isUpdating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="230"><code><span class="token operator">+</span>  <span class="token keyword">return</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="231"><code> <span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-36" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-36'] = {"code":"--- a\u002Fcrank.js\n+++ b\u002Fcrank.js\n@@ -99,167 +99,216 @@ function normalize(values) {\n   return values1;\n }\n\n+function getValue(el) {\n+  if (el.tag === Portal) {\n+    return undefined;\n+  } else if (typeof el.tag !== \"function\" && el.tag !== Fragment) {\n+    return el._node;\n+  }\n+\n+  return unwrap(getChildValues(el));\n+}\n+\n+function getChildValues(el) {\n+  const values = [];\n+  for (const child of wrap(el._children)) {\n+    if (typeof child === \"string\") {\n+      values.push(child);\n+    } else if (typeof child !== \"undefined\") {\n+      values.push(getValue(child));\n+    }\n+  }\n+\n+  return normalize(values);\n+}\n+\n export class Renderer {\n   constructor() {\n     this._cache = new WeakMap();\n   }\n\n   render(children, root) {\n     let portal = this._cache.get(root);\n     if (portal) {\n       portal.props = {root, children};\n     } else {\n       portal = createElement(Portal, {root, children});\n       this._cache.set(root, portal);\n     }\n\n-    return update(this, portal);\n+    return update(this, portal, portal);\n   }\n\n   create(el) {\n     return document.createElement(el.tag);\n   }\n\n   patch(el, node) {\n     for (let [name, value] of Object.entries(el.props)) {\n       if (name === \"children\") {\n         continue;\n       } else if (name === \"class\") {\n         name = \"className\";\n       }\n\n       if (name in node) {\n         node[name] = value;\n       } else {\n         node.setAttribute(name, value);\n       }\n     }\n   }\n\n   arrange(el, node, children) {\n     let child = node.firstChild;\n     for (const newChild of children) {\n       if (child === newChild) {\n         child = child.nextSibling;\n       } else if (typeof newChild === \"string\") {\n         if (child !== null && child.nodeType === Node.TEXT_NODE) {\n           child.nodeValue = newChild;\n           child = child.nextSibling;\n         } else {\n           node.insertBefore(document.createTextNode(newChild), child);\n         }\n       } else {\n         node.insertBefore(newChild, child);\n       }\n     }\n\n     while (child !== null) {\n       const nextSibling = child.nextSibling;\n       node.removeChild(child);\n       child = child.nextSibling;\n     }\n   }\n }\n\n-function diff(renderer, oldChild, newChild) {\n+function diff(renderer, host, oldChild, newChild) {\n   if (\n     oldChild instanceof Element &&\n     newChild instanceof Element &&\n     oldChild.tag === newChild.tag\n   ) {\n     if (oldChild !== newChild) {\n       oldChild.props = newChild.props;\n       newChild = oldChild;\n     }\n   }\n\n   let value;\n   if (newChild instanceof Element) {\n-    value = update(renderer, newChild);\n+    value = update(renderer, host, newChild);\n   } else {\n     value = newChild;\n   }\n\n   return [newChild, value];\n }\n\n-function update(renderer, el) {\n+function update(renderer, host, el) {\n   if (el._isMounted) {\n     el = createElement(el, {...el.props});\n   }\n\n   if (typeof el.tag === \"function\") {\n     if (!el._ctx) {\n-      el._ctx = new Context(renderer, el);\n+      el._ctx = new Context(renderer, host, el);\n     }\n\n     return updateCtx(el._ctx);\n+  } else if (el.tag !== Fragment) {\n+    host = el;\n   }\n\n-  return updateChildren(renderer, el, el.props.children);\n+  return updateChildren(renderer, host, el, el.props.children);\n }\n\n-function updateChildren(renderer, el, newChildren) {\n+function updateChildren(renderer, host, el, newChildren) {\n   const oldChildren = wrap(el._children);\n   newChildren = arrayify(newChildren);\n   const children = [];\n   const values = [];\n   const length = Math.max(oldChildren.length, newChildren.length);\n   for (let i = 0; i \u003C length; i++) {\n     const oldChild = oldChildren[i];\n     let newChild = narrow(newChildren[i]);\n-    const [child, value] = diff(renderer, oldChild, newChild);\n+    const [child, value] = diff(renderer, host, oldChild, newChild);\n     children.push(child);\n     if (value) {\n       values.push(value);\n     }\n   }\n\n   el._children = unwrap(children);\n   return commit(renderer, el, normalize(values));\n }\n\n function commit(renderer, el, values) {\n-  if (typeof el.tag === \"function\" || el.tag === Fragment) {\n+  if (typeof el.tag === \"function\") {\n+    return commitCtx(el._ctx, values);\n+  } else if (el.tag === Fragment) {\n     return unwrap(values);\n   } else if (el.tag === Portal) {\n     renderer.arrange(el, el.props.root, values);\n     return undefined;\n   } else if (!el._node) {\n     el._node = renderer.create(el);\n   }\n\n   renderer.patch(el, el._node);\n   renderer.arrange(el, el._node, values);\n   return el._node;\n }\n\n class Context {\n-  constructor(renderer, el) {\n+  constructor(renderer, host, el) {\n     this._renderer = renderer;\n+    this._host = host;\n     this._el = el;\n     this._iter = undefined;\n+\n+    \u002F\u002F flags\n+    this._isUpdating = false;\n   }\n\n   refresh() {\n-    return updateCtx(this);\n+    return stepCtx(this);\n   }\n }\n\n-function updateCtx(ctx) {\n+function stepCtx(ctx) {\n   if (!ctx._iter) {\n     const value = ctx._el.tag.call(ctx, ctx._el.props);\n     if (isIteratorLike(value)) {\n       ctx._iter = value;\n     } else {\n       return updateCtxChildren(ctx, value);\n     }\n   }\n\n   const iteration = ctx._iter.next();\n   return updateCtxChildren(ctx, iteration.value);\n }\n\n+function updateCtx(ctx) {\n+  ctx._isUpdating = true;\n+  return stepCtx(ctx);\n+}\n+\n function updateCtxChildren(ctx, children) {\n-  return updateChildren(ctx._renderer, ctx._el, narrow(children));\n+  return updateChildren(ctx._renderer, ctx._host, ctx._el, narrow(children));\n+}\n+\n+function commitCtx(ctx, values) {\n+  if (!ctx._isUpdating) {\n+    ctx._renderer.arrange(\n+      ctx._host,\n+      ctx._host.tag === Portal ? ctx._host.props.root : ctx._host._node,\n+      getChildValues(ctx._host),\n+    );\n+  }\n+\n+  ctx._isUpdating = false;\n+  return unwrap(values);\n }","lang":"diff"};
		</script></div><p><a href="https://github.com/brainkim/crank-from-scratch/commit/ce8a6b8a6cbc55e04b761b556c6e10f084fbc555">Diff</a> <a href="https://github.com/brainkim/crank-from-scratch/blob/ce8a6b8a6cbc55e04b761b556c6e10f084fbc555/crank.js">File</a></p><p>This diff is larger because we have to adjust the signatures of many of the recursive renderer functions we‚Äôve defined, adding a parameter for the current host element and passing it down the tree. With this data available, we can now retain it on component contexts, so that it can be accessed by context methods and functions. We also add an <code class="inline">_isUpdating</code> boolean flag to contexts, to help us determine whether a component is being updated by a parent or doing a self-initiated refresh. Finally, we create a <code class="inline">commitCtx()</code> function, analogous to the <code class="inline">commit()</code> renderer function, which calls <code class="inline">arrange()</code> on a component‚Äôs nearest ancestor host element if the component is detected as refreshing.</p><p><strong>Notes:</strong></p><ol><li><p>We‚Äôve added the utility functions <code class="inline">getValue()</code> and <code class="inline">getChildValues()</code>. These mutually recursive functions traverse the element tree and find an element‚Äôs <em>value</em> or <em>child values</em>. The ‚Äúvalue‚Äù of an element varies based on its tag; a host element‚Äôs value is just the DOM node which we created for it, while a component or fragment element‚Äôs value can be <code class="inline">undefined</code>, a string, a DOM node, or array of strings and DOM nodes, depending on the element‚Äôs children.</p><p>We were previously using the return values of the <code class="inline">update()</code> and <code class="inline">commit()</code> functions to pass element values upwards, but when we rearrange a host element, we don‚Äôt have access to the host element‚Äôs child values, because that host element may have other children besides the component which is refreshing. Therefore, we use <code class="inline">getChildValues</code> to compute a host element‚Äôs child values on the fly when rearranging to save on memory.</p></li><li><p>We‚Äôve moved most of the logic in the <code class="inline">updateCtx()</code> function to the <code class="inline">stepCtx()</code> function. Both <code class="inline">updateCtx()</code> and the <code class="inline">refresh()</code> method call <code class="inline">stepCtx()</code> , but only <code class="inline">updateCtx()</code> sets the <code class="inline">_isUpdating</code> flag. We could also have named the flag ‚Äú_isRefreshing‚Äù and set it in the <code class="inline">refresh()</code> method, but setting the flag by updates is more convenient for when we deal with concurrent async rendering situations later on.</p></li></ol><h2 id="step-8-returning-and-unmounting">Step 8: Returning and Unmounting</h2><p>One of the coolest features of generator functions is that they can be closed at both ends: internally, a return statement may be placed in the generator‚Äôs body to end its iteration, and externally, the iterator method <code class="inline">return()</code> can be called on the generator object.</p><p>To review, the <code class="inline">return()</code> method will close a generator execution by replacing the currently suspended <code class="inline">yield</code> with a <code class="inline">return</code> operation. This means that any loops the generator was in would be broken out of, and code which would normally execute after the <code class="inline">yield</code> would never execute.</p><p>We can take advantage of the <code class="inline">return()</code> method by calling it on component iterators when their corresponding elements are removed from the element tree. This in turn allows developers to write cleanup code by wrapping <code class="inline">yield</code> operations in a <code class="inline">try</code>/<code class="inline">finally</code>-statement, as in the following component.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">Timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">let</span> seconds <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">const</span> interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>    seconds<span class="token operator">++</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>  <span class="token keyword">try</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>      <span class="token keyword">yield</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Seconds<span class="token operator">:</span> <span class="token punctuation">{</span>seconds<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>    <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-37" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-37'] = {"code":"function *Timer() {\n  let seconds = 0;\n  const interval = setInterval(() =\u003E {\n    seconds++;\n    this.refresh();\n  }, 1000);\n  try {\n    while (true) {\n      yield \u003Cdiv\u003ESeconds: {seconds}\u003C\u002Fdiv\u003E;\n    }\n  } finally {\n    clearInterval(interval);\n  }\n}","lang":"jsx"};
		</script></div><p>Currently, the <code class="inline">clearInterval()</code> call will never be reached, and would cause a memory leak if the component were rendered and removed multiple times.</p><h3 id="implementation">Implementation</h3><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>@@ <span class="token operator">-</span><span class="token number">227</span><span class="token punctuation">,</span><span class="token number">20</span> <span class="token operator">+</span><span class="token number">227</span><span class="token punctuation">,</span><span class="token number">30</span> @@ <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code> <span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>   <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>   newChildren <span class="token operator">=</span> <span class="token function">arrayify</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>   <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>   <span class="token keyword">const</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>   <span class="token keyword">const</span> length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">,</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>     <span class="token keyword">const</span> oldChild <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>     <span class="token keyword">let</span> newChild <span class="token operator">=</span> <span class="token function">narrow</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>     <span class="token keyword">const</span> <span class="token punctuation">[</span>child<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> child <span class="token operator">!==</span> oldChild<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code><span class="token operator">+</span>      <span class="token function">unmount</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code>     children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code>       values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code>   el<span class="token punctuation">.</span>_children <span class="token operator">=</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code><span class="token operator">+</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> oldChild <span class="token keyword">of</span> oldChildren<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><code><span class="token operator">+</span>      <span class="token function">unmount</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="29"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="30"><code>   <span class="token keyword">return</span> <span class="token function">commit</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> <span class="token function">normalize</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="31"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="32"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="33"><code>@@ <span class="token operator">-</span><span class="token number">261</span><span class="token punctuation">,</span><span class="token number">33</span> <span class="token operator">+</span><span class="token number">271</span><span class="token punctuation">,</span><span class="token number">52</span> @@ <span class="token keyword">function</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="34"><code>   <span class="token keyword">return</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="35"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="36"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="37"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="38"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="39"><code><span class="token operator">+</span>    <span class="token function">unmountCtx</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="40"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="41"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="42"><code><span class="token operator">+</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> child <span class="token keyword">of</span> <span class="token function">wrap</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="43"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="44"><code><span class="token operator">+</span>      <span class="token function">unmount</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="45"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="46"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="47"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="48"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="49"><code> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="50"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="51"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_renderer <span class="token operator">=</span> renderer<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="52"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_host <span class="token operator">=</span> host<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="53"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_el <span class="token operator">=</span> el<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="54"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_iter <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="55"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="56"><code>     <span class="token comment">// flags</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="57"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isUpdating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="58"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_isDone <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="59"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="60"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="61"><code>   <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="62"><code>     <span class="token keyword">return</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="63"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="64"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="65"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="66"><code> <span class="token keyword">function</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="67"><code><span class="token operator">-</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="68"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_isDone<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="69"><code><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token function">getValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="70"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="71"><code>     <span class="token keyword">const</span> value <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="72"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIteratorLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="73"><code>       ctx<span class="token punctuation">.</span>_iter <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="74"><code>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="75"><code>       <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="76"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="77"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="78"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="79"><code>   <span class="token keyword">const</span> iteration <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="80"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>iteration<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="81"><code><span class="token operator">+</span>    ctx<span class="token punctuation">.</span>_isDone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="82"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="83"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="84"><code>   <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> iteration<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="85"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="86"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="87"><code>@@ <span class="token operator">-</span><span class="token number">312</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token operator">+</span><span class="token number">341</span><span class="token punctuation">,</span><span class="token number">12</span> @@ <span class="token keyword">function</span> <span class="token function">commitCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="88"><code>   ctx<span class="token punctuation">.</span>_isUpdating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="89"><code>   <span class="token keyword">return</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="90"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="91"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="92"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">unmountCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="93"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_isDone<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="94"><code><span class="token operator">+</span>    ctx<span class="token punctuation">.</span>_isDone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="95"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_iterator <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> ctx<span class="token punctuation">.</span>_iterator<span class="token punctuation">.</span>return <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="96"><code><span class="token operator">+</span>      ctx<span class="token punctuation">.</span>_iterator<span class="token punctuation">.</span><span class="token function">return</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="97"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="98"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="99"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-38" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-38'] = {"code":"--- a\u002Fcrank.js\n+++ b\u002Fcrank.js\n@@ -227,20 +227,30 @@ function update(renderer, host, el) {\n function updateChildren(renderer, host, el, newChildren) {\n   const oldChildren = wrap(el._children);\n   newChildren = arrayify(newChildren);\n   const children = [];\n   const values = [];\n   const length = Math.max(oldChildren.length, newChildren.length);\n   for (let i = 0; i \u003C length; i++) {\n     const oldChild = oldChildren[i];\n     let newChild = narrow(newChildren[i]);\n     const [child, value] = diff(renderer, host, oldChild, newChild);\n+    if (oldChild instanceof Element && child !== oldChild) {\n+      unmount(renderer, oldChild);\n+    }\n+\n     children.push(child);\n     if (value) {\n       values.push(value);\n     }\n   }\n\n   el._children = unwrap(children);\n+  for (const oldChild of oldChildren.slice(length)) {\n+    if (oldChild instanceof Element) {\n+      unmount(renderer, oldChild);\n+    }\n+  }\n+\n   return commit(renderer, el, normalize(values));\n }\n\n@@ -261,33 +271,52 @@ function commit(renderer, el, values) {\n   return el._node;\n }\n\n+function unmount(renderer, el) {\n+  if (typeof el.tag === \"function\") {\n+    unmountCtx(el._ctx);\n+  }\n+\n+  for (const child of wrap(el._children)) {\n+    if (child instanceof Element) {\n+      unmount(renderer, child);\n+    }\n+  }\n+}\n+\n class Context {\n   constructor(renderer, host, el) {\n     this._renderer = renderer;\n     this._host = host;\n     this._el = el;\n     this._iter = undefined;\n\n     \u002F\u002F flags\n     this._isUpdating = false;\n+    this._isDone = false;\n   }\n\n   refresh() {\n     return stepCtx(this);\n   }\n }\n\n function stepCtx(ctx) {\n-  if (!ctx._iter) {\n+  if (ctx._isDone) {\n+    return getValue(ctx._el);\n+  } else if (!ctx._iter) {\n     const value = ctx._el.tag.call(ctx, ctx._el.props);\n     if (isIteratorLike(value)) {\n       ctx._iter = value;\n     } else {\n       return updateCtxChildren(ctx, value);\n     }\n   }\n\n   const iteration = ctx._iter.next();\n+  if (iteration.done) {\n+    ctx._isDone = true;\n+  }\n+\n   return updateCtxChildren(ctx, iteration.value);\n }\n\n@@ -312,3 +341,12 @@ function commitCtx(ctx, values) {\n   ctx._isUpdating = false;\n   return unwrap(values);\n }\n+\n+function unmountCtx(ctx) {\n+  if (!ctx._isDone) {\n+    ctx._isDone = true;\n+    if (ctx._iterator && typeof ctx._iterator.return === \"function\") {\n+      ctx._iterator.return();\n+    }\n+  }\n+}","lang":"diff"};
		</script></div><p><a href="https://github.com/brainkim/crank-from-scratch/commit/274b9142fced2b366bedb62ca668e96a64e7c39a">Diff</a> <a href="https://github.com/brainkim/crank-from-scratch/blob/274b9142fced2b366bedb62ca668e96a64e7c39a/crank.js">File</a></p><p>We‚Äôve added another renderer function, <code class="inline">unmount</code>, along with its analogous context function, <code class="inline">unmountCtx</code>. It is important to make the <code class="inline">unmount</code> function recursive, because there can be component elements deeply nested in the element tree which expect to be returned.</p><p>We‚Äôve also added the flag <code class="inline">_isDone</code> to context objects to keep track of the iterator‚Äôs current state. By checking the <code class="inline">done</code> property for each iteration, we can freeze generator components on their final rendered values if they are detected as having returned.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">function</span> <span class="token function">MyComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>  <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>MyComponent <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>MyComponent <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>MyComponent <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>MyComponent <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-39" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-39'] = {"code":"function MyComponent() {\n  yield 1;\n  yield 2;\n  return 3;\n}\n\nrenderer.render(\u003CMyComponent \u002F\u003E, app);\nconsole.log(app.innerHTML); \u002F\u002F 1\nrenderer.render(\u003CMyComponent \u002F\u003E, app);\nconsole.log(app.innerHTML); \u002F\u002F 2\nrenderer.render(\u003CMyComponent \u002F\u003E, app);\nconsole.log(app.innerHTML); \u002F\u002F 3\nrenderer.render(\u003CMyComponent \u002F\u003E, app);\nconsole.log(app.innerHTML); \u002F\u002F 3","lang":"jsx"};
		</script></div><p>When a generator function is returned before it is unmounted, this usually indicates programmer error, so sticking to its final value will make the sitution more obvious to the developer. Thanks to the <code class="inline">getValue</code> function implemented in the previous step, it‚Äôs now easy to get the final rendered value of a returned generator component element.</p><h2 id="step-9-props-iterators">Step 9: Props Iterators</h2><p>The generator components we‚Äôve seen so far haven‚Äôt referenced the <code class="inline">props</code> parameter in any way; we have exclusively used generator functions which take no parameters and yield elements in a <code class="inline">while (true)</code> loop. Eventually though, we‚Äôll want to write generator functions which use <code class="inline">props</code> just like any other component. However, we cannot simply reference the <code class="inline">props</code> parameter as for regular function components, because for generator functions, the <code class="inline">props</code> parameter may not necessarily reflect the latest <code class="inline">props</code> passed to the component.</p><p>There were potentially many ways to solve this problem. The design I chose for Crank was to make the context object an iterable of the component‚Äôs <code class="inline">props</code>, so that you could again destructure props in a <code class="inline">for‚Ä¶of</code> loop over <code class="inline">this</code>.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">StatefulGreeting</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>color<span class="token punctuation">,</span> name<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">let</span> prevName<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>color<span class="token punctuation">,</span> name<span class="token punctuation">}</span> <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>    <span class="token keyword">yield</span> <span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>        Hello <span class="token punctuation">{</span>prevName <span class="token operator">===</span> name <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;again, &quot;</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>        <span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">color: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>color<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>    <span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>    prevName <span class="token operator">=</span> name<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-40" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-40'] = {"code":"function *StatefulGreeting({color, name}) {\n  let prevName;\n  for ({color, name} of this) {\n    yield (\n      \u003Cdiv\u003E\n        Hello {prevName === name && \"again, \"}\n        \u003Cspan style={`color: ${color};`}\u003E{name}\u003C\u002Fspan\u003E\n      \u003C\u002Fdiv\u003E\n    );\n\n    prevName = name;\n  }\n}","lang":"jsx"};
		</script></div><p>This was yet another of the more controversial design decisions for Crank, likely because it combines multiple syntaxes and keywords in an unusual way. Seeing <code class="inline">for‚Ä¶of</code>, object destructuring, and <code class="inline">this</code> all in the same line of code might have been too much for some people. Hopefully, by this point, I‚Äôve explained enough of iterators and iterables, as well as why we use <code class="inline">this</code>, that this pattern doesn‚Äôt overwhelm you.</p><p>My reasons for choosing this design is that it allows developers to make the common refactoring of stateless function components to stateful generator components in the fewest keystrokes: you copy the props parameter into a <code class="inline">this</code> loop header, move the function body into the loop, and replace <code class="inline">return</code> keywords with <code class="inline">yield</code> keywords. Additionally, because new props are just variable assignments, we can compare old and new props easily, blending the concepts of props and state, as in the above example.</p><p>Ultimately, I didn‚Äôt want to diverge too much from the typical function component syntax, where the first parameter is the props of the component, and is usually destructured inline. This syntax makes it easy to understand what props a component expects by having it defined at the top of the function. Furthermore, TypeScript‚Äôs JSX type-checking feature for function components continues to work based on the props parameter, even if the function is a generator function.</p><h3 id="implementation">Implementation</h3><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>@@ <span class="token operator">-</span><span class="token number">286</span><span class="token punctuation">,</span><span class="token number">36</span> <span class="token operator">+</span><span class="token number">286</span><span class="token punctuation">,</span><span class="token number">49</span> @@ <span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_renderer <span class="token operator">=</span> renderer<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_host <span class="token operator">=</span> host<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_el <span class="token operator">=</span> el<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_iter <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>     <span class="token comment">// flags</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isUpdating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isDone <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code>   <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code>     <span class="token keyword">return</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code><span class="token operator">+</span>  <span class="token operator">*</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code><span class="token operator">+</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isDone<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code><span class="token operator">+</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code><span class="token operator">+</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Context iterated twice without a yield&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code><span class="token operator">+</span>      <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><code><span class="token operator">+</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><code><span class="token operator">+</span>      <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="29"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="30"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="31"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="32"><code> <span class="token keyword">function</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="33"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_isDone<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="34"><code>     <span class="token keyword">return</span> <span class="token function">getValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="35"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="36"><code>     <span class="token keyword">const</span> value <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="37"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIteratorLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="38"><code>       ctx<span class="token punctuation">.</span>_iter <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="39"><code>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="40"><code>       <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="41"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="42"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="43"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="44"><code>   <span class="token keyword">const</span> iteration <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="45"><code><span class="token operator">+</span>  ctx<span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="46"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>iteration<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="47"><code>     ctx<span class="token punctuation">.</span>_isDone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="48"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="49"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="50"><code>   <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> iteration<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="51"><code> <span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-41" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-41'] = {"code":"--- a\u002Fcrank.js\n+++ b\u002Fcrank.js\n@@ -286,36 +286,49 @@ function unmount(renderer, el) {\n class Context {\n   constructor(renderer, host, el) {\n     this._renderer = renderer;\n     this._host = host;\n     this._el = el;\n     this._iter = undefined;\n\n     \u002F\u002F flags\n     this._isUpdating = false;\n+    this._isIterating = false;\n     this._isDone = false;\n   }\n\n   refresh() {\n     return stepCtx(this);\n   }\n+\n+  *[Symbol.iterator]() {\n+    while (!this._isDone) {\n+      if (this._isIterating) {\n+        throw new Error(\"Context iterated twice without a yield\");\n+      }\n+\n+      this._isIterating = true;\n+      yield this._el.props;\n+    }\n+  }\n }\n\n function stepCtx(ctx) {\n   if (ctx._isDone) {\n     return getValue(ctx._el);\n   } else if (!ctx._iter) {\n     const value = ctx._el.tag.call(ctx, ctx._el.props);\n     if (isIteratorLike(value)) {\n       ctx._iter = value;\n     } else {\n       return updateCtxChildren(ctx, value);\n     }\n   }\n\n   const iteration = ctx._iter.next();\n+  ctx._isIterating = false;\n   if (iteration.done) {\n     ctx._isDone = true;\n   }\n\n   return updateCtxChildren(ctx, iteration.value);\n }","lang":"diff"};
		</script></div><p><a href="https://github.com/brainkim/crank-from-scratch/commit/79e12981b3bbb65ffd912cdf3fd4b11b19862da4">Diff</a> <a href="https://github.com/brainkim/crank-from-scratch/blob/79e12981b3bbb65ffd912cdf3fd4b11b19862da4/crank.js">File</a></p><p><strong>Notes:</strong></p><ol><li>The <code class="inline">[Symbol.iterator]()</code> method is a generator method. The syntax is similar to function generators in that we use a star, except now the star appears before the method name. Additionally, we use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Method_definitions#Computed_property_names">computed method syntax</a> (the square brackets) so that we can reference the global <code class="inline">Symbol.iterator</code> symbol.</li><li>We add an <code class="inline">_isIterating</code> flag to contexts to detect when props are pulled multiple times without a yield, so that we can throw an error. This would happen if the developer forgot to yield from within the for loop. Throwing an error provides predictable feedback as opposed to entering an infinite loop.</li></ol><h2 id="step-10-accessing-dom-nodes">Step 10: Accessing DOM Nodes</h2><p>You may have noticed that the <code class="inline">refresh()</code> method already returns the actual DOM node or nodes which components render. One of the goals of Crank is to be a framework which makes it easy to do raw DOM operations. For many use-cases, it‚Äôs just easier to get your hands dirty and mutate the DOM by hand, even if you still want to use components and virtual elements for most situations. To that extent, we‚Äôll add some more ways for users to access DOM nodes.</p><p>First, we‚Äôll take advantage of an advanced feature of generator functions. The <code class="inline">next()</code> method of generator objects can optionally take an argument which will be ‚Äúpassed into‚Äù the generator as the result of the <code class="inline">yield</code> operation. For example, we can elaborate on the fibonacci number generator we saw previously by allowing the caller to pass in a truthy value to reset the sequence.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">let</span> current <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> next <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>    <span class="token keyword">const</span> reset <span class="token operator">=</span> <span class="token keyword">yield</span> current<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>    <span class="token keyword">if</span> <span class="token punctuation">(</span>reset<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>      <span class="token punctuation">[</span>current<span class="token punctuation">,</span> next<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>      <span class="token punctuation">[</span>current<span class="token punctuation">,</span> next<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>next<span class="token punctuation">,</span> current <span class="token operator">+</span> next<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token keyword">const</span> iter <span class="token operator">=</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {value: 0, done: false}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {value: 1, done: false}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {value: 1, done: false}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {value: 2, done: false}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {value: 0, done: false}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {value: 1, done: false}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-42" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-42'] = {"code":"function *fibonacci() {\n  let current = 0, next = 1;\n  while (true) {\n    const reset = yield current;\n    if (reset) {\n      [current, next] = [0, 1];\n    } else {\n      [current, next] = [next, current + next];\n    }\n  }\n}\n\nconst iter = fibonacci();\nconsole.log(iter.next()); \u002F\u002F {value: 0, done: false}\nconsole.log(iter.next()); \u002F\u002F {value: 1, done: false}\nconsole.log(iter.next()); \u002F\u002F {value: 1, done: false}\nconsole.log(iter.next()); \u002F\u002F {value: 2, done: false}\nconsole.log(iter.next(true)); \u002F\u002F {value: 0, done: false}\nconsole.log(iter.next()); \u002F\u002F {value: 1, done: false}","lang":"js"};
		</script></div><p>The <code class="inline">reset</code> variable is set to the yield operation, and we reset the current and next variables if <code class="inline">reset</code> is detected as truthy. This feature of generator functions only works when calling the iterator methods; when using <code class="inline">for‚Ä¶of</code> loops, the yield operation will always resolve to <code class="inline">undefined</code>.</p><p>For Crank, the most natural thing to pass back into generator components is the DOM nodes which were rendered. This gives generator components a ‚Äúcall and response‚Äù-like structure, where the generator yields virtual elements and gets their realized equivalents passed back in.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">ImperativeCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">let</span> button<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>    <span class="token keyword">if</span> <span class="token punctuation">(</span>button<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>      <span class="token comment">/* do whatever DOM mutations you please */</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>      button<span class="token punctuation">.</span>style<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token string">&quot;red&quot;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>    i<span class="token operator">++</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>    button <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token operator">&lt;</span>button<span class="token operator">&gt;</span><span class="token punctuation">{</span>i<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-43" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-43'] = {"code":"function *ImperativeCounter() {\n  let i = 0;\n  let button;\n  for ({} of this) {\n    if (button) {\n      \u002F* do whatever DOM mutations you please *\u002F\n      button.style.color = \"red\";\n    }\n\n    i++;\n    button = yield \u003Cbutton\u003E{i}\u003C\u002Fbutton\u003E;\n  }\n}","lang":"jsx"};
		</script></div><p>This API is intuitive, but doesn‚Äôt work too well with sync generator components, insofar as generator functions suspend directly on the <code class="inline">yield</code> keyword. While the yield operation can be assigned to a local variable, the actual timing of the assignment might surprise developers, insofar as it wouldn‚Äôt happen until the generator component was rerendered. In this case, any callbacks which expect the variable to have already been assigned would error.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">ImperativeCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">let</span> button<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>  <span class="token keyword">const</span> <span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>    <span class="token comment">// button may not be assigned after the first render</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>    button<span class="token punctuation">.</span>style<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token string">&quot;red&quot;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>    i<span class="token operator">++</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>    button <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token operator">&lt;</span>button<span class="token operator">&gt;</span><span class="token punctuation">{</span>i<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-44" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-44'] = {"code":"function *ImperativeCounter() {\n  let i = 0;\n  let button;\n  const onclick = () =\u003E {\n    \u002F\u002F button may not be assigned after the first render\n    button.style.color = \"red\";\n    i++;\n    this.refresh();\n  }\n  for ({} of this) {\n    button = yield \u003Cbutton\u003E{i}\u003C\u002Fbutton\u003E;\n  }\n}","lang":"jsx"};
		</script></div><p>As we‚Äôll see later, this is less of a problem for async generator components, which resume continuously when mounted, but for sync generator components we‚Äôll implement another context method <code class="inline">schedule()</code> to make yield values more useful. The <code class="inline">schedule()</code> method takes a callback which fires once when the component has committed. It allows us to write components like the following.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">ImperativeCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">let</span> button<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>  <span class="token keyword">const</span> <span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>    i<span class="token operator">++</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>    button<span class="token punctuation">.</span>style<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token string">&quot;red&quot;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>  <span class="token punctuation">}</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>    button <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token operator">&lt;</span>button onclick<span class="token operator">=</span><span class="token punctuation">{</span>onclick<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>i<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-45" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-45'] = {"code":"function *ImperativeCounter() {\n  let i = 0;\n  let button;\n  const onclick = () =\u003E {\n    i++;\n    button.style.color = \"red\";\n    this.refresh();\n  };\n  this.schedule(() =\u003E this.refresh());\n  for ({} of this) {\n    button = yield \u003Cbutton onclick={onclick}\u003E{i}\u003C\u002Fbutton\u003E;\n  }\n}","lang":"jsx"};
		</script></div><p>The schedule method can be used to listen for component commits more generally, but here we use it to trigger a second synchronous execution of the <code class="inline">ImperativeCounter</code> component the first time it is rendered. We do this by pairing it with the <code class="inline">refresh</code> method. In the example, generator resumes a second time synchronously, so the <code class="inline">button</code> variable is always available in the closure of the <code class="inline">onclick</code> callback.</p><p>Second, we‚Äôll also change the return value of the <code class="inline">render()</code> method slightly so that the created <code class="inline">Portal</code> element‚Äôs child values are returned, whereas before we returned <code class="inline">undefined</code>. In Crank, the value of a Portal is always <code class="inline">undefined</code>, so that the parents of the portal do not attempt to insert the <code class="inline">Portal</code> element‚Äôs root into the DOM in unexpected places. By returning the portal‚Äôs child values, we can make the <code class="inline">render()</code> method‚Äôs return value a little more useful.</p><h3 id="implementation">Implementation</h3><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>@@ <span class="token operator">-</span><span class="token number">125</span><span class="token punctuation">,</span><span class="token number">61</span> <span class="token operator">+</span><span class="token number">125</span><span class="token punctuation">,</span><span class="token number">62</span> @@ <span class="token keyword">function</span> <span class="token function">getChildValues</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code> <span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Renderer</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>   <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">children<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>     <span class="token keyword">let</span> portal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>portal<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>       portal<span class="token punctuation">.</span>props <span class="token operator">=</span> <span class="token punctuation">{</span>root<span class="token punctuation">,</span> children<span class="token punctuation">}</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>       portal <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>Portal<span class="token punctuation">,</span> <span class="token punctuation">{</span>root<span class="token punctuation">,</span> children<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code>       <span class="token keyword">this</span><span class="token punctuation">.</span>_cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> portal<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code><span class="token operator">-</span>    <span class="token keyword">return</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> portal<span class="token punctuation">,</span> portal<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code><span class="token operator">+</span>    <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> portal<span class="token punctuation">,</span> portal<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token function">getChildValues</span><span class="token punctuation">(</span>portal<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code>   <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code>     <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><code>   <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><code>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">&quot;children&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="29"><code>         <span class="token keyword">continue</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="30"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="31"><code>         name <span class="token operator">=</span> <span class="token string">&quot;className&quot;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="32"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="33"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="34"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="35"><code>         node<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="36"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="37"><code>         node<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="38"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="39"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="40"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="41"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="42"><code>   <span class="token function">arrange</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> node<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="43"><code>     <span class="token keyword">let</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>firstChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="44"><code>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> newChild <span class="token keyword">of</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="45"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">===</span> newChild<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="46"><code>         child <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="47"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="48"><code>         <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> child<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> Node<span class="token punctuation">.</span><span class="token constant">TEXT_NODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="49"><code>           child<span class="token punctuation">.</span>nodeValue <span class="token operator">=</span> newChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="50"><code>           child <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="51"><code>         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="52"><code>           node<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="53"><code>         <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="54"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="55"><code>         node<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newChild<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="56"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="57"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="58"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="59"><code>     <span class="token keyword">while</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="60"><code>       <span class="token keyword">const</span> nextSibling <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="61"><code>       node<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="62"><code>       child <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="63"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="64"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="65"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="66"><code>@@ <span class="token operator">-</span><span class="token number">286</span><span class="token punctuation">,</span><span class="token number">49</span> <span class="token operator">+</span><span class="token number">287</span><span class="token punctuation">,</span><span class="token number">56</span> @@ <span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="67"><code> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="68"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="69"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_renderer <span class="token operator">=</span> renderer<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="70"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_host <span class="token operator">=</span> host<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="71"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_el <span class="token operator">=</span> el<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="72"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_iter <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="73"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_schedules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="74"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="75"><code>     <span class="token comment">// flags</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="76"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isUpdating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="77"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="78"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isDone <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="79"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="80"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="81"><code>   <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="82"><code>     <span class="token keyword">return</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="83"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="84"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="85"><code><span class="token operator">+</span>  <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="86"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_schedules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="87"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="88"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="89"><code>   <span class="token operator">*</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="90"><code>     <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isDone<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="91"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="92"><code>         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Context iterated twice without a yield&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="93"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="94"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="95"><code>       <span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="96"><code>       <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="97"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="98"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="99"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="100"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="101"><code> <span class="token keyword">function</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="102"><code><span class="token operator">+</span>  <span class="token keyword">let</span> initial <span class="token operator">=</span> <span class="token operator">!</span>ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="103"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_isDone<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="104"><code>     <span class="token keyword">return</span> <span class="token function">getValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="105"><code><span class="token operator">-</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="106"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>initial<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="107"><code>     <span class="token keyword">const</span> value <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="108"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIteratorLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="109"><code>       ctx<span class="token punctuation">.</span>_iter <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="110"><code>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="111"><code>       <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="112"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="113"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="114"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="115"><code><span class="token operator">-</span>  <span class="token keyword">const</span> iteration <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="116"><code><span class="token operator">+</span>  <span class="token keyword">const</span> oldValue <span class="token operator">=</span> initial <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="117"><code><span class="token operator">+</span>  <span class="token keyword">const</span> iteration <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="118"><code>   ctx<span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="119"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>iteration<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="120"><code>     ctx<span class="token punctuation">.</span>_isDone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="121"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="122"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="123"><code>   <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> iteration<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="124"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="125"><code>@@ <span class="token operator">-</span><span class="token number">345</span><span class="token punctuation">,</span><span class="token number">14</span> <span class="token operator">+</span><span class="token number">353</span><span class="token punctuation">,</span><span class="token number">21</span> @@ <span class="token keyword">function</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="126"><code> <span class="token keyword">function</span> <span class="token function">commitCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="127"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_isUpdating<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="128"><code>     ctx<span class="token punctuation">.</span>_renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="129"><code>       ctx<span class="token punctuation">.</span>_host<span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="130"><code>       ctx<span class="token punctuation">.</span>_host<span class="token punctuation">.</span>tag <span class="token operator">===</span> Portal <span class="token operator">?</span> ctx<span class="token punctuation">.</span>_host<span class="token punctuation">.</span>props<span class="token punctuation">.</span>root <span class="token operator">:</span> ctx<span class="token punctuation">.</span>_host<span class="token punctuation">.</span>_node<span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="131"><code>       <span class="token function">getChildValues</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_host<span class="token punctuation">)</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="132"><code>     <span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="133"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="134"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="135"><code><span class="token operator">+</span>  <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="136"><code><span class="token operator">+</span>  <span class="token keyword">const</span> schedules <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_schedules<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="137"><code><span class="token operator">+</span>  ctx<span class="token punctuation">.</span>_schedules<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="138"><code><span class="token operator">+</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> schedule <span class="token keyword">of</span> schedules<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="139"><code><span class="token operator">+</span>    <span class="token function">schedule</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="140"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="141"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="142"><code>   ctx<span class="token punctuation">.</span>_isUpdating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="143"><code><span class="token operator">-</span>  <span class="token keyword">return</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="144"><code><span class="token operator">+</span>  <span class="token keyword">return</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="145"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="146"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="147"><code> <span class="token keyword">function</span> <span class="token function">unmountCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-46" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-46'] = {"code":"--- a\u002Fcrank.js\n+++ b\u002Fcrank.js\n@@ -125,61 +125,62 @@ function getChildValues(el) {\n export class Renderer {\n   constructor() {\n     this._cache = new WeakMap();\n   }\n\n   render(children, root) {\n     let portal = this._cache.get(root);\n     if (portal) {\n       portal.props = {root, children};\n     } else {\n       portal = createElement(Portal, {root, children});\n       this._cache.set(root, portal);\n     }\n\n-    return update(this, portal, portal);\n+    update(this, portal, portal);\n+    return getChildValues(portal);\n   }\n\n   create(el) {\n     return document.createElement(el.tag);\n   }\n\n   patch(el, node) {\n     for (let [name, value] of Object.entries(el.props)) {\n       if (name === \"children\") {\n         continue;\n       } else if (name === \"class\") {\n         name = \"className\";\n       }\n\n       if (name in node) {\n         node[name] = value;\n       } else {\n         node.setAttribute(name, value);\n       }\n     }\n   }\n\n   arrange(el, node, children) {\n     let child = node.firstChild;\n     for (const newChild of children) {\n       if (child === newChild) {\n         child = child.nextSibling;\n       } else if (typeof newChild === \"string\") {\n         if (child !== null && child.nodeType === Node.TEXT_NODE) {\n           child.nodeValue = newChild;\n           child = child.nextSibling;\n         } else {\n           node.insertBefore(document.createTextNode(newChild), child);\n         }\n       } else {\n         node.insertBefore(newChild, child);\n       }\n     }\n\n     while (child !== null) {\n       const nextSibling = child.nextSibling;\n       node.removeChild(child);\n       child = child.nextSibling;\n     }\n   }\n }\n@@ -286,49 +287,56 @@ function unmount(renderer, el) {\n class Context {\n   constructor(renderer, host, el) {\n     this._renderer = renderer;\n     this._host = host;\n     this._el = el;\n     this._iter = undefined;\n+    this._schedules = new Set();\n\n     \u002F\u002F flags\n     this._isUpdating = false;\n     this._isIterating = false;\n     this._isDone = false;\n   }\n\n   refresh() {\n     return stepCtx(this);\n   }\n\n+  schedule(callback) {\n+    this._schedules.add(callback);\n+  }\n+\n   *[Symbol.iterator]() {\n     while (!this._isDone) {\n       if (this._isIterating) {\n         throw new Error(\"Context iterated twice without a yield\");\n       }\n\n       this._isIterating = true;\n       yield this._el.props;\n     }\n   }\n }\n\n function stepCtx(ctx) {\n+  let initial = !ctx._iter;\n   if (ctx._isDone) {\n     return getValue(ctx._el);\n-  } else if (!ctx._iter) {\n+  } else if (initial) {\n     const value = ctx._el.tag.call(ctx, ctx._el.props);\n     if (isIteratorLike(value)) {\n       ctx._iter = value;\n     } else {\n       return updateCtxChildren(ctx, value);\n     }\n   }\n\n-  const iteration = ctx._iter.next();\n+  const oldValue = initial ? undefined : getValue(ctx._el);\n+  const iteration = ctx._iter.next(oldValue);\n   ctx._isIterating = false;\n   if (iteration.done) {\n     ctx._isDone = true;\n   }\n\n   return updateCtxChildren(ctx, iteration.value);\n }\n@@ -345,14 +353,21 @@ function updateCtxChildren(ctx, children) {\n function commitCtx(ctx, values) {\n   if (!ctx._isUpdating) {\n     ctx._renderer.arrange(\n       ctx._host,\n       ctx._host.tag === Portal ? ctx._host.props.root : ctx._host._node,\n       getChildValues(ctx._host),\n     );\n   }\n\n+  const value = unwrap(values);\n+  const schedules = Array.from(ctx._schedules);\n+  ctx._schedules.clear();\n+  for (const schedule of schedules) {\n+    schedule(value);\n+  }\n+\n   ctx._isUpdating = false;\n-  return unwrap(values);\n+  return value;\n }\n\n function unmountCtx(ctx) {","lang":"diff"};
		</script></div><p><a href="https://github.com/brainkim/crank-from-scratch/commit/cb6789ba7bb76966826dee83df2771bfd0e87c30">Diff</a> <a href="https://github.com/brainkim/crank-from-scratch/blob/cb6789ba7bb76966826dee83df2771bfd0e87c30/crank.js">File</a></p><p><strong>Notes:</strong></p><ol><li>The <code class="inline">schedule</code> method also passes the component‚Äôs rendered DOM nodes as the first argument of its callback. This is mainly helpful when using the <code class="inline">schedule</code> method in helper functions outside of component bodies. The benefit of using yield results as opposed to the <code class="inline">schedule</code> argument is that using yield results allows us to visualize the rendering and accessing of rendered values in a linear fashion directly within the component.</li></ol><h2 id="intermission">Intermission</h2><p>At this point, we‚Äôve implemented most of the logic for synchronous components in Crank. This is actually enough to write full-fledged applications.</p><p>Nevertheless, we will inevitably start to wonder: if we can use sync generator functions to write components, why can‚Äôt we use async functions and async generator functions to define components as well? The next steps will implement async components using these function syntaxes.</p><p>If you were already familiar with iterators, iterables and generators, you probably would not have had too much difficulty understanding the code and techniques we‚Äôve seen so far. However, because we are now diving into concurrent code which makes heavy use of promises, things are about to get a little more difficult. This is a natural place to take a break, or to <a href="https://github.com/brainkim/crank-from-scratch/blob/cb6789ba7bb76966826dee83df2771bfd0e87c30/crank.js">review the code</a> we‚Äôve written so far before continuing.</p><h2 id="step-11-async-function-components">Step 11: Async Function Components</h2><p>Just as Crank leverages generator functions for stateful components, it also provides first-class support for promises, by allowing components to be defined as <em>async</em> functions as well.</p><p>To review, an async function is a special function syntax which prepends <code class="inline">async</code> before the <code class="inline">function</code> keyword (<code class="inline">async function</code>). This allows you to use the <code class="inline">await</code> operator within the function to read promises in a way which looks synchronous. Here is an example of an async function component in Crank.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">DelayedGreeting</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Hello <span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token string">&quot;color: red&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-47" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-47'] = {"code":"async function DelayedGreeting({name}) {\n  await new Promise((resolve) =\u003E setTimeout(resolve, 2000));\n  return \u003Cdiv\u003EHello \u003Cspan style=\"color: red\"\u003E{name}\u003C\u002Fspan\u003E\u003C\u002Fdiv\u003E;\n}","lang":"jsx"};
		</script></div><h3 id="implementation">Implementation</h3><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>@@ <span class="token operator">-</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">10</span> @@ <span class="token keyword">function</span> <span class="token function">isIteratorLike</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>   <span class="token keyword">return</span> value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value<span class="token punctuation">.</span>next <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">isPromiseLike</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code><span class="token operator">+</span>  <span class="token keyword">return</span> value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code> <span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>@@ <span class="token operator">-</span><span class="token number">125</span><span class="token punctuation">,</span><span class="token number">62</span> <span class="token operator">+</span><span class="token number">129</span><span class="token punctuation">,</span><span class="token number">66</span> @@ <span class="token keyword">function</span> <span class="token function">getChildValues</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code> <span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Renderer</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code>   <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">children<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code>     <span class="token keyword">let</span> portal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>portal<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code>       portal<span class="token punctuation">.</span>props <span class="token operator">=</span> <span class="token punctuation">{</span>root<span class="token punctuation">,</span> children<span class="token punctuation">}</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code>       portal <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>Portal<span class="token punctuation">,</span> <span class="token punctuation">{</span>root<span class="token punctuation">,</span> children<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><code>       <span class="token keyword">this</span><span class="token punctuation">.</span>_cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> portal<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><code><span class="token operator">-</span>    <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> portal<span class="token punctuation">,</span> portal<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="29"><code><span class="token operator">+</span>    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> portal<span class="token punctuation">,</span> portal<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="30"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromiseLike</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="31"><code><span class="token operator">+</span>      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">getChildValues</span><span class="token punctuation">(</span>portal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="32"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="33"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="34"><code>     <span class="token keyword">return</span> <span class="token function">getChildValues</span><span class="token punctuation">(</span>portal<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="35"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="36"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="37"><code>   <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="38"><code>     <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="39"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="40"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="41"><code>   <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="42"><code>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="43"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">&quot;children&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="44"><code>         <span class="token keyword">continue</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="45"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="46"><code>         name <span class="token operator">=</span> <span class="token string">&quot;className&quot;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="47"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="48"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="49"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="50"><code>         node<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="51"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="52"><code>         node<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="53"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="54"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="55"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="56"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="57"><code>   <span class="token function">arrange</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> node<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="58"><code>     <span class="token keyword">let</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>firstChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="59"><code>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> newChild <span class="token keyword">of</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="60"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">===</span> newChild<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="61"><code>         child <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="62"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="63"><code>         <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> child<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> Node<span class="token punctuation">.</span><span class="token constant">TEXT_NODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="64"><code>           child<span class="token punctuation">.</span>nodeValue <span class="token operator">=</span> newChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="65"><code>           child <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="66"><code>         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="67"><code>           node<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="68"><code>         <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="69"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="70"><code>         node<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newChild<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="71"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="72"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="73"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="74"><code>     <span class="token keyword">while</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="75"><code>       <span class="token keyword">const</span> nextSibling <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="76"><code>       node<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="77"><code>       child <span class="token operator">=</span> child<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="78"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="79"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="80"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="81"><code>@@ <span class="token operator">-</span><span class="token number">228</span><span class="token punctuation">,</span><span class="token number">29</span> <span class="token operator">+</span><span class="token number">236</span><span class="token punctuation">,</span><span class="token number">41</span> @@ <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="82"><code> <span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="83"><code>   <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="84"><code>   newChildren <span class="token operator">=</span> <span class="token function">arrayify</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="85"><code>   <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="86"><code><span class="token operator">-</span>  <span class="token keyword">const</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="87"><code><span class="token operator">+</span>  <span class="token keyword">let</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="88"><code>   <span class="token keyword">const</span> length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">,</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="89"><code>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="90"><code>     <span class="token keyword">const</span> oldChild <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="91"><code>     <span class="token keyword">let</span> newChild <span class="token operator">=</span> <span class="token function">narrow</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="92"><code>     <span class="token keyword">const</span> <span class="token punctuation">[</span>child<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="93"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> child <span class="token operator">!==</span> oldChild<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="94"><code>       <span class="token function">unmount</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="95"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="96"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="97"><code>     children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="98"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="99"><code>       values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="100"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="101"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="102"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="103"><code>   el<span class="token punctuation">.</span>_children <span class="token operator">=</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="104"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>values<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">isPromiseLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="105"><code><span class="token operator">+</span>    values <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="106"><code><span class="token operator">+</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> oldChild <span class="token keyword">of</span> oldChildren<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="107"><code><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="108"><code><span class="token operator">+</span>          <span class="token function">unmount</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="109"><code><span class="token operator">+</span>        <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="110"><code><span class="token operator">+</span>      <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="111"><code><span class="token operator">+</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="112"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="113"><code><span class="token operator">+</span>    <span class="token keyword">return</span> values<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">values</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">commit</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> <span class="token function">normalize</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="114"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="115"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="116"><code>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> oldChild <span class="token keyword">of</span> oldChildren<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="117"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="118"><code>       <span class="token function">unmount</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="119"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="120"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="121"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="122"><code>   <span class="token keyword">return</span> <span class="token function">commit</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> <span class="token function">normalize</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="123"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="124"><code>@@ <span class="token operator">-</span><span class="token number">321</span><span class="token punctuation">,</span><span class="token number">22</span> <span class="token operator">+</span><span class="token number">341</span><span class="token punctuation">,</span><span class="token number">25</span> @@ <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="125"><code> <span class="token keyword">function</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="126"><code>   <span class="token keyword">let</span> initial <span class="token operator">=</span> <span class="token operator">!</span>ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="127"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_isDone<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="128"><code>     <span class="token keyword">return</span> <span class="token function">getValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="129"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>initial<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="130"><code>     <span class="token keyword">const</span> value <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="131"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIteratorLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="132"><code>       ctx<span class="token punctuation">.</span>_iter <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="133"><code><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromiseLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="134"><code><span class="token operator">+</span>      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="135"><code><span class="token operator">+</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="136"><code>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="137"><code>       <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="138"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="139"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="140"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="141"><code>   <span class="token keyword">const</span> oldValue <span class="token operator">=</span> initial <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="142"><code>   <span class="token keyword">const</span> iteration <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="143"><code>   ctx<span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="144"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>iteration<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="145"><code>     ctx<span class="token punctuation">.</span>_isDone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="146"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="147"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="148"><code>   <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> iteration<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="149"><code> <span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-48" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-48'] = {"code":"--- a\u002Fcrank.js\n+++ b\u002Fcrank.js\n@@ -18,6 +18,10 @@ function isIteratorLike(value) {\n   return value != null && typeof value.next === \"function\";\n }\n\n+function isPromiseLike(value) {\n+  return value != null && typeof value.then === \"function\";\n+}\n+\n class Element {\n   constructor(tag, props) {\n     this.tag = tag;\n@@ -125,62 +129,66 @@ function getChildValues(el) {\n export class Renderer {\n   constructor() {\n     this._cache = new WeakMap();\n   }\n\n   render(children, root) {\n     let portal = this._cache.get(root);\n     if (portal) {\n       portal.props = {root, children};\n     } else {\n       portal = createElement(Portal, {root, children});\n       this._cache.set(root, portal);\n     }\n\n-    update(this, portal, portal);\n+    const result = update(this, portal, portal);\n+    if (isPromiseLike(result)) {\n+      return Promise.resolve(result).then(() =\u003E getChildValues(portal));\n+    }\n+\n     return getChildValues(portal);\n   }\n\n   create(el) {\n     return document.createElement(el.tag);\n   }\n\n   patch(el, node) {\n     for (let [name, value] of Object.entries(el.props)) {\n       if (name === \"children\") {\n         continue;\n       } else if (name === \"class\") {\n         name = \"className\";\n       }\n\n       if (name in node) {\n         node[name] = value;\n       } else {\n         node.setAttribute(name, value);\n       }\n     }\n   }\n\n   arrange(el, node, children) {\n     let child = node.firstChild;\n     for (const newChild of children) {\n       if (child === newChild) {\n         child = child.nextSibling;\n       } else if (typeof newChild === \"string\") {\n         if (child !== null && child.nodeType === Node.TEXT_NODE) {\n           child.nodeValue = newChild;\n           child = child.nextSibling;\n         } else {\n           node.insertBefore(document.createTextNode(newChild), child);\n         }\n       } else {\n         node.insertBefore(newChild, child);\n       }\n     }\n\n     while (child !== null) {\n       const nextSibling = child.nextSibling;\n       node.removeChild(child);\n       child = child.nextSibling;\n     }\n   }\n }\n@@ -228,29 +236,41 @@ function update(renderer, host, el) {\n function updateChildren(renderer, host, el, newChildren) {\n   const oldChildren = wrap(el._children);\n   newChildren = arrayify(newChildren);\n   const children = [];\n-  const values = [];\n+  let values = [];\n   const length = Math.max(oldChildren.length, newChildren.length);\n   for (let i = 0; i \u003C length; i++) {\n     const oldChild = oldChildren[i];\n     let newChild = narrow(newChildren[i]);\n     const [child, value] = diff(renderer, host, oldChild, newChild);\n     if (oldChild instanceof Element && child !== oldChild) {\n       unmount(renderer, oldChild);\n     }\n\n     children.push(child);\n     if (value) {\n       values.push(value);\n     }\n   }\n\n   el._children = unwrap(children);\n+  if (values.some((value) =\u003E isPromiseLike(value))) {\n+    values = Promise.all(values).finally(() =\u003E {\n+      for (const oldChild of oldChildren.slice(length)) {\n+        if (oldChild instanceof Element) {\n+          unmount(renderer, oldChild);\n+        }\n+      }\n+    });\n+\n+    return values.then((values) =\u003E commit(renderer, el, normalize(values)));\n+  }\n+\n   for (const oldChild of oldChildren.slice(length)) {\n     if (oldChild instanceof Element) {\n       unmount(renderer, oldChild);\n     }\n   }\n\n   return commit(renderer, el, normalize(values));\n }\n@@ -321,22 +341,25 @@ class Context {\n function stepCtx(ctx) {\n   let initial = !ctx._iter;\n   if (ctx._isDone) {\n     return getValue(ctx._el);\n   } else if (initial) {\n     const value = ctx._el.tag.call(ctx, ctx._el.props);\n     if (isIteratorLike(value)) {\n       ctx._iter = value;\n+    } else if (isPromiseLike(value)) {\n+      return Promise.resolve(value)\n+        .then((value) =\u003E updateCtxChildren(ctx, value));\n     } else {\n       return updateCtxChildren(ctx, value);\n     }\n   }\n\n   const oldValue = initial ? undefined : getValue(ctx._el);\n   const iteration = ctx._iter.next(oldValue);\n   ctx._isIterating = false;\n   if (iteration.done) {\n     ctx._isDone = true;\n   }\n\n   return updateCtxChildren(ctx, iteration.value);\n }","lang":"diff"};
		</script></div><p><a href="https://github.com/brainkim/crank-from-scratch/commit/72cdc766f14951ccda676df887eac6f5968c5fdc">Diff</a> <a href="https://github.com/brainkim/crank-from-scratch/blob/72cdc766f14951ccda676df887eac6f5968c5fdc/crank.js">File</a></p><p>Just as in the implementation of generator components, we detect async components in <code class="inline">stepCtx()</code> solely by the return value of the component call. While there may be ways to identify async functions without calling them, this would again be an anti-pattern, insofar as it would prevent functions which returned promises but did not use async syntax from being used as async components.</p><p>Async components are ‚Äúcontagious‚Äù in that they make ancestor components update and commit asynchronously as well. Additionally, any <code class="inline">refresh()</code> or <code class="inline">render()</code> calls which attempt to render async components will now return promises, and all DOM mutations are deferred until the async components have settled. This logic is implemented in the <code class="inline">updateChildren()</code> function, where we return a promise of the <code class="inline">commit()</code> call if any child values are detected to be promise-like.</p><h2 id="step-12-enqueuing">Step 12: Enqueuing</h2><p>Our async components work, but are problematic in that there can be multiple pending executions of the async component element at the same time. While this might not matter for the previously defined <code class="inline">DelayedGreeting</code> component, which uses a <code class="inline">setTimeout()</code>-based promise, this would be a problem for async components which make network requests or perform other I/O, insofar as your clients might inadvertently make too many concurrent requests over a short period of time. Do this too often and you may receive a sternly-worded email from a backend engineer!</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">UserGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;/api/whoami&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Hello <span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token string">&quot;color: red&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>NetworkedGreeting <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>NetworkedGreeting <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>NetworkedGreeting <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>NetworkedGreeting <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>NetworkedGreeting <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token comment">// Expected: Fires 1 or 2 network requests.</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code><span class="token comment">// Actual: Fires 5 network requests.</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-49" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-49'] = {"code":"async function UserGreeting() {\n  const res = await fetch(\"\u002Fapi\u002Fwhoami\");\n  const name = await res.text();\n  return \u003Cdiv\u003EHello \u003Cspan style=\"color: red\"\u003E{name}\u003C\u002Fspan\u003E\u003C\u002Fdiv\u003E;\n}\n\nrenderer.render(\u003CNetworkedGreeting \u002F\u003E, app);\nrenderer.render(\u003CNetworkedGreeting \u002F\u003E, app);\nrenderer.render(\u003CNetworkedGreeting \u002F\u003E, app);\nrenderer.render(\u003CNetworkedGreeting \u002F\u003E, app);\nrenderer.render(\u003CNetworkedGreeting \u002F\u003E, app);\n\n\u002F\u002F Expected: Fires 1 or 2 network requests.\n\u002F\u002F Actual: Fires 5 network requests.","lang":"js"};
		</script></div><p>What we want is a way to limit the concurrency of async component elements, so that there is at most, one pending call for the component element, at any point in time.</p><p>Before we continue, I‚Äôd like to introduce a visual notation for promises which we‚Äôll use for the rest of this essay. This is a promise.</p><p><img src="/static/promise.png" alt="A Promise"></p><p>These diagrams will get more complicated, I <em>promise</em>. But for now, know that the horizontal axis represents time, the left edge represents when the promise was created and the right edge represents when the promise settles.</p><p>Given this notation, we can represent multiple calls to an async function as follows.</p><p><img src="/static/multiple-promises.png" alt="Multiple Promises"></p><p>What we want for async components is a strategy which coalesces these promises so that there is only one pending run of a component element at any point in time. Visually, this would mean that none of these line segments overlap.</p><p>One possible technique we could use is <em>hitching,</em> where we resolve concurrent calls to the currently pending run, if one exists. We call this technique ‚Äúhitching‚Äù because it‚Äôs as though concurrent calls are hitching a ride on the pending call rather than creating a new promise.</p><p>This strategy would transform the previous diagram to the following one.</p><p><img src="/static/hitching.png" alt="Hitching"></p><p>The promises <code class="inline">B</code> and <code class="inline">C</code> resolve to the promise <code class="inline">A</code>, because they are created while <code class="inline">A</code> is still pending. We use a dotted line to indicate that these promises don‚Äôt actually perform any work, and we use the red trailing edge to indicate that these promises have resolved to some other call. Because <code class="inline">D</code> starts after <code class="inline">A</code> finishes, it is its own independent promise.</p><p>We can demonstrate the algorithm for this strategy by implementing it as a higher-order function which takes an async function and returns a modified function which exhibits this hitching behavior.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">function</span> <span class="token function">hitch</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">let</span> inflight<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">hitchWrapper</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inflight<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>      inflight <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>        inflight <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>    <span class="token keyword">return</span> inflight<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>  <span class="token punctuation">}</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-50" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-50'] = {"code":"function hitch(fn) {\n  let inflight;\n\n  return function hitchWrapper(...args) {\n    if (!inflight) {\n      inflight = Promise.resolve(fn(...args)).finally(() =\u003E {\n        inflight = undefined;\n      });\n    }\n\n    return inflight;\n  };\n}","lang":"js"};
		</script></div><p>The <code class="inline">hitch()</code> function defines an <code class="inline">inflight</code> variable in the closure of the returned wrapper function. When called, the wrapper function checks the inflight variable, and if it is not set, assigns to it a promise which resolves to a call to the original function. The wrapper function returns this inflight promise, regardless of whether or not it was set by the call. Finally, we use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/finally"><code class="inline">Promise.prototype.finally()</code></a> to clean up the inflight promise when it settles, so that new calls to the original function can be made.</p><p>While this approach reduces the number of concurrent runs of an async function to one, it wouldn‚Äôt be correct for our use-case, insofar as by the time all promises settled, we might not yet have had an async run with the latest props for each component. Instead, we need a strategy which <em>enqueues</em> runs of async component functions so that when all promises settle, the element tree and rendered values reflect the latest props and state. We can tweak the <code class="inline">hitch()</code> function above as the alternative higher-order function <code class="inline">enqueue()</code> to demonstrate the logic we want.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">function</span> <span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">let</span> inflight<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">let</span> enqueued<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>  <span class="token keyword">let</span> latestArgs<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">enqueueWrapper</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>    latestArgs <span class="token operator">=</span> args<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inflight<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>      inflight <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>latestArgs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>        inflight <span class="token operator">=</span> enqueued<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>        enqueued <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>      <span class="token keyword">return</span> inflight<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enqueued<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code>      enqueued <span class="token operator">=</span> inflight<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>latestArgs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code>        inflight <span class="token operator">=</span> enqueued<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code>        enqueued <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code>    <span class="token keyword">return</span> enqueued<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code>  <span class="token punctuation">}</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-51" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-51'] = {"code":"function enqueue(fn) {\n  let inflight;\n  let enqueued;\n  let latestArgs;\n  return function enqueueWrapper(...args) {\n    latestArgs = args;\n    if (!inflight) {\n      inflight = Promise.resolve(fn(...latestArgs)).finally(() =\u003E {\n        inflight = enqueued;\n        enqueued = undefined;\n      });\n\n      return inflight;\n    } else if (!enqueued) {\n      enqueued = inflight.then(() =\u003E fn(...latestArgs)).finally(() =\u003E {\n        inflight = enqueued;\n        enqueued = undefined;\n      });\n    }\n\n    return enqueued;\n  };\n}","lang":"js"};
		</script></div><p>We‚Äôve added two more variables to the wrapper function‚Äôs scope, <code class="inline">enqueued</code> and <code class="inline">latestArgs</code> . The returned wrapper function first checks if there is an inflight promise, and creates and returns this inflight promise if none exists. If an inflight promise does exist, the wrapper function checks if there is an <em>enqueued</em> promise of the original function, and creates it if it doesn‚Äôt exists. This enqueued run first waits for the <code class="inline">inflight</code> run to fulfill before calling the function again, and calls the function with <code class="inline">latestArgs</code>, which we set to the latest call‚Äôs arguments whenever the wrapper fuction is called. We return the enqueued promise whether or not the current wrapper call had created it. Finally, we use <code class="inline">Promise.prototype.finally()</code> on both the inflight and enqueued promises to advance and clear the queue.</p><p>This strategy can be expressed as the following promise diagram.</p><p><img src="/static/enqueuing.png" alt="Enqueuing"></p><p>In this diagram, because <code class="inline">B</code> and <code class="inline">C</code> are created while <code class="inline">A</code> is pending, we enqueue another run. However, only <code class="inline">C</code> actually does work, because by the time <code class="inline">A</code> finishes, we only re-invoke the function with <code class="inline">C</code>‚Äôs arguments, while <code class="inline">B</code>‚Äôs arguments would have been overwritten. This is a useful behavior for async components, because we don‚Äôt really care about obsolete props or element trees. Lastly, <code class="inline">D</code> starts while <code class="inline">C</code> is pending, so we schedule another run for <code class="inline">D</code>. Note that the original function is not invoked until the current run settles, so we again have a situation where there is only one concurrent run of the original function at a time.</p><h3 id="implementation">Implementation</h3><p>Here is the implementation of this enqueuing strategy for components.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>@@ <span class="token operator">-</span><span class="token number">307</span><span class="token punctuation">,</span><span class="token number">33</span> <span class="token operator">+</span><span class="token number">307</span><span class="token punctuation">,</span><span class="token number">35</span> @@ <span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_renderer <span class="token operator">=</span> renderer<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_host <span class="token operator">=</span> host<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_el <span class="token operator">=</span> el<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_iter <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_schedules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_inflight <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_enqueued <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>     <span class="token comment">// flags</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isUpdating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isDone <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code>   <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code><span class="token operator">-</span>    <span class="token keyword">return</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token function">runCtx</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code>   <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_schedules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><code>   <span class="token operator">*</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="29"><code>     <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isDone<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="30"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="31"><code>         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Context iterated twice without a yield&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="32"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="33"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="34"><code>       <span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="35"><code>       <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="36"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="37"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="38"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="39"><code>@@ <span class="token operator">-</span><span class="token number">364</span><span class="token punctuation">,</span><span class="token number">9</span> <span class="token operator">+</span><span class="token number">366</span><span class="token punctuation">,</span><span class="token number">32</span> @@ <span class="token keyword">function</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="40"><code>   <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> iteration<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="41"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="42"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="43"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">advanceCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="44"><code><span class="token operator">+</span>  ctx<span class="token punctuation">.</span>_inflight <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_enqueued<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="45"><code><span class="token operator">+</span>  ctx<span class="token punctuation">.</span>_enqueued <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="46"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="47"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="48"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">runCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="49"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_inflight<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="50"><code><span class="token operator">+</span>    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="51"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromiseLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="52"><code><span class="token operator">+</span>      value <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">advanceCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="53"><code><span class="token operator">+</span>      ctx<span class="token punctuation">.</span>_inflight <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="54"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="55"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="56"><code><span class="token operator">+</span>    <span class="token keyword">return</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="57"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_enqueued<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="58"><code><span class="token operator">+</span>    ctx<span class="token punctuation">.</span>_enqueued <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_inflight</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="59"><code><span class="token operator">+</span>      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="60"><code><span class="token operator">+</span>      <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">advanceCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="61"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="62"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="63"><code><span class="token operator">+</span>  <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>_enqueued<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="64"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="65"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="66"><code> <span class="token keyword">function</span> <span class="token function">updateCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="67"><code>   ctx<span class="token punctuation">.</span>_isUpdating <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="68"><code><span class="token operator">-</span>  <span class="token keyword">return</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="69"><code><span class="token operator">+</span>  <span class="token keyword">return</span> <span class="token function">runCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="70"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="71"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="72"><code> <span class="token keyword">function</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-52" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-52'] = {"code":"--- a\u002Fcrank.js\n+++ b\u002Fcrank.js\n@@ -307,33 +307,35 @@ function unmount(renderer, el) {\n class Context {\n   constructor(renderer, host, el) {\n     this._renderer = renderer;\n     this._host = host;\n     this._el = el;\n     this._iter = undefined;\n     this._schedules = new Set();\n+    this._inflight = undefined;\n+    this._enqueued = undefined;\n\n     \u002F\u002F flags\n     this._isUpdating = false;\n     this._isIterating = false;\n     this._isDone = false;\n   }\n\n   refresh() {\n-    return stepCtx(this);\n+    return runCtx(this);\n   }\n\n   schedule(callback) {\n     this._schedules.add(callback);\n   }\n\n   *[Symbol.iterator]() {\n     while (!this._isDone) {\n       if (this._isIterating) {\n         throw new Error(\"Context iterated twice without a yield\");\n       }\n\n       this._isIterating = true;\n       yield this._el.props;\n     }\n   }\n }\n@@ -364,9 +366,32 @@ function stepCtx(ctx) {\n   return updateCtxChildren(ctx, iteration.value);\n }\n\n+function advanceCtx(ctx) {\n+  ctx._inflight = ctx._enqueued;\n+  ctx._enqueued = undefined;\n+}\n+\n+function runCtx(ctx) {\n+  if (!ctx._inflight) {\n+    let value = stepCtx(ctx);\n+    if (isPromiseLike(value)) {\n+      value = value.finally(() =\u003E advanceCtx(ctx));\n+      ctx._inflight = value;\n+    }\n+\n+    return value;\n+  } else if (!ctx._enqueued) {\n+    ctx._enqueued = ctx._inflight\n+      .then(() =\u003E stepCtx(ctx))\n+      .finally(() =\u003E advanceCtx(ctx));\n+  }\n+\n+  return ctx._enqueued;\n+}\n+\n function updateCtx(ctx) {\n   ctx._isUpdating = true;\n-  return stepCtx(ctx);\n+  return runCtx(ctx);\n }\n\n function updateCtxChildren(ctx, children) {","lang":"diff"};
		</script></div><p><a href="https://github.com/brainkim/crank-from-scratch/commit/66a9459bd2fc11a2a3bd7bae9818394ad3902e67">Diff</a> <a href="https://github.com/brainkim/crank-from-scratch/blob/66a9459bd2fc11a2a3bd7bae9818394ad3902e67/crank.js">File</a></p><p>We define another context function <code class="inline">runCtx()</code>, which is where the enqueuing behavior is implemented, and call this function instead of <code class="inline">stepCtx()</code> in the <code class="inline">refresh()</code> method and the <code class="inline">updateCtx()</code> function. Rather than implementing the enqueuing algorithm with a higher-order function, we store the inflight and enqueued promises directly on component context. We do this because we‚Äôll need to modify the algorithm in various ways for later steps.</p><p>Because the enqueuing state is stored on contexts, enqueuing only happens for components which are rerendered. If a different element is rendered into an old component element‚Äôs position, the old context is blown away, so no async enqueuing would occur. This means that element enqueuing happens based on the same element diffing algorithm which governs DOM node re-use and stateful components.</p><h2 id="step-13-async-children">Step 13: Async Children</h2><p>Another way to think about the enqueuing behavior in the previous step is that components are ‚Äúblocked‚Äù from updates while they‚Äôre pending. However, the enqueuing algorithm we‚Äôve implemented so far might ‚Äúover-block,‚Äù in the sense that components currently block not only for their own async executions, but also for their children‚Äôs async executions as well. This enqueuing behavior will, for instance, cause a synchronous function component with async children to block for the duration of its children‚Äôs async rendering time, even though there really isn‚Äôt a need for sync function components to block at all.</p><p>Therefore, we need a way to distinguish a component‚Äôs own execution time from the rendering time of its children, and block the component accordingly. For maximal concurrency, a sync function component should never block for any reason, while an async function component should only block while the async function itself is executing, but not for the rendering of its children.</p><p>On the other hand, the API we created for sync generator components in a previous step, where we pass the rendered value of the generator component back in as its yield result, creates an expectation that sync generator components only resume when the previous children have fully rendered. If we broke this expectation, the value passed back in might be <code class="inline">undefined</code>, as the generator component‚Äôs children might still be pending. Therefore, we make sync generator components block while their children are asynchronously rendering.</p><h3 id="implementation">Implementation</h3><p>To implement this behavior, we‚Äôll need to update the <code class="inline">stepCtx()</code> function so that it returns a tuple: the first member is a possible promise which indicates the amount of time the component should ‚Äúblock‚Äù for, and the second is the actual value for the current render of the component.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>@@ <span class="token operator">-</span><span class="token number">307</span><span class="token punctuation">,</span><span class="token number">35</span> <span class="token operator">+</span><span class="token number">307</span><span class="token punctuation">,</span><span class="token number">37</span> @@ <span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_renderer <span class="token operator">=</span> renderer<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_host <span class="token operator">=</span> host<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_el <span class="token operator">=</span> el<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_iter <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_schedules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code><span class="token operator">-</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_inflight <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code><span class="token operator">-</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_enqueued <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_inflightBlock <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_inflightValue <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_enqueuedBlock <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_enqueuedValue <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code>     <span class="token comment">// flags</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isUpdating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isDone <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code>   <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code>     <span class="token keyword">return</span> <span class="token function">runCtx</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><code>   <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_schedules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="29"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="30"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="31"><code>   <span class="token operator">*</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="32"><code>     <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isDone<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="33"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="34"><code>         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Context iterated twice without a yield&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="35"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="36"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="37"><code>       <span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="38"><code>       <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="39"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="40"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="41"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="42"><code>@@ <span class="token operator">-</span><span class="token number">343</span><span class="token punctuation">,</span><span class="token number">50</span> <span class="token operator">+</span><span class="token number">345</span><span class="token punctuation">,</span><span class="token number">66</span> @@ <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="43"><code> <span class="token keyword">function</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="44"><code>   <span class="token keyword">let</span> initial <span class="token operator">=</span> <span class="token operator">!</span>ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="45"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_isDone<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="46"><code>     <span class="token keyword">return</span> <span class="token function">getValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="47"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>initial<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="48"><code>     <span class="token keyword">const</span> value <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="49"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIteratorLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="50"><code>       ctx<span class="token punctuation">.</span>_iter <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="51"><code>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromiseLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="52"><code><span class="token operator">-</span>      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="53"><code><span class="token operator">-</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="54"><code><span class="token operator">+</span>      <span class="token keyword">const</span> block <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="55"><code><span class="token operator">+</span>      <span class="token keyword">return</span> <span class="token punctuation">[</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="56"><code><span class="token operator">+</span>        block<span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="57"><code><span class="token operator">+</span>        block<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="58"><code><span class="token operator">+</span>      <span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="59"><code>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="60"><code><span class="token operator">-</span>      <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="61"><code><span class="token operator">+</span>      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="62"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="63"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="64"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="65"><code>   <span class="token keyword">const</span> oldValue <span class="token operator">=</span> initial <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="66"><code>   <span class="token keyword">const</span> iteration <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="67"><code>   ctx<span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="68"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>iteration<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="69"><code>     ctx<span class="token punctuation">.</span>_isDone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="70"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="71"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="72"><code><span class="token operator">-</span>  <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> iteration<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="73"><code><span class="token operator">+</span>  <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> iteration<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="74"><code><span class="token operator">+</span>  <span class="token keyword">return</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="75"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="76"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="77"><code> <span class="token keyword">function</span> <span class="token function">advanceCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="78"><code><span class="token operator">-</span>  ctx<span class="token punctuation">.</span>_inflight <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_enqueued<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="79"><code><span class="token operator">-</span>  ctx<span class="token punctuation">.</span>_enqueued <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="80"><code><span class="token operator">+</span>  ctx<span class="token punctuation">.</span>_inflightBlock <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_enqueuedBlock<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="81"><code><span class="token operator">+</span>  ctx<span class="token punctuation">.</span>_inflightValue <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_enqueuedValue<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="82"><code><span class="token operator">+</span>  ctx<span class="token punctuation">.</span>_enqueuedBlock <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="83"><code><span class="token operator">+</span>  ctx<span class="token punctuation">.</span>_enqueuedValue <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="84"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="85"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="86"><code> <span class="token keyword">function</span> <span class="token function">runCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="87"><code><span class="token operator">-</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_inflight<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="88"><code><span class="token operator">-</span>    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="89"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_inflightBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="90"><code><span class="token operator">+</span>    <span class="token keyword">let</span> <span class="token punctuation">[</span>block<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="91"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromiseLike</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="92"><code><span class="token operator">+</span>      block <span class="token operator">=</span> block<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">advanceCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="93"><code><span class="token operator">+</span>      ctx<span class="token punctuation">.</span>_inflightBlock <span class="token operator">=</span> block<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="94"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="95"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="96"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromiseLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="97"><code><span class="token operator">-</span>      value <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">advanceCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="98"><code><span class="token operator">-</span>      ctx<span class="token punctuation">.</span>_inflight <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="99"><code><span class="token operator">+</span>      ctx<span class="token punctuation">.</span>_inflightValue <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="100"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="101"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="102"><code>     <span class="token keyword">return</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="103"><code><span class="token operator">-</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_enqueued<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="104"><code><span class="token operator">-</span>    ctx<span class="token punctuation">.</span>_enqueued <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_inflight</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="105"><code><span class="token operator">-</span>      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="106"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_enqueuedBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="107"><code><span class="token operator">+</span>    <span class="token keyword">let</span> resolve<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="108"><code><span class="token operator">+</span>    ctx<span class="token punctuation">.</span>_enqueuedBlock <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_inflightBlock</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="109"><code><span class="token operator">+</span>      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="110"><code><span class="token operator">+</span>        <span class="token keyword">const</span> <span class="token punctuation">[</span>block<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="111"><code><span class="token operator">+</span>        <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="112"><code><span class="token operator">+</span>        <span class="token keyword">return</span> block<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="113"><code><span class="token operator">+</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="114"><code>       <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">advanceCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="115"><code><span class="token operator">+</span>    ctx<span class="token punctuation">.</span>_enqueuedValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve1</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>resolve <span class="token operator">=</span> resolve1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="116"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="117"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="118"><code><span class="token operator">-</span>  <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>_enqueued<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="119"><code><span class="token operator">+</span>  <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>_enqueuedValue<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="120"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="121"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="122"><code> <span class="token keyword">function</span> <span class="token function">updateCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-53" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-53'] = {"code":"--- a\u002Fcrank.js\n+++ b\u002Fcrank.js\n@@ -307,35 +307,37 @@ function unmount(renderer, el) {\n class Context {\n   constructor(renderer, host, el) {\n     this._renderer = renderer;\n     this._host = host;\n     this._el = el;\n     this._iter = undefined;\n     this._schedules = new Set();\n-    this._inflight = undefined;\n-    this._enqueued = undefined;\n+    this._inflightBlock = undefined;\n+    this._inflightValue = undefined;\n+    this._enqueuedBlock = undefined;\n+    this._enqueuedValue = undefined;\n\n     \u002F\u002F flags\n     this._isUpdating = false;\n     this._isIterating = false;\n     this._isDone = false;\n   }\n\n   refresh() {\n     return runCtx(this);\n   }\n\n   schedule(callback) {\n     this._schedules.add(callback);\n   }\n\n   *[Symbol.iterator]() {\n     while (!this._isDone) {\n       if (this._isIterating) {\n         throw new Error(\"Context iterated twice without a yield\");\n       }\n\n       this._isIterating = true;\n       yield this._el.props;\n     }\n   }\n }\n@@ -343,50 +345,66 @@ class Context {\n function stepCtx(ctx) {\n   let initial = !ctx._iter;\n   if (ctx._isDone) {\n     return getValue(ctx._el);\n   } else if (initial) {\n     const value = ctx._el.tag.call(ctx, ctx._el.props);\n     if (isIteratorLike(value)) {\n       ctx._iter = value;\n     } else if (isPromiseLike(value)) {\n-      return Promise.resolve(value)\n-        .then((value) =\u003E updateCtxChildren(ctx, value));\n+      const block = Promise.resolve(value);\n+      return [\n+        block,\n+        block.then((value) =\u003E updateCtxChildren(ctx, value)),\n+      ];\n     } else {\n-      return updateCtxChildren(ctx, value);\n+      return [undefined, updateCtxChildren(ctx, value)];\n     }\n   }\n\n   const oldValue = initial ? undefined : getValue(ctx._el);\n   const iteration = ctx._iter.next(oldValue);\n   ctx._isIterating = false;\n   if (iteration.done) {\n     ctx._isDone = true;\n   }\n\n-  return updateCtxChildren(ctx, iteration.value);\n+  const value = updateCtxChildren(ctx, iteration.value);\n+  return [value, value];\n }\n\n function advanceCtx(ctx) {\n-  ctx._inflight = ctx._enqueued;\n-  ctx._enqueued = undefined;\n+  ctx._inflightBlock = ctx._enqueuedBlock;\n+  ctx._inflightValue = ctx._enqueuedValue;\n+  ctx._enqueuedBlock = undefined;\n+  ctx._enqueuedValue = undefined;\n }\n\n function runCtx(ctx) {\n-  if (!ctx._inflight) {\n-    let value = stepCtx(ctx);\n+  if (!ctx._inflightBlock) {\n+    let [block, value] = stepCtx(ctx);\n+    if (isPromiseLike(block)) {\n+      block = block.finally(() =\u003E advanceCtx(ctx));\n+      ctx._inflightBlock = block;\n+    }\n+\n     if (isPromiseLike(value)) {\n-      value = value.finally(() =\u003E advanceCtx(ctx));\n-      ctx._inflight = value;\n+      ctx._inflightValue = value;\n     }\n\n     return value;\n-  } else if (!ctx._enqueued) {\n-    ctx._enqueued = ctx._inflight\n-      .then(() =\u003E stepCtx(ctx))\n+  } else if (!ctx._enqueuedBlock) {\n+    let resolve;\n+    ctx._enqueuedBlock = ctx._inflightBlock\n+      .then(() =\u003E {\n+        const [block, value] = stepCtx(ctx);\n+        resolve(value);\n+        return block;\n+      })\n       .finally(() =\u003E advanceCtx(ctx));\n+    ctx._enqueuedValue = new Promise((resolve1) =\u003E (resolve = resolve1));\n   }\n\n-  return ctx._enqueued;\n+  return ctx._enqueuedValue;\n }\n\n function updateCtx(ctx) {","lang":"diff"};
		</script></div><p><a href="https://github.com/brainkim/crank-from-scratch/commit/caf7632e27d89236b06855a5c63b8e812c060a66">Diff</a> <a href="https://github.com/brainkim/crank-from-scratch/blob/caf7632e27d89236b06855a5c63b8e812c060a66/crank.js">File</a></p><p>We keep the inflight/enqueued pattern from the previous step, except now we advance the queue based on the blocking portion of the render. A promise diagram for this algorithm might look like this.</p><p><img src="/static/partial-enqueuing.png" alt="Partial Enqueuing"></p><p>The blue segments represent the duration for which the component is blocked, while the blue + black segments represent the duration for the entire render. As you can see, this allows for greater concurrency with regard to rendering, while still limiting the number of concurrent runs for each individual async component element to one.</p><h2 id="step-14-chasing">Step 14: Chasing</h2><p>Before we continue, we need to deal with a race condition with regard to async rendering. Although we‚Äôve implemented enqueuing logic for when we rerender the <em>same</em> async components, if we were to render different element trees which settled out of order, we might have earlier element trees render after later ones.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">DelayedGreeting</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Hello <span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token string">&quot;color: red&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code><span class="token keyword">const</span> p <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>DelayedGreeting name<span class="token operator">=</span><span class="token string">&quot;World&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Never mind<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;div&gt;Never mind&lt;/div&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code><span class="token keyword">await</span> p<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code><span class="token comment">// Expected: &lt;div&gt;Never mind&lt;/div&gt;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code><span class="token comment">// Actual: &lt;div&gt;Hello &lt;span style=&quot;color: red&quot;&gt;World&lt;/span&gt;&lt;/div&gt;</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-54" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-54'] = {"code":"async function DelayedGreeting({name}) {\n  await new Promise((resolve) =\u003E setTimeout(resolve, 2000));\n  return \u003Cdiv\u003EHello \u003Cspan style=\"color: red\"\u003E{name}\u003C\u002Fspan\u003E\u003C\u002Fdiv\u003E;\n}\n\nconst p = renderer.render(\u003CDelayedGreeting name=\"World\"\u002F\u003E, app);\nrenderer.render(\u003Cdiv\u003ENever mind\u003C\u002Fdiv\u003E, app);\nconsole.log(app.innerHTML); \u002F\u002F \u003Cdiv\u003ENever mind\u003C\u002Fdiv\u003E\nawait p;\nconsole.log(app.innerHTML);\n\u002F\u002F Expected: \u003Cdiv\u003ENever mind\u003C\u002Fdiv\u003E\n\u002F\u002F Actual: \u003Cdiv\u003EHello \u003Cspan style=\"color: red\"\u003EWorld\u003C\u002Fspan\u003E\u003C\u002Fdiv\u003E\n","lang":"jsx"};
		</script></div><p>We want rendering to ignore outdated renders just as async component enqueuing ignores outdated props and children. To achieve this, we use another promise technique called <em>chasing.</em> Chasing involves racing the current call of an async function with the next call, for every call. Visually, we can represent chasing like so.</p><p><img src="/static/chasing.png" alt="Chasing"></p><p>In the diagram, the <code class="inline">B</code> promise takes longer to settle than the <code class="inline">C</code> promise, so the <code class="inline">B</code> promise is cut off and made to resolve to the <code class="inline">C</code> promise. We can represent this algorithm as the following higher-order function.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">function</span> <span class="token function">chase</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">let</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">chaseWrapper</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>    <span class="token keyword">let</span> resolve1<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>    <span class="token keyword">const</span> next <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve2</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>resolve1 <span class="token operator">=</span> resolve2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>    <span class="token keyword">const</span> result <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span> next<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>    <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>    resolve <span class="token operator">=</span> resolve1<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>    <span class="token keyword">return</span> result<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>  <span class="token punctuation">}</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-55" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-55'] = {"code":"function chase(fn) {\n  let resolve = () =\u003E {};\n\n  return function chaseWrapper(...args) {\n    let resolve1;\n    const next = new Promise((resolve2) =\u003E (resolve1 = resolve2));\n    const result = Promise.race([fn(...args), next]);\n    resolve(result);\n    resolve = resolve1;\n    return result;\n  };\n}","lang":"js"};
		</script></div><p>The <code class="inline">chase</code> function returns a wrapper function which calls the original function, but races each call with the next. We achieve this by creating a promise with the <code class="inline">Promise</code> constructor for each call, and retaining the <code class="inline">resolve</code> function of this promise in the wrapper function‚Äôs closure. We then call the previous <code class="inline">resolve</code> function with the result of the next race, and swap in the next <code class="inline">resolve</code> function for future calls.</p><p>The part of this algorithm that will probably hurt your brain is that we don‚Äôt just call the previous <code class="inline">resolve</code> function with the next result, but with a <em>race</em> of the next result and the result after; in effect, this means that all calls are raced not only with their immediate successor, but with every future call as well. This is possible because the <code class="inline">resolve</code> function can be called with a promise, a feature which not many JavaScript developers know about or use.</p><p>The cool part about this strategy is that it chains, so that when any call settles, we know for a fact that <em>all</em> previous calls have settled as well. You can prove this mathematically with a <a href="https://en.wikipedia.org/wiki/Mathematical_induction">proof by induction</a>, or visually with a promise diagram.</p><p><img src="/static/chained-chasing.png" alt="Chained Chasing"></p><p>Proving that this algorithm works to settle all previous promises is as simple as drawing a vertical line upwards from the end of any promise in any promise diagram.</p><h3 id="implementation">Implementation</h3><p>We use this chasing strategy in Crank by chasing the pending child values of an element with future child values for the element. We do this for every element, regardless of whether it is a host or component element.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>@@ <span class="token operator">-</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">13</span> <span class="token operator">+</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">14</span> @@ <span class="token keyword">function</span> <span class="token function">isPromiseLike</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code> <span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_node <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_children <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_ctx <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_onvalues <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>     <span class="token comment">// flags</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code>@@ <span class="token operator">-</span><span class="token number">236</span><span class="token punctuation">,</span><span class="token number">42</span> <span class="token operator">+</span><span class="token number">237</span><span class="token punctuation">,</span><span class="token number">55</span> @@ <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code> <span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code>   <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code>   newChildren <span class="token operator">=</span> <span class="token function">arrayify</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code>   <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code>   <span class="token keyword">let</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code>   <span class="token keyword">const</span> length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">,</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><code>     <span class="token keyword">const</span> oldChild <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><code>     <span class="token keyword">let</span> newChild <span class="token operator">=</span> <span class="token function">narrow</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><code>     <span class="token keyword">const</span> <span class="token punctuation">[</span>child<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> child <span class="token operator">!==</span> oldChild<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="29"><code>       <span class="token function">unmount</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="30"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="31"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="32"><code>     children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="33"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="34"><code>       values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="35"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="36"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="37"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="38"><code>   el<span class="token punctuation">.</span>_children <span class="token operator">=</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="39"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>values<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">isPromiseLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="40"><code>     values <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="41"><code>       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> oldChild <span class="token keyword">of</span> oldChildren<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="42"><code>         <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="43"><code>           <span class="token function">unmount</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="44"><code>         <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="45"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="46"><code>     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="47"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="48"><code><span class="token operator">+</span>    <span class="token keyword">let</span> onvalues<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="49"><code><span class="token operator">+</span>    <span class="token keyword">const</span> nextValues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>onvalues <span class="token operator">=</span> resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="50"><code><span class="token operator">+</span>    values <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>values<span class="token punctuation">,</span> nextValues<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="51"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>_onvalues<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="52"><code><span class="token operator">+</span>      el<span class="token punctuation">.</span><span class="token function">_onvalues</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="53"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="54"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="55"><code><span class="token operator">+</span>    el<span class="token punctuation">.</span>_onvalues <span class="token operator">=</span> onvalues<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="56"><code>     <span class="token keyword">return</span> values<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">values</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">commit</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> <span class="token function">normalize</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="57"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="58"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="59"><code>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> oldChild <span class="token keyword">of</span> oldChildren<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="60"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="61"><code>       <span class="token function">unmount</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="62"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="63"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="64"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="65"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>_onvalues<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="66"><code><span class="token operator">+</span>    el<span class="token punctuation">.</span><span class="token function">_onvalues</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="67"><code><span class="token operator">+</span>    el<span class="token punctuation">.</span>_onvalues <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="68"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="69"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="70"><code>   <span class="token keyword">return</span> <span class="token function">commit</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> <span class="token function">normalize</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="71"><code> <span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-56" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-56'] = {"code":"--- a\u002Fcrank.js\n+++ b\u002Fcrank.js\n@@ -25,13 +25,14 @@ function isPromiseLike(value) {\n class Element {\n   constructor(tag, props) {\n     this.tag = tag;\n     this.props = props;\n\n     this._node = undefined;\n     this._children = undefined;\n     this._ctx = undefined;\n+    this._onvalues = undefined;\n\n     \u002F\u002F flags\n     this._isMounted = false;\n   }\n }\n@@ -236,42 +237,55 @@ function update(renderer, host, el) {\n function updateChildren(renderer, host, el, newChildren) {\n   const oldChildren = wrap(el._children);\n   newChildren = arrayify(newChildren);\n   const children = [];\n   let values = [];\n   const length = Math.max(oldChildren.length, newChildren.length);\n   for (let i = 0; i \u003C length; i++) {\n     const oldChild = oldChildren[i];\n     let newChild = narrow(newChildren[i]);\n     const [child, value] = diff(renderer, host, oldChild, newChild);\n     if (oldChild instanceof Element && child !== oldChild) {\n       unmount(renderer, oldChild);\n     }\n\n     children.push(child);\n     if (value) {\n       values.push(value);\n     }\n   }\n\n   el._children = unwrap(children);\n   if (values.some((value) =\u003E isPromiseLike(value))) {\n     values = Promise.all(values).finally(() =\u003E {\n       for (const oldChild of oldChildren.slice(length)) {\n         if (oldChild instanceof Element) {\n           unmount(renderer, oldChild);\n         }\n       }\n     });\n\n+    let onvalues;\n+    const nextValues = new Promise((resolve) =\u003E (onvalues = resolve));\n+    values = Promise.race([values, nextValues]);\n+    if (el._onvalues) {\n+      el._onvalues(values);\n+    }\n+\n+    el._onvalues = onvalues;\n     return values.then((values) =\u003E commit(renderer, el, normalize(values)));\n   }\n\n   for (const oldChild of oldChildren.slice(length)) {\n     if (oldChild instanceof Element) {\n       unmount(renderer, oldChild);\n     }\n   }\n\n+  if (el._onvalues) {\n+    el._onvalues(values);\n+    el._onvalues = undefined;\n+  }\n+\n   return commit(renderer, el, normalize(values));\n }","lang":"diff"};
		</script></div><p><a href="https://github.com/brainkim/crank-from-scratch/commit/f4ab9d5a2738026ce52c5bc4b82de3529aad34bc">Diff</a> <a href="https://github.com/brainkim/crank-from-scratch/blob/f4ab9d5a2738026ce52c5bc4b82de3529aad34bc/crank.js">File</a></p><p>Once again we don‚Äôt use a higher-order function, but retain the <code class="inline">resolve()</code> function of future child values directly on elements under the property <code class="inline">onvalues</code>. We set <code class="inline">onvalues</code> whenever we detect async rendering to have occurred below the element, and call it whenever the element has new child values.</p><p><strong>Notes:</strong></p><ol><li>Because we don‚Äôt cancel earlier renders of an element‚Äôs children when later renders fulfill, we may end up calling <code class="inline">commit()</code> with the same values multiple times in the case where a later render fulfills first. This isn‚Äôt really an issue because concurrent renderings don‚Äôt happen too often, and because the <code class="inline">commit()</code> function is <a href="https://en.wikipedia.org/wiki/Idempotence"><em>idempotent</em></a>, so calling it multiple times with the same element and values will have no effect.</li></ol><h2 id="step-15-async-generator-components">Step 15: Async Generator Components</h2><p>The examples of concurrent rendering which we‚Äôve seen so far have all worked based on top-level <code class="inline">render</code> calls. Furthermore, the behavior of sync generator components, which block based on their children‚Äôs async rendering time, means that we can‚Äôt call <code class="inline">refresh()</code> from a sync generator component to perform concurrent renderings. Therefore, we‚Äôll use <em>async generator functions</em> as a final component type to allow components to concurrently render multiple element trees in the same position.</p><p>To review, an async generator function is another function syntax which combines both the <code class="inline">*</code> token from generator functions, and the <code class="inline">async</code> keyword from async functions (<code class="inline">async function *</code>). This allows us to both <code class="inline">yield</code> and <code class="inline">await</code> in the same function. Async generators also come with async equivalents of iterators, iterables and <code class="inline">for‚Ä¶of</code> syntax. Async generators are <em>async iterators</em> in that they implement the <code class="inline">next()</code>, <code class="inline">return()</code> and <code class="inline">throw()</code> methods, except instead of returning iterations as with sync iterators, these methods now return promises which resolve to iterations. Additionally, async generators are <em>async iterable</em> insofar as it implements the <code class="inline">[Symbol.asyncIterator]()</code> method. Finally, async iterables can be iterated using <code class="inline">for await‚Ä¶of</code>, a special for loop syntax which awaits each iteration of an async iterator. This syntax may only be used in async functions, just like <code class="inline">await</code>.</p><p>By writing async generator functions which yield element trees, we can combine both the statefulness of generator functions and the convenience of async/await in the same component. Additionally, we‚Äôll make component contexts <em>async iterables</em> of props, so that async generator components can respond to updates asynchronously with a <code class="inline">for await‚Ä¶of</code> loops. Importantly, this allows us to resume async generator components continuously, so that rather than suspending on each yield, we can write code both before and after the yields of element trees.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">ContinuousGreeting</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Before render&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>    <span class="token keyword">const</span> div <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Hello <span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token string">&quot;color: red&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;After render&quot;</span><span class="token punctuation">,</span> div<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-57" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-57'] = {"code":"async function* ContinuousGreeting({name}) {\n  for await ({} of this) {\n    console.log(\"Before render\");\n    const div = yield \u003Cdiv\u003EHello \u003Cspan style=\"color: red\"\u003E{name}\u003C\u002Fspan\u003E\u003C\u002Fdiv\u003E;\n    console.log(\"After render\", div);\n  }\n}","lang":"jsx"};
		</script></div><p>For each render of <code class="inline">ContinuousGreeting</code>, both the pre- and post- <code class="inline"> console.log</code> calls execute. Note that assigning the yield operation (here to the variable <code class="inline">div</code>) becomes more useful than it was for sync generator components. The <code class="inline">for await ({} of this)</code> is how we can have the async generator continuously resume but still suspend when there are no new updates or refreshes.</p><p>Async generator components are the most powerful component syntax, because they can await promises, respond to updates as async values themselves, and even yield multiple element trees concurrently. This allows us to write code like the following.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">LoadingIndicator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Loading‚Ä¶<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">RandomDelayGreeting</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Hello <span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token string">&quot;color: red&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">LoadingGreeting</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span> <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>    <span class="token keyword">yield</span> <span class="token operator">&lt;</span>LoadingIndicator <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>    <span class="token keyword">yield</span> <span class="token operator">&lt;</span>RandomDelayGreeting name<span class="token operator">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-58" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-58'] = {"code":"async function LoadingIndicator() {\n  await new Promise((resolve) =\u003E setTimeout(resolve, 1000));\n  return \u003Cdiv\u003ELoading‚Ä¶\u003C\u002Fdiv\u003E;\n}\n\nasync function RandomDelayGreeting({name}) {\n  await new Promise((resolve) =\u003E setTimeout(resolve, Math.random() * 4000));\n  return \u003Cdiv\u003EHello \u003Cspan style=\"color: red\"\u003E{name}\u003C\u002Fspan\u003E\u003C\u002Fdiv\u003E;\n}\n\nasync function *LoadingGreeting({name}) {\n  for await ({name} of this) {\n    yield \u003CLoadingIndicator \u002F\u003E;\n    yield \u003CRandomDelayGreeting name={name} \u002F\u003E;\n  }\n}","lang":"jsx"};
		</script></div><p>Because this async generator component resumes continuously, it will concurrently attempt to render both the <code class="inline">LoadingIndicator</code> component, which fulfills after one second, and the <code class="inline">RandomDelayGreeting</code> component, which fulfills randomly between zero and four seconds, as its children. If the <code class="inline">RandomDelayGreeting</code> component takes longer than a second, we‚Äôll see the loading indicator after a second, and if it takes less than a second, we‚Äôll never see the loading indicator. This is because of the chasing behavior of elements which we defined in the previous step.</p><h3 id="implementation">Implementation</h3><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>@@ <span class="token operator">-</span><span class="token number">321</span><span class="token punctuation">,</span><span class="token number">67</span> <span class="token operator">+</span><span class="token number">321</span><span class="token punctuation">,</span><span class="token number">109</span> @@ <span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_renderer <span class="token operator">=</span> renderer<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_host <span class="token operator">=</span> host<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_el <span class="token operator">=</span> el<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_iter <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_schedules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_onavailable <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_inflightBlock <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_inflightValue <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_enqueuedBlock <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_enqueuedValue <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code>     <span class="token comment">// flags</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isUpdating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isDone <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_isAvailable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_isAsyncIterator <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code>   <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><code><span class="token operator">+</span>    <span class="token function">resumeCtx</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><code>     <span class="token keyword">return</span> <span class="token function">runCtx</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="29"><code>   <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="30"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_schedules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="31"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="32"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="33"><code>   <span class="token operator">*</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="34"><code>     <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isDone<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="35"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="36"><code>         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Context iterated twice without a yield&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="37"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="38"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="39"><code>       <span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="40"><code>       <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="41"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="42"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="43"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="44"><code><span class="token operator">+</span>  async <span class="token operator">*</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>asyncIterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="45"><code><span class="token operator">+</span>    <span class="token keyword">do</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="46"><code><span class="token operator">+</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="47"><code><span class="token operator">+</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Context iterated twice without a yield&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="48"><code><span class="token operator">+</span>      <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="49"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="50"><code><span class="token operator">+</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="51"><code><span class="token operator">+</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isAvailable<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="52"><code><span class="token operator">+</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>_isAvailable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="53"><code><span class="token operator">+</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="54"><code><span class="token operator">+</span>        <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_onavailable <span class="token operator">=</span> resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="55"><code><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_unmounted<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="56"><code><span class="token operator">+</span>          <span class="token keyword">break</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="57"><code><span class="token operator">+</span>        <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="58"><code><span class="token operator">+</span>      <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="59"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="60"><code><span class="token operator">+</span>      <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="61"><code><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isUnmounted<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="62"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="63"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="64"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="65"><code> <span class="token keyword">function</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="66"><code>   <span class="token keyword">let</span> initial <span class="token operator">=</span> <span class="token operator">!</span>ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="67"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_isDone<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="68"><code>     <span class="token keyword">return</span> <span class="token function">getValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="69"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>initial<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="70"><code>     <span class="token keyword">const</span> value <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="71"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIteratorLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="72"><code>       ctx<span class="token punctuation">.</span>_iter <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="73"><code>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromiseLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="74"><code>       <span class="token keyword">const</span> block <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="75"><code>       <span class="token keyword">return</span> <span class="token punctuation">[</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="76"><code>         block<span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="77"><code>         block<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="78"><code>       <span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="79"><code>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="80"><code>       <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="81"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="82"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="83"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="84"><code>   <span class="token keyword">const</span> oldValue <span class="token operator">=</span> initial <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="85"><code>   <span class="token keyword">const</span> iteration <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="86"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromiseLike</span><span class="token punctuation">(</span>iteration<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="87"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>initial<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="88"><code><span class="token operator">+</span>      ctx<span class="token punctuation">.</span>_isAsyncIterator <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="89"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="90"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="91"><code><span class="token operator">+</span>    <span class="token keyword">const</span> block <span class="token operator">=</span> iteration<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="92"><code><span class="token operator">+</span>    <span class="token keyword">const</span> value <span class="token operator">=</span> iteration<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">iteration</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="93"><code><span class="token operator">+</span>      ctx<span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="94"><code><span class="token operator">+</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>iteration<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="95"><code><span class="token operator">+</span>        ctx<span class="token punctuation">.</span>_done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="96"><code><span class="token operator">+</span>      <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="97"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="98"><code><span class="token operator">+</span>      <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> iteration<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="99"><code><span class="token operator">+</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="100"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="101"><code><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span>block<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="102"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="103"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="104"><code>   ctx<span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="105"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>iteration<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="106"><code>     ctx<span class="token punctuation">.</span>_isDone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="107"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="108"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="109"><code>   <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> iteration<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="110"><code>   <span class="token keyword">return</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="111"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="112"><code>@@ <span class="token operator">-</span><span class="token number">389</span><span class="token punctuation">,</span><span class="token number">40</span> <span class="token operator">+</span><span class="token number">431</span><span class="token punctuation">,</span><span class="token number">55</span> @@ <span class="token keyword">function</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="113"><code> <span class="token keyword">function</span> <span class="token function">advanceCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="114"><code>   ctx<span class="token punctuation">.</span>_inflightBlock <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_enqueuedBlock<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="115"><code>   ctx<span class="token punctuation">.</span>_inflightValue <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_enqueuedValue<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="116"><code>   ctx<span class="token punctuation">.</span>_enqueuedBlock <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="117"><code>   ctx<span class="token punctuation">.</span>_enqueuedValue <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="118"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_isAsyncIterator<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="119"><code><span class="token operator">+</span>    <span class="token function">runCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="120"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="121"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="122"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="123"><code> <span class="token keyword">function</span> <span class="token function">runCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="124"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_inflightBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="125"><code>     <span class="token keyword">let</span> <span class="token punctuation">[</span>block<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="126"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromiseLike</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="127"><code>       block <span class="token operator">=</span> block<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">advanceCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="128"><code>       ctx<span class="token punctuation">.</span>_inflightBlock <span class="token operator">=</span> block<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="129"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="130"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="131"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromiseLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="132"><code>       ctx<span class="token punctuation">.</span>_inflightValue <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="133"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="134"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="135"><code>     <span class="token keyword">return</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="136"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_isAsyncIterator<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="137"><code><span class="token operator">+</span>    <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>_inflightValue<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="138"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_enqueuedBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="139"><code>     <span class="token keyword">let</span> resolve<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="140"><code>     ctx<span class="token punctuation">.</span>_enqueuedBlock <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_inflightBlock</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="141"><code>       <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="142"><code>         <span class="token keyword">const</span> <span class="token punctuation">[</span>block<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="143"><code>         <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="144"><code>         <span class="token keyword">return</span> block<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="145"><code>       <span class="token punctuation">}</span><span class="token punctuation">)</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="146"><code>       <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">advanceCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="147"><code>     ctx<span class="token punctuation">.</span>_enqueuedValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve1</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>resolve <span class="token operator">=</span> resolve1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="148"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="149"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="150"><code>   <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>_enqueuedValue<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="151"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="152"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="153"><code><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">resumeCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="154"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_onavailable<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="155"><code><span class="token operator">+</span>    ctx<span class="token punctuation">.</span><span class="token function">_onavailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="156"><code><span class="token operator">+</span>    ctx<span class="token punctuation">.</span>_onavailable <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="157"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_isAvailable<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="158"><code><span class="token operator">+</span>    ctx<span class="token punctuation">.</span>_isAvailable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="159"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="160"><code><span class="token operator">+</span><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="161"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="162"><code> <span class="token keyword">function</span> <span class="token function">updateCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="163"><code>   ctx<span class="token punctuation">.</span>_isUpdating <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="164"><code><span class="token operator">+</span>  <span class="token function">resumeCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="165"><code>   <span class="token keyword">return</span> <span class="token function">runCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="166"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="167"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="168"><code>@@ <span class="token operator">-</span><span class="token number">453</span><span class="token punctuation">,</span><span class="token number">8</span> <span class="token operator">+</span><span class="token number">510</span><span class="token punctuation">,</span><span class="token number">9</span> @@ <span class="token keyword">function</span> <span class="token function">commitCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="169"><code> <span class="token keyword">function</span> <span class="token function">unmountCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="170"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_isDone<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="171"><code>     ctx<span class="token punctuation">.</span>_isDone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="172"><code><span class="token operator">+</span>    <span class="token function">resumeCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="173"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_iterator <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> ctx<span class="token punctuation">.</span>_iterator<span class="token punctuation">.</span>return <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="174"><code>       ctx<span class="token punctuation">.</span>_iterator<span class="token punctuation">.</span><span class="token function">return</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="175"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="176"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="177"><code> <span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-59" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-59'] = {"code":"--- a\u002Fcrank.js\n+++ b\u002Fcrank.js\n@@ -321,67 +321,109 @@ function unmount(renderer, el) {\n class Context {\n   constructor(renderer, host, el) {\n     this._renderer = renderer;\n     this._host = host;\n     this._el = el;\n     this._iter = undefined;\n     this._schedules = new Set();\n+    this._onavailable = undefined;\n     this._inflightBlock = undefined;\n     this._inflightValue = undefined;\n     this._enqueuedBlock = undefined;\n     this._enqueuedValue = undefined;\n\n     \u002F\u002F flags\n     this._isUpdating = false;\n     this._isIterating = false;\n     this._isDone = false;\n+    this._isAvailable = false;\n+    this._isAsyncIterator = false;\n   }\n\n   refresh() {\n+    resumeCtx(this);\n     return runCtx(this);\n   }\n\n   schedule(callback) {\n     this._schedules.add(callback);\n   }\n\n   *[Symbol.iterator]() {\n     while (!this._isDone) {\n       if (this._isIterating) {\n         throw new Error(\"Context iterated twice without a yield\");\n       }\n\n       this._isIterating = true;\n       yield this._el.props;\n     }\n   }\n+\n+  async *[Symbol.asyncIterator]() {\n+    do {\n+      if (this._isIterating) {\n+        throw new Error(\"Context iterated twice without a yield\");\n+      }\n+\n+      this._isIterating = true;\n+      if (this._isAvailable) {\n+        this._isAvailable = false;\n+      } else {\n+        await new Promise((resolve) =\u003E (this._onavailable = resolve));\n+        if (this._unmounted) {\n+          break;\n+        }\n+      }\n+\n+      yield this._el.props;\n+    } while (!this._isUnmounted);\n+  }\n }\n\n function stepCtx(ctx) {\n   let initial = !ctx._iter;\n   if (ctx._isDone) {\n     return getValue(ctx._el);\n   } else if (initial) {\n     const value = ctx._el.tag.call(ctx, ctx._el.props);\n     if (isIteratorLike(value)) {\n       ctx._iter = value;\n     } else if (isPromiseLike(value)) {\n       const block = Promise.resolve(value);\n       return [\n         block,\n         block.then((value) =\u003E updateCtxChildren(ctx, value)),\n       ];\n     } else {\n       return [undefined, updateCtxChildren(ctx, value)];\n     }\n   }\n\n   const oldValue = initial ? undefined : getValue(ctx._el);\n   const iteration = ctx._iter.next(oldValue);\n+  if (isPromiseLike(iteration)) {\n+    if (initial) {\n+      ctx._isAsyncIterator = true;\n+    }\n+\n+    const block = iteration;\n+    const value = iteration.then((iteration) =\u003E {\n+      ctx._isIterating = false;\n+      if (iteration.done) {\n+        ctx._done = true;\n+      }\n+\n+      return updateCtxChildren(ctx, iteration.value);\n+    });\n+\n+    return [block, value];\n+  }\n+\n   ctx._isIterating = false;\n   if (iteration.done) {\n     ctx._isDone = true;\n   }\n\n   const value = updateCtxChildren(ctx, iteration.value);\n   return [value, value];\n }\n@@ -389,40 +431,55 @@ function stepCtx(ctx) {\n function advanceCtx(ctx) {\n   ctx._inflightBlock = ctx._enqueuedBlock;\n   ctx._inflightValue = ctx._enqueuedValue;\n   ctx._enqueuedBlock = undefined;\n   ctx._enqueuedValue = undefined;\n+  if (ctx._isAsyncIterator) {\n+    runCtx(ctx);\n+  }\n }\n\n function runCtx(ctx) {\n   if (!ctx._inflightBlock) {\n     let [block, value] = stepCtx(ctx);\n     if (isPromiseLike(block)) {\n       block = block.finally(() =\u003E advanceCtx(ctx));\n       ctx._inflightBlock = block;\n     }\n\n     if (isPromiseLike(value)) {\n       ctx._inflightValue = value;\n     }\n\n     return value;\n+  } else if (ctx._isAsyncIterator) {\n+    return ctx._inflightValue;\n   } else if (!ctx._enqueuedBlock) {\n     let resolve;\n     ctx._enqueuedBlock = ctx._inflightBlock\n       .then(() =\u003E {\n         const [block, value] = stepCtx(ctx);\n         resolve(value);\n         return block;\n       })\n       .finally(() =\u003E advanceCtx(ctx));\n     ctx._enqueuedValue = new Promise((resolve1) =\u003E (resolve = resolve1));\n   }\n\n   return ctx._enqueuedValue;\n }\n\n+function resumeCtx(ctx) {\n+  if (ctx._onavailable) {\n+    ctx._onavailable();\n+    ctx._onavailable = undefined;\n+  } else if (!ctx._isAvailable) {\n+    ctx._isAvailable = true;\n+  }\n+}\n+\n function updateCtx(ctx) {\n   ctx._isUpdating = true;\n+  resumeCtx(ctx);\n   return runCtx(ctx);\n }\n\n@@ -453,8 +510,9 @@ function commitCtx(ctx, values) {\n function unmountCtx(ctx) {\n   if (!ctx._isDone) {\n     ctx._isDone = true;\n+    resumeCtx(ctx);\n     if (ctx._iterator && typeof ctx._iterator.return === \"function\") {\n       ctx._iterator.return();\n     }\n   }\n }","lang":"diff"};
		</script></div><p><a href="https://github.com/brainkim/crank-from-scratch/commit/208a71ff2d82fd202c6a4331d85b1493f8a09605">Diff</a> <a href="https://github.com/brainkim/crank-from-scratch/blob/208a71ff2d82fd202c6a4331d85b1493f8a09605/crank.js">File</a></p><p>To implement the continuous resuming behavior of async generator components, we call <code class="inline">runCtx()</code> in the <code class="inline">advanceCtx()</code> function. This continuous resuming behavior does not mesh well with the standard enqueuing behavior in <code class="inline">runCtx()</code>, so we use the hitching strategy described previously rather than the enqueuing strategy for async generator components.</p><p>To implement the context‚Äôs props async iterator, we define a  <code class="inline">resumeCtx()</code> function and a <code class="inline">[Symbol.asyncIterator]()</code> async generator method. The <code class="inline">resumeCtx()</code> function is called by both <code class="inline">refresh()</code> and <code class="inline">updateCtx()</code> to ensure the <code class="inline">for await‚Ä¶of</code> loop over <code class="inline">this</code> resumes when the component is ready to rerender. It‚Äôs important to note that if there are concurrent renderings of an async generator component, earlier props will be overwritten, just as with regular async function components. The context async iterator always yields the latest props available.</p><p>We again distinguish async generator components from other components by return types exclusively. An async generator component can be determined by the fact that the function returns an iterator, and can furthermore be distinguished from sync generator components by the fact that calls to the iterator‚Äôs <code class="inline">next()</code> method returns a promise.</p><h2 id="step-16-async-values-and-fallbacks">Step 16: Async Values and Fallbacks</h2><p>Before we conclude, we‚Äôll fix two tricky bugs related to async components and concurrent rendering.</p><p>First, we need to deal with async generator components which have async children. Because they resume continuously, an async generator component which yields async children may have <code class="inline">undefined</code> passed back into the generator. This feels incorrect, and the most natural behavior in this situation would be for a promise to be passed back in which resolves to the rendered DOM nodes. This would allow async generator components to await the rendering of their own children just like any other promise.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">DelayedGreeting</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Hello <span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token string">&quot;color: red&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code><span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">ImperativeGreeting</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span> <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>    <span class="token keyword">const</span> div <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token operator">&lt;</span>DelayedGreeting name<span class="token operator">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>    <span class="token comment">// Expected: an HTMLDivElement</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>    <span class="token comment">// Actual: undefined</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-60" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-60'] = {"code":"async function DelayedGreeting({name}) {\n  await new Promise((resolve) =\u003E setTimeout(resolve, 2000));\n  return \u003Cdiv\u003EHello \u003Cspan style=\"color: red\"\u003E{name}\u003C\u002Fspan\u003E\u003C\u002Fdiv\u003E;\n}\n\nasync function *ImperativeGreeting({name}) {\n  for await ({name} of this) {\n    const div = await (yield \u003CDelayedGreeting name={name} \u002F\u003E);\n    console.log(div);\n    \u002F\u002F Expected: an HTMLDivElement\n    \u002F\u002F Actual: undefined\n  }\n}","lang":"jsx"};
		</script></div><p>Second, we have to make concurrent renderings work with the rearranging logic we defined in a previous step. Currently, DOM nodes may end up disappearing because the <code class="inline">getValues()</code>/<code class="inline">getChildValues()</code> functions read pending async elements which have never rendered as <code class="inline">undefined</code>. This means that if we refresh a component which has pending children, the <code class="inline">arrange()</code> method will be called on the nearest ancestor host element and the previously rendered children will be erased. This bug is difficult to demonstrate, and will only manifest as rendered DOM nodes briefly disappearing from the DOM when <code class="inline">refresh</code> is called in certain situations.</p><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">LoadingGreeting</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code>  <span class="token comment">// Calling this.refresh called after LoadingIndicator settles</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>  <span class="token comment">// but before DelayedGreeting settles.</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>    <span class="token comment">// Expected: &quot;&lt;div&gt;Loading‚Ä¶&lt;/div&gt;&quot;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><code>    <span class="token comment">// Actual: &quot;&quot;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span> <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>    <span class="token keyword">yield</span> <span class="token operator">&lt;</span>LoadingIndicator <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>    <span class="token keyword">yield</span> <span class="token operator">&lt;</span>DelayedGreeting name<span class="token operator">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><code><span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-61" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-61'] = {"code":"async function *LoadingGreeting({name}) {\n  \u002F\u002F Calling this.refresh called after LoadingIndicator settles\n  \u002F\u002F but before DelayedGreeting settles.\n  setTimeout(async () =\u003E {\n    await this.refresh();\n    console.log(app.innerHTML);\n    \u002F\u002F Expected: \"\u003Cdiv\u003ELoading‚Ä¶\u003C\u002Fdiv\u003E\"\n    \u002F\u002F Actual: \"\"\n  }, 1500);\n  for await ({name} of this) {\n    yield \u003CLoadingIndicator \u002F\u003E;\n    yield \u003CDelayedGreeting name={name} \u002F\u003E;\n  }\n}","lang":"jsx"};
		</script></div><p>What we want is for whatever was previously rendered in a pending async element‚Äôs position to continue to be rendered until the element has rendered at least once.</p><h3 id="implementation">Implementation</h3><div style="margin: 30px auto;" class="code-block-container "><div class="css-1vm8pxc"><div class="css-1s1lac9"><div class="css-1lyfw13"><div class="css-1xzghkg"><button class="css-1y5ulpa">Copy</button></div><div class="css-i7rnhw"><div class="css-1y4o4pq"><content-area class="css-84ojsb"><pre autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="
							language-
							css-1ashatc
						"><div class="
				prism-line
				css-1flouoi
			" data-index="0"><code><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="1"><code><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>crank<span class="token punctuation">.</span>js</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="2"><code>@@ <span class="token operator">-</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">14</span> <span class="token operator">+</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">15</span> @@ <span class="token keyword">function</span> <span class="token function">isPromiseLike</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="3"><code> <span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="4"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="5"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="6"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="7"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="8"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_node <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="9"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_children <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="10"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_ctx <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="11"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_onvalues <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="12"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_fallback <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="13"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="14"><code>     <span class="token comment">// flags</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="15"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="16"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="17"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="18"><code>@@ <span class="token operator">-</span><span class="token number">105</span><span class="token punctuation">,</span><span class="token number">11</span> <span class="token operator">+</span><span class="token number">106</span><span class="token punctuation">,</span><span class="token number">17</span> @@ <span class="token keyword">function</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token parameter">values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="19"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="20"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="21"><code> <span class="token keyword">function</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="22"><code><span class="token operator">-</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> Portal<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="23"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>_fallback<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="24"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>_fallback <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="25"><code><span class="token operator">+</span>      <span class="token keyword">return</span> <span class="token function">getValue</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_fallback<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="26"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="27"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="28"><code><span class="token operator">+</span>    <span class="token keyword">return</span> el<span class="token punctuation">.</span>_fallback<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="29"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> Portal<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="30"><code>     <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="31"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> el<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span>tag <span class="token operator">!==</span> Fragment<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="32"><code>     <span class="token keyword">return</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="33"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="34"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="35"><code>   <span class="token keyword">return</span> <span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token function">getChildValues</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="36"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="37"><code>@@ <span class="token operator">-</span><span class="token number">197</span><span class="token punctuation">,</span><span class="token number">21</span> <span class="token operator">+</span><span class="token number">204</span><span class="token punctuation">,</span><span class="token number">25</span> @@ <span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Renderer</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="38"><code> <span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> oldChild<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="39"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="40"><code>     oldChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="41"><code>     newChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="42"><code>     oldChild<span class="token punctuation">.</span>tag <span class="token operator">===</span> newChild<span class="token punctuation">.</span>tag</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="43"><code>   <span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="44"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChild <span class="token operator">!==</span> newChild<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="45"><code>       oldChild<span class="token punctuation">.</span>props <span class="token operator">=</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="46"><code>       newChild <span class="token operator">=</span> oldChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="47"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="48"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="49"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="50"><code>   <span class="token keyword">let</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="51"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="52"><code><span class="token operator">+</span>    <span class="token keyword">const</span> initial <span class="token operator">=</span> <span class="token operator">!</span>newChild<span class="token punctuation">.</span>_isMounted<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="53"><code>     value <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="54"><code><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>initial <span class="token operator">&amp;&amp;</span> <span class="token function">isPromiseLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="55"><code><span class="token operator">+</span>      newChild<span class="token punctuation">.</span>_fallback <span class="token operator">=</span> oldChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="56"><code><span class="token operator">+</span>    <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="57"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="58"><code>     value <span class="token operator">=</span> newChild<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="59"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="60"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="61"><code>   <span class="token keyword">return</span> <span class="token punctuation">[</span>newChild<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="62"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="63"><code>@@ <span class="token operator">-</span><span class="token number">290</span><span class="token punctuation">,</span><span class="token number">18</span> <span class="token operator">+</span><span class="token number">301</span><span class="token punctuation">,</span><span class="token number">19</span> @@ <span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="64"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="65"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="66"><code> <span class="token keyword">function</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="67"><code><span class="token operator">+</span>  el<span class="token punctuation">.</span>_fallback <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="68"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="69"><code>     <span class="token keyword">return</span> <span class="token function">commitCtx</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>_ctx<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="70"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> Fragment<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="71"><code>     <span class="token keyword">return</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="72"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> Portal<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="73"><code>     renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>props<span class="token punctuation">.</span>root<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="74"><code>     <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="75"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>_node<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="76"><code>     el<span class="token punctuation">.</span>_node <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="77"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="78"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="79"><code>   renderer<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="80"><code>   renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="81"><code>   <span class="token keyword">return</span> el<span class="token punctuation">.</span>_node<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="82"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="83"><code>@@ <span class="token operator">-</span><span class="token number">321</span><span class="token punctuation">,</span><span class="token number">61</span> <span class="token operator">+</span><span class="token number">333</span><span class="token punctuation">,</span><span class="token number">62</span> @@ <span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="84"><code> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="85"><code>   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">renderer<span class="token punctuation">,</span> host<span class="token punctuation">,</span> el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="86"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_renderer <span class="token operator">=</span> renderer<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="87"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_host <span class="token operator">=</span> host<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="88"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_el <span class="token operator">=</span> el<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="89"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_iter <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="90"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_schedules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="91"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_onavailable <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="92"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_inflightBlock <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="93"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_inflightValue <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="94"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_enqueuedBlock <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="95"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_enqueuedValue <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="96"><code><span class="token operator">+</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_previousValue <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="97"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="98"><code>     <span class="token comment">// flags</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="99"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isUpdating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="100"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="101"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isDone <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="102"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isAvailable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="103"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_isAsyncIterator <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="104"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="105"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="106"><code>   <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="107"><code>     <span class="token function">resumeCtx</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="108"><code>     <span class="token keyword">return</span> <span class="token function">runCtx</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="109"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="110"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="111"><code>   <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="112"><code>     <span class="token keyword">this</span><span class="token punctuation">.</span>_schedules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="113"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="114"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="115"><code>   <span class="token operator">*</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="116"><code>     <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isDone<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="117"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="118"><code>         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Context iterated twice without a yield&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="119"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="120"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="121"><code>       <span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="122"><code>       <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="123"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="124"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="125"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="126"><code>   async <span class="token operator">*</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>asyncIterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="127"><code>     <span class="token keyword">do</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="128"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="129"><code>         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Context iterated twice without a yield&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="130"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="131"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="132"><code>       <span class="token keyword">this</span><span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="133"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isAvailable<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="134"><code>         <span class="token keyword">this</span><span class="token punctuation">.</span>_isAvailable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="135"><code>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="136"><code>         <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_onavailable <span class="token operator">=</span> resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="137"><code>         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_unmounted<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="138"><code>           <span class="token keyword">break</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="139"><code>         <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="140"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="141"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="142"><code>       <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="143"><code>     <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isUnmounted<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="144"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="145"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="146"><code>@@ <span class="token operator">-</span><span class="token number">383</span><span class="token punctuation">,</span><span class="token number">47</span> <span class="token operator">+</span><span class="token number">396</span><span class="token punctuation">,</span><span class="token number">55</span> @@ <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="147"><code> <span class="token keyword">function</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="148"><code>   <span class="token keyword">let</span> initial <span class="token operator">=</span> <span class="token operator">!</span>ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="149"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_isDone<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="150"><code>     <span class="token keyword">return</span> <span class="token function">getValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="151"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>initial<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="152"><code>     <span class="token keyword">const</span> value <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>_el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="153"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIteratorLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="154"><code>       ctx<span class="token punctuation">.</span>_iter <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="155"><code>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromiseLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="156"><code>       <span class="token keyword">const</span> block <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="157"><code>       <span class="token keyword">return</span> <span class="token punctuation">[</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="158"><code>         block<span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="159"><code>         block<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="160"><code>       <span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="161"><code>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="162"><code>       <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="163"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="164"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="165"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="166"><code><span class="token operator">-</span>  <span class="token keyword">const</span> oldValue <span class="token operator">=</span> initial <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="167"><code><span class="token operator">+</span>  <span class="token keyword">let</span> oldValue<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="168"><code><span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>initial<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="169"><code><span class="token operator">+</span>    <span class="token comment">// pass</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="170"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_isAsyncIterator <span class="token operator">&amp;&amp;</span> ctx<span class="token punctuation">.</span>_previousValue<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="171"><code><span class="token operator">+</span>    oldValue <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_previousValue<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="172"><code><span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="173"><code><span class="token operator">+</span>    oldValue <span class="token operator">=</span> <span class="token function">getValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_el<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="174"><code><span class="token operator">+</span>  <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="175"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="176"><code>   <span class="token keyword">const</span> iteration <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="177"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromiseLike</span><span class="token punctuation">(</span>iteration<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="178"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span>initial<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="179"><code>       ctx<span class="token punctuation">.</span>_isAsyncIterator <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="180"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="181"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="182"><code>     <span class="token keyword">const</span> block <span class="token operator">=</span> iteration<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="183"><code>     <span class="token keyword">const</span> value <span class="token operator">=</span> iteration<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">iteration</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="184"><code>       ctx<span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="185"><code>       <span class="token keyword">if</span> <span class="token punctuation">(</span>iteration<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="186"><code>         ctx<span class="token punctuation">.</span>_done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="187"><code>       <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="188"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="189"><code>       <span class="token keyword">return</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> iteration<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="190"><code>     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="191"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="192"><code>     <span class="token keyword">return</span> <span class="token punctuation">[</span>block<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="193"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="194"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="195"><code>   ctx<span class="token punctuation">.</span>_isIterating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="196"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span>iteration<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="197"><code>     ctx<span class="token punctuation">.</span>_isDone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="198"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="199"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="200"><code>   <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> iteration<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="201"><code>   <span class="token keyword">return</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="202"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="203"><code>@@ <span class="token operator">-</span><span class="token number">441</span><span class="token punctuation">,</span><span class="token number">29</span> <span class="token operator">+</span><span class="token number">462</span><span class="token punctuation">,</span><span class="token number">34</span> @@ <span class="token keyword">function</span> <span class="token function">advanceCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="204"><code> <span class="token keyword">function</span> <span class="token function">runCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="205"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_inflightBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="206"><code>     <span class="token keyword">let</span> <span class="token punctuation">[</span>block<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="207"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromiseLike</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="208"><code>       block <span class="token operator">=</span> block<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">advanceCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="209"><code>       ctx<span class="token punctuation">.</span>_inflightBlock <span class="token operator">=</span> block<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="210"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="211"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="212"><code>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromiseLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="213"><code>       ctx<span class="token punctuation">.</span>_inflightValue <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="214"><code><span class="token operator">+</span>      ctx<span class="token punctuation">.</span>_previousValue <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="215"><code>     <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="216"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="217"><code>     <span class="token keyword">return</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="218"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_isAsyncIterator<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="219"><code>     <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>_inflightValue<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="220"><code>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_enqueuedBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="221"><code>     <span class="token keyword">let</span> resolve<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="222"><code>     ctx<span class="token punctuation">.</span>_enqueuedBlock <span class="token operator">=</span> ctx<span class="token punctuation">.</span>_inflightBlock</code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="223"><code>       <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="224"><code>         <span class="token keyword">const</span> <span class="token punctuation">[</span>block<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">stepCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="225"><code>         <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="226"><code><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromiseLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="227"><code><span class="token operator">+</span>          ctx<span class="token punctuation">.</span>_previousValue <span class="token operator">=</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="228"><code><span class="token operator">+</span>        <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="229"><code><span class="token operator">+</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="230"><code>         <span class="token keyword">return</span> block<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="231"><code>       <span class="token punctuation">}</span><span class="token punctuation">)</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="232"><code>       <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">advanceCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="233"><code>     ctx<span class="token punctuation">.</span>_enqueuedValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve1</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>resolve <span class="token operator">=</span> resolve1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="234"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="235"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="236"><code>   <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>_enqueuedValue<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="237"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="238"><code>@@ <span class="token operator">-</span><span class="token number">488</span><span class="token punctuation">,</span><span class="token number">21</span> <span class="token operator">+</span><span class="token number">514</span><span class="token punctuation">,</span><span class="token number">22</span> @@ <span class="token keyword">function</span> <span class="token function">updateCtxChildren</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="239"><code> <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="240"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="241"><code> <span class="token keyword">function</span> <span class="token function">commitCtx</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="242"><code><span class="token operator">+</span>  ctx<span class="token punctuation">.</span>_previousValue <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="243"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>_isUpdating<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="244"><code>     ctx<span class="token punctuation">.</span>_renderer<span class="token punctuation">.</span><span class="token function">arrange</span><span class="token punctuation">(</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="245"><code>       ctx<span class="token punctuation">.</span>_host<span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="246"><code>       ctx<span class="token punctuation">.</span>_host<span class="token punctuation">.</span>tag <span class="token operator">===</span> Portal <span class="token operator">?</span> ctx<span class="token punctuation">.</span>_host<span class="token punctuation">.</span>props<span class="token punctuation">.</span>root <span class="token operator">:</span> ctx<span class="token punctuation">.</span>_host<span class="token punctuation">.</span>_node<span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="247"><code>       <span class="token function">getChildValues</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_host<span class="token punctuation">)</span><span class="token punctuation">,</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="248"><code>     <span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="249"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="250"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="251"><code>   <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="252"><code>   <span class="token keyword">const</span> schedules <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_schedules<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="253"><code>   ctx<span class="token punctuation">.</span>_schedules<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="254"><code>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> schedule <span class="token keyword">of</span> schedules<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="255"><code>     <span class="token function">schedule</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="256"><code>   <span class="token punctuation">}</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="257"><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="258"><code>   ctx<span class="token punctuation">.</span>_isUpdating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="259"><code>   <span class="token keyword">return</span> value<span class="token punctuation">;</span></code><br></div><div class="
				prism-line
				css-1flouoi
			" data-index="260"><code> <span class="token punctuation">}</span></code><br></div></pre></content-area></div></div></div></div></div><script data-name="inline-code-block-props-62" class="props">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['inline-code-block-props-62'] = {"code":"--- a\u002Fcrank.js\n+++ b\u002Fcrank.js\n@@ -25,14 +25,15 @@ function isPromiseLike(value) {\n class Element {\n   constructor(tag, props) {\n     this.tag = tag;\n     this.props = props;\n\n     this._node = undefined;\n     this._children = undefined;\n     this._ctx = undefined;\n     this._onvalues = undefined;\n+    this._fallback = undefined;\n\n     \u002F\u002F flags\n     this._isMounted = false;\n   }\n }\n@@ -105,11 +106,17 @@ function normalize(values) {\n }\n\n function getValue(el) {\n-  if (el.tag === Portal) {\n+  if (el._fallback) {\n+    if (el._fallback instanceof Element) {\n+      return getValue(el._fallback);\n+    }\n+\n+    return el._fallback;\n+  } else if (el.tag === Portal) {\n     return undefined;\n   } else if (typeof el.tag !== \"function\" && el.tag !== Fragment) {\n     return el._node;\n   }\n\n   return unwrap(getChildValues(el));\n }\n@@ -197,21 +204,25 @@ export class Renderer {\n function diff(renderer, host, oldChild, newChild) {\n   if (\n     oldChild instanceof Element &&\n     newChild instanceof Element &&\n     oldChild.tag === newChild.tag\n   ) {\n     if (oldChild !== newChild) {\n       oldChild.props = newChild.props;\n       newChild = oldChild;\n     }\n   }\n\n   let value;\n   if (newChild instanceof Element) {\n+    const initial = !newChild._isMounted;\n     value = update(renderer, host, newChild);\n+    if (initial && isPromiseLike(value)) {\n+      newChild._fallback = oldChild;\n+    }\n   } else {\n     value = newChild;\n   }\n\n   return [newChild, value];\n }\n@@ -290,18 +301,19 @@ function updateChildren(renderer, host, el, newChildren) {\n }\n\n function commit(renderer, el, values) {\n+  el._fallback = undefined;\n   if (typeof el.tag === \"function\") {\n     return commitCtx(el._ctx, values);\n   } else if (el.tag === Fragment) {\n     return unwrap(values);\n   } else if (el.tag === Portal) {\n     renderer.arrange(el, el.props.root, values);\n     return undefined;\n   } else if (!el._node) {\n     el._node = renderer.create(el);\n   }\n\n   renderer.patch(el, el._node);\n   renderer.arrange(el, el._node, values);\n   return el._node;\n }\n@@ -321,61 +333,62 @@ function unmount(renderer, el) {\n class Context {\n   constructor(renderer, host, el) {\n     this._renderer = renderer;\n     this._host = host;\n     this._el = el;\n     this._iter = undefined;\n     this._schedules = new Set();\n     this._onavailable = undefined;\n     this._inflightBlock = undefined;\n     this._inflightValue = undefined;\n     this._enqueuedBlock = undefined;\n     this._enqueuedValue = undefined;\n+    this._previousValue = undefined;\n\n     \u002F\u002F flags\n     this._isUpdating = false;\n     this._isIterating = false;\n     this._isDone = false;\n     this._isAvailable = false;\n     this._isAsyncIterator = false;\n   }\n\n   refresh() {\n     resumeCtx(this);\n     return runCtx(this);\n   }\n\n   schedule(callback) {\n     this._schedules.add(callback);\n   }\n\n   *[Symbol.iterator]() {\n     while (!this._isDone) {\n       if (this._isIterating) {\n         throw new Error(\"Context iterated twice without a yield\");\n       }\n\n       this._isIterating = true;\n       yield this._el.props;\n     }\n   }\n\n   async *[Symbol.asyncIterator]() {\n     do {\n       if (this._isIterating) {\n         throw new Error(\"Context iterated twice without a yield\");\n       }\n\n       this._isIterating = true;\n       if (this._isAvailable) {\n         this._isAvailable = false;\n       } else {\n         await new Promise((resolve) =\u003E (this._onavailable = resolve));\n         if (this._unmounted) {\n           break;\n         }\n       }\n\n       yield this._el.props;\n     } while (!this._isUnmounted);\n   }\n }\n@@ -383,47 +396,55 @@ class Context {\n function stepCtx(ctx) {\n   let initial = !ctx._iter;\n   if (ctx._isDone) {\n     return getValue(ctx._el);\n   } else if (initial) {\n     const value = ctx._el.tag.call(ctx, ctx._el.props);\n     if (isIteratorLike(value)) {\n       ctx._iter = value;\n     } else if (isPromiseLike(value)) {\n       const block = Promise.resolve(value);\n       return [\n         block,\n         block.then((value) =\u003E updateCtxChildren(ctx, value)),\n       ];\n     } else {\n       return [undefined, updateCtxChildren(ctx, value)];\n     }\n   }\n\n-  const oldValue = initial ? undefined : getValue(ctx._el);\n+  let oldValue;\n+  if (initial) {\n+    \u002F\u002F pass\n+  } else if (ctx._isAsyncIterator && ctx._previousValue) {\n+    oldValue = ctx._previousValue;\n+  } else {\n+    oldValue = getValue(ctx._el);\n+  }\n+\n   const iteration = ctx._iter.next(oldValue);\n   if (isPromiseLike(iteration)) {\n     if (initial) {\n       ctx._isAsyncIterator = true;\n     }\n\n     const block = iteration;\n     const value = iteration.then((iteration) =\u003E {\n       ctx._isIterating = false;\n       if (iteration.done) {\n         ctx._done = true;\n       }\n\n       return updateCtxChildren(ctx, iteration.value);\n     });\n\n     return [block, value];\n   }\n\n   ctx._isIterating = false;\n   if (iteration.done) {\n     ctx._isDone = true;\n   }\n\n   const value = updateCtxChildren(ctx, iteration.value);\n   return [value, value];\n }\n@@ -441,29 +462,34 @@ function advanceCtx(ctx) {\n function runCtx(ctx) {\n   if (!ctx._inflightBlock) {\n     let [block, value] = stepCtx(ctx);\n     if (isPromiseLike(block)) {\n       block = block.finally(() =\u003E advanceCtx(ctx));\n       ctx._inflightBlock = block;\n     }\n\n     if (isPromiseLike(value)) {\n       ctx._inflightValue = value;\n+      ctx._previousValue = value;\n     }\n\n     return value;\n   } else if (ctx._isAsyncIterator) {\n     return ctx._inflightValue;\n   } else if (!ctx._enqueuedBlock) {\n     let resolve;\n     ctx._enqueuedBlock = ctx._inflightBlock\n       .then(() =\u003E {\n         const [block, value] = stepCtx(ctx);\n         resolve(value);\n+        if (isPromiseLike(value)) {\n+          ctx._previousValue = value;\n+        }\n+\n         return block;\n       })\n       .finally(() =\u003E advanceCtx(ctx));\n     ctx._enqueuedValue = new Promise((resolve1) =\u003E (resolve = resolve1));\n   }\n\n   return ctx._enqueuedValue;\n }\n@@ -488,21 +514,22 @@ function updateCtxChildren(ctx, children) {\n }\n\n function commitCtx(ctx, values) {\n+  ctx._previousValue = undefined;\n   if (!ctx._isUpdating) {\n     ctx._renderer.arrange(\n       ctx._host,\n       ctx._host.tag === Portal ? ctx._host.props.root : ctx._host._node,\n       getChildValues(ctx._host),\n     );\n   }\n\n   const value = unwrap(values);\n   const schedules = Array.from(ctx._schedules);\n   ctx._schedules.clear();\n   for (const schedule of schedules) {\n     schedule(value);\n   }\n\n   ctx._isUpdating = false;\n   return value;\n }","lang":"diff"};
		</script></div><p><a href="https://github.com/brainkim/crank-from-scratch/commit/567363adbb546d69e6726de7360595b910960ef2">Diff</a> <a href="https://github.com/brainkim/crank-from-scratch/blob/567363adbb546d69e6726de7360595b910960ef2/crank.js">File</a></p><p><strong>Notes:</strong></p><ol><li>We define the property <code class="inline">_previousValue</code> on contexts, assign it in <code class="inline">runCtx()</code> whenever async runs are detected, and unassign it in <code class="inline">commitCtx()</code>. We can‚Äôt use <code class="inline">_inflightValue</code> for this purpose because it gets assigned/unassigned at different points of the rendering process. In the actual Crank.js implementation we move this promise to elements for some advanced use-cases.</li><li>We define the property <code class="inline">_fallback</code> on elements, and assign it in the <code class="inline">diff()</code> function whenever a new element is detected as rendering asynchronously. If multiple asynchronous element trees were rendered in the same position, the elements would form a linked list via the <code class="inline">_fallback</code> property. We unset any element‚Äôs <code class="inline">_fallback</code> in the <code class="inline">commit()</code> function, breaking any fallback chains and making <code class="inline">getValue()</code> work as expected once the element has rendered.</li></ol><h2 id="conclusion">Conclusion</h2><p>If you‚Äôve made it this far, congratulations! You can now call yourself a framework author. You should be able to understand every line of <a href="https://github.com/brainkim/crank-from-scratch/blob/567363adbb546d69e6726de7360595b910960ef2/crank.js">the final version of the module we created</a>.</p><p>Of course, the actual Crank.js codebase implements a few more features which we haven‚Äôt had a chance to get to; for instance, the real Crank framework implements SVG elements, server-side rendering, error handling, <code class="inline">Copy</code> elements, an additional <code class="inline">EventTarget</code>-based event system, and keyed element diffing. However, we‚Äôve still implemented and explained a lot of the hard stuff, and I think at this point you‚Äôre in a great position to read through <a href="https://github.com/bikeshaving/crank/tree/master/src">the actual Crank source code</a> to see how these features are implemented for yourself.</p><p>If you were on the fence about using Crank, I can tell you from personal experience that it is deeply satisfying to know how your web framework works, down to the level of DOM mutations. It means that your mental model for how your code executes is not just some story which you were told in some documentation or by a more experienced developer, but something which you can reason through and confirm for yourself.</p><p>The last couple of years, a common theme in web framework development has been the idea that somehow, the JavaScript runtime on its own is not enough to express a component framework. For example, both <a href="https://overreacted.io/react-as-a-ui-runtime/">React</a> and <a href="https://gist.github.com/Rich-Harris/0f910048478c2a6505d1c32185b61934">Svelte</a> maintainers have expressed some version of this idea. This idea is then used to justify the great lengths these frameworks go to add what they consider the missing parts. What I hope to have shown in this essay is that JavaScript already provides some powerful primitives, namely async and generator functions. By combining these primitives with basic virtual DOM techniques, we can create a component framework which is easy to implement on your own.</p><p>If you have any questions, feel free to reach out via GitHub or email. I will make an effort to update this essay based on feedback about what people found unclear. Thank you for reading.</p></div></article><div class="css-1gworah"><a href="https://github.com/bikeshaving/crank/edit/main/docs/blog/2020-10-13-writing-crank-from-scratch.md" target="_blank" rel="noopener noreferrer" class="css-vrpffa"><svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>Edit on GitHub</a></div><div class="css-9hlwm"><script src="https://giscus.app/client.js" data-repo="bikeshaving/crank" data-repo-id="MDEwOlJlcG9zaXRvcnkyMDY0Mzk3MDc=" data-category="Comments" data-category-id="DIC_kwDODE4FG84Cw3V5" data-mapping="url" data-strict="1" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="top" data-theme="preferred_color_scheme" data-lang="en" data-loading="lazy" crossorigin="anonymous" async></script></div></main><footer class="css-1nd56js"><nav class="css-nf2n4z"><a href="/guides/getting-started">Docs</a><a href="/blog">Blog</a><a href="/playground">Playground</a><a href="https://github.com/bikeshaving/crank">GitHub</a><a href="https://www.npmjs.com/package/@b9g/crank">NPM</a></nav><p class="css-1st8n6b">MIT Licensed ¬∑ Made with Crank.js</p></footer><script data-name="embedded-json-63" id="static-urls">
			if (window.__embeddedJSON__ == null) {
				window.__embeddedJSON__ = {};
			}
			window.__embeddedJSON__['embedded-json-63'] = {"client.css":"\u002Fstatic\u002Fclient-3f2e47bea41770a9.css","@b9g\u002Fcrank":"\u002Fstatic\u002Findex-edda6cf40c955e0b.js","@b9g\u002Fcrank\u002Fasync":"\u002Fstatic\u002Fasync-e24e607c061c2bd6.js","@b9g\u002Fcrank\u002Fdom":"\u002Fstatic\u002Fdom-aa42f22e47f5e08f.js","@b9g\u002Fcrank\u002Fevent-target":"\u002Fstatic\u002Fevent-target-2c01c58f7606eeb9.js","@b9g\u002Fcrank\u002Fhtml":"\u002Fstatic\u002Fhtml-51dd6651603637e1.js","@b9g\u002Fcrank\u002Fjsx-dev-runtime":"\u002Fstatic\u002Fjsx-dev-runtime-d4251d2d2df77801.js","@b9g\u002Fcrank\u002Fjsx-runtime":"\u002Fstatic\u002Fjsx-runtime-d4251d2d2df77801.js","@b9g\u002Fcrank\u002Fjsx-tag":"\u002Fstatic\u002Fjsx-tag-baf2f4398d28ee0f.js","@b9g\u002Fcrank\u002Fstandalone":"\u002Fstatic\u002Fstandalone-0a4d0927a194cb53.js"};
		</script><script type="module" src="/static/navbar-576c280523a27b04.js"></script><script type="module" src="/static/code-blocks-da77989e7aab39db.js"></script><script type="module" src="/static/search-8c387537e444c409.js"></script><script type="module" src="/static/gear-16699826f92534de.js"></script></body></html>