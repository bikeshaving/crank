<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>Crank.js | Async Components</title><link href="/static/index-UEEVTAOK.css" rel="stylesheet" type="text/css"><link rel="shortcut icon" href="/static/favicon.ico"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-20910936-4"></script><script>
								window.dataLayer = window.dataLayer || [];
								function gtag(){dataLayer.push(arguments);}
								gtag('js', new Date());

								gtag('config', 'UA-20910936-4');
							</script></head><body><nav id="navbar" class="navbar"><div class="navbar-group"><div class="navbar-item"><a class="navbar-title-link false" href="/"><img class="navbar-logo" src="/static/logo.svg" alt=""><span>Crank.js</span></a></div><div class="navbar-item"><a class="current" href="/guides/getting-started">Docs</a></div><div class="navbar-item"><a href="/blog/">Blog</a></div></div><div class="navbar-group"><div class="navbar-item"><a href="https://github.com/bikeshaving/crank">GitHub</a></div><div class="navbar-item"><a href="http://npm.im/@bikeshaving/crank">NPM</a></div></div></nav><div class="non-footer"><div id="sidebar" class="sidebar"><h3>Guides</h3><div class="sidebar-item"><a href="/guides/getting-started" class="">Getting Started</a></div><div class="sidebar-item"><a href="/guides/elements" class="">JSX, Elements and Renderers</a></div><div class="sidebar-item"><a href="/guides/components" class="">Components</a></div><div class="sidebar-item"><a href="/guides/handling-events" class="">Handling Events</a></div><div class="sidebar-item"><a href="/guides/async-components" class="current">Async Components</a></div><div class="sidebar-item"><a href="/guides/special-props-and-tags" class="">Special Props and Tags</a></div><div class="sidebar-item"><a href="/guides/lifecycles" class="">Lifecycles</a></div><div class="sidebar-item"><a href="/guides/reusable-logic" class="">Reusable Logic</a></div><div class="sidebar-item"><a href="/guides/working-with-typescript" class="">Working with TypeScript</a></div><div class="sidebar-item"><a href="/guides/reference-for-react-developers" class="">Reference for React Developers</a></div><div class="sidebar-item"><a href="/guides/api-reference" class="">API Reference</a></div></div><main class="main"><div class="content"><h1>Async Components</h1><h2>Async Function Components</h2><p>So far, every component we’ve seen has worked synchronously, and Crank will respect this as an intentional decision by the developer by keeping the entire process of rendering synchronous from start to finish. However, modern JavaScript includes promises and <code class="inline">async</code>/<code class="inline">await</code>, which allow you to write concurrently executing code as if it were synchronous. To facilitate these features, Crank allows components to be asynchronous functions as well, and we call these components, <em>async function components</em>.</p><div class="codeblock" data-code="async function IPAddress () {
  const res = await fetch(&quot;https://api.ipify.org&quot;);
  const address = await res.text();
  return &lt;div&gt;Your IP Address: {address}&lt;/div&gt;;
}

(async () =&gt; {
  await renderer.render(&lt;IPAddress /&gt;, document.body);
  console.log(document.body.innerHTML); // &lt;div&gt;Your IP Address: 127.0.0.1&lt;/div&gt;
})();" data-lang="jsx"><div class="playground"><content-area><pre class="editable" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"><div><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">IPAddress</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div><code>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;https://api.ipify.org&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token keyword">const</span> address <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>Your <span class="token constant">IP</span> Address<span class="token operator">:</span> <span class="token punctuation">{</span>address<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span></code><br></div><div><code><span class="token punctuation">}</span></code><br></div><div><code></code><br></div><div><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div><code>  <span class="token keyword">await</span> renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">IPAddress</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;div&gt;Your IP Address: 127.0.0.1&lt;/div&gt;</span></code><br></div><div><code><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div></pre></content-area></div></div><p>When Crank renders an async component anywhere in the tree, the entire process becomes asynchronous. Concretely, this means that <code class="inline">renderer.render</code> or <code class="inline">this.refresh</code> calls return a promise which fulfills when rendering has finished. It also means that no actual DOM updates will be triggered until this moment.</p><h3>Concurrent Updates</h3><p>Because async function components can be rerendered while they are still pending, Crank implements a couple rules to make concurrent updates predictable and performant:</p><ol><li>There can only be one pending run of an async function component at the same time for an element in the tree. If the same async component is rerendered concurrently while it is still pending, another call is enqueued with the latest props.</li></ol><div class="codeblock" data-code="async function Delay ({message}) {
  await new Promise((resolve) =&gt; setTimeout(resolve, 1000));
  return &lt;div&gt;{message}&lt;/div&gt;;
}

(async () =&gt; {
  const p1 = renderer.render(&lt;Delay message=&quot;Run 1&quot; /&gt;, document.body);
  console.log(document.body.innerHTML); // &quot;&quot;
  await p1;
  console.log(document.body.innerHTML); // &quot;&lt;div&gt;Run 1&lt;/div&gt;&quot;
  const p2 = renderer.render(&lt;Delay message=&quot;Run 2&quot; /&gt;, document.body);
  // These renders are enqueued because the second render is still pending.
  const p3 = renderer.render(&lt;Delay message=&quot;Run 3&quot; /&gt;, document.body);
  const p4 = renderer.render(&lt;Delay message=&quot;Run 4&quot; /&gt;, document.body);
  console.log(document.body.innerHTML); // &quot;&lt;div&gt;Run 1&lt;/div&gt;&quot;
  await p2;
  console.log(document.body.innerHTML); // &quot;&lt;div&gt;Run 2&lt;/div&gt;&quot;
  // By the time the third render fulfills, the fourth render has already completed.
  await p3;
  console.log(document.body.innerHTML); // &quot;&lt;div&gt;Run 4&lt;/div&gt;&quot;
  await p4;
  console.log(document.body.innerHTML); // &quot;&lt;div&gt;Run 4&lt;/div&gt;&quot;
})();" data-lang="jsx"><div class="playground"><content-area><pre class="editable" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"><div><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Delay</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div><code>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>message<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span></code><br></div><div><code><span class="token punctuation">}</span></code><br></div><div><code></code><br></div><div><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div><code>  <span class="token keyword">const</span> p1 <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Delay</span></span> <span class="token attr-name">message</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Run 1<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;&quot;</span></code><br></div><div><code>  <span class="token keyword">await</span> p1<span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;&lt;div&gt;Run 1&lt;/div&gt;&quot;</span></code><br></div><div><code>  <span class="token keyword">const</span> p2 <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Delay</span></span> <span class="token attr-name">message</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Run 2<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token comment">// These renders are enqueued because the second render is still pending.</span></code><br></div><div><code>  <span class="token keyword">const</span> p3 <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Delay</span></span> <span class="token attr-name">message</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Run 3<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token keyword">const</span> p4 <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Delay</span></span> <span class="token attr-name">message</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Run 4<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;&lt;div&gt;Run 1&lt;/div&gt;&quot;</span></code><br></div><div><code>  <span class="token keyword">await</span> p2<span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;&lt;div&gt;Run 2&lt;/div&gt;&quot;</span></code><br></div><div><code>  <span class="token comment">// By the time the third render fulfills, the fourth render has already completed.</span></code><br></div><div><code>  <span class="token keyword">await</span> p3<span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;&lt;div&gt;Run 4&lt;/div&gt;&quot;</span></code><br></div><div><code>  <span class="token keyword">await</span> p4<span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;&lt;div&gt;Run 4&lt;/div&gt;&quot;</span></code><br></div><div><code><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div></pre></content-area></div></div><p>In the preceding example, at no point is there more than one simultaneous call to the <code class="inline">Delay</code> component, despite the fact that it is rerendered concurrently for its second through fourth renders. And because these renderings are enqueued, only the second and fourth renderings have any effect. This is because the element is busy with the second render by the time the third and fourth renderings are requested, and then, only the fourth rendering is actually executed because third rendering’s props are obsolete by the time the component is ready to update again. This behavior allows async components to always be kept up-to-date without producing excess calls to the function.</p><ol start="2"><li>If two different async components are rendered in the same position, the components are raced. If the earlier component fulfills first, it shows until the later component fulfills. If the later component fulfills first, the earlier component is never rendered.</li></ol><div class="codeblock" data-code="async function Fast() {
  await new Promise((resolve) =&gt; setTimeout(resolve, 500));
  return &lt;span&gt;Fast&lt;/span&gt;;
}

async function Slow() {
  await new Promise((resolve) =&gt; setTimeout(resolve, 1000));
  return &lt;span&gt;Slow&lt;/span&gt;;
}

(async () =&gt; {
  const p1 = renderer.render(&lt;div&gt;&lt;Fast /&gt;&lt;/div&gt;, document.body);
  const p2 = renderer.render(&lt;div&gt;&lt;Slow /&gt;&lt;/div&gt;, document.body);
  await p1;
  console.log(document.body.innerHTML); // &quot;&lt;div&gt;&lt;span&gt;Fast&lt;/span&gt;&lt;/div&gt;&quot;
  await p2;
  console.log(document.body.innerHTML); // &quot;&lt;div&gt;&lt;span&gt;Slow&lt;/span&gt;&lt;/div&gt;&quot;
  await new Promise((resolve) =&gt; setTimeout(resolve, 2000));
  console.log(document.body.innerHTML); // &quot;&lt;div&gt;&lt;span&gt;Slow&lt;/span&gt;&lt;/div&gt;&quot;
})();

(async () =&gt; {
  const p1 = renderer.render(&lt;div&gt;&lt;Slow /&gt;&lt;/div&gt;, document.body);
  const p2 = renderer.render(&lt;div&gt;&lt;Fast /&gt;&lt;/div&gt;, document.body);
  await p1;
  console.log(document.body.innerHTML); // &quot;&lt;div&gt;&lt;span&gt;Fast&lt;/span&gt;&lt;/div&gt;&quot;
  await p2;
  console.log(document.body.innerHTML); // &quot;&lt;div&gt;&lt;span&gt;Fast&lt;/span&gt;&lt;/div&gt;&quot;
  await new Promise((resolve) =&gt; setTimeout(resolve, 2000));
  console.log(document.body.innerHTML); // &quot;&lt;div&gt;&lt;span&gt;Fast&lt;/span&gt;&lt;/div&gt;&quot;
})();" data-lang="jsx"><div class="playground"><content-area><pre class="editable" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"><div><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Fast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div><code>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>Fast<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span></code><br></div><div><code><span class="token punctuation">}</span></code><br></div><div><code></code><br></div><div><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div><code>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>Slow<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span></code><br></div><div><code><span class="token punctuation">}</span></code><br></div><div><code></code><br></div><div><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div><code>  <span class="token keyword">const</span> p1 <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Fast</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token keyword">const</span> p2 <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Slow</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token keyword">await</span> p1<span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;&lt;div&gt;&lt;span&gt;Fast&lt;/span&gt;&lt;/div&gt;&quot;</span></code><br></div><div><code>  <span class="token keyword">await</span> p2<span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;&lt;div&gt;&lt;span&gt;Slow&lt;/span&gt;&lt;/div&gt;&quot;</span></code><br></div><div><code>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;&lt;div&gt;&lt;span&gt;Slow&lt;/span&gt;&lt;/div&gt;&quot;</span></code><br></div><div><code><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code></code><br></div><div><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div><code>  <span class="token keyword">const</span> p1 <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Slow</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token keyword">const</span> p2 <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Fast</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token keyword">await</span> p1<span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;&lt;div&gt;&lt;span&gt;Fast&lt;/span&gt;&lt;/div&gt;&quot;</span></code><br></div><div><code>  <span class="token keyword">await</span> p2<span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;&lt;div&gt;&lt;span&gt;Fast&lt;/span&gt;&lt;/div&gt;&quot;</span></code><br></div><div><code>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;&lt;div&gt;&lt;span&gt;Fast&lt;/span&gt;&lt;/div&gt;&quot;</span></code><br></div><div><code><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div></pre></content-area></div></div><p>As we’ll see later, this ratcheting effect becomes useful for rendering fallback states for async components.</p><h2>Async Generator Components</h2><p>Just as you can write stateful components with sync generator functions, you can also write stateful <em>async</em> components with <em>async generator functions</em>.</p><div class="codeblock" data-code="async function *AsyncLabeledCounter ({message}) { 
  let count = 0;
  for await ({message} of this) {
    yield &lt;div&gt;Loading...&lt;/div&gt;;
    await new Promise((resolve) =&gt; setTimeout(resolve, 1000));
    count++;
    yield &lt;div&gt;{message} {count}&lt;/div&gt;;
  }
}

(async () =&gt; {
  await renderer.render(
    &lt;AsyncLabeledCounter message=&quot;The count is now: &quot; /&gt;,
    document.body,
  );
  console.log(document.body.innerHTML); //&lt;div&gt;Loading...&lt;/div&gt;
  await new Promise((resolve) =&gt; setTimeout(resolve, 2000));
  console.log(document.body.innerHTML); //&lt;div&gt;The count is now: 1&lt;/div&gt;
  await renderer.render(
    &lt;AsyncLabeledCounter message=&quot;The count is now: &quot; /&gt;,
    document.body,
  );
  console.log(document.body.innerHTML); //&lt;div&gt;Loading...&lt;/div&gt;
  await new Promise((resolve) =&gt; setTimeout(resolve, 2000));
  console.log(document.body.innerHTML); //&lt;div&gt;The count is now: 2&lt;/div&gt;
  await new Promise((resolve) =&gt; setTimeout(resolve, 2000));
  console.log(document.body.innerHTML); //&lt;div&gt;The count is now: 2&lt;/div&gt;
})();" data-lang="jsx"><div class="playground"><content-area><pre class="editable" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"><div><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">AsyncLabeledCounter</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </code><br></div><div><code>  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>message<span class="token punctuation">}</span> <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div><code>    <span class="token keyword">yield</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>Loading<span class="token operator">...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span></code><br></div><div><code>    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>    count<span class="token operator">++</span><span class="token punctuation">;</span></code><br></div><div><code>    <span class="token keyword">yield</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>message<span class="token punctuation">}</span> <span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token punctuation">}</span></code><br></div><div><code><span class="token punctuation">}</span></code><br></div><div><code></code><br></div><div><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div><code>  <span class="token keyword">await</span> renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></code><br></div><div><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AsyncLabeledCounter</span></span> <span class="token attr-name">message</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>The count is now: <span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span></code><br></div><div><code>    document<span class="token punctuation">.</span>body<span class="token punctuation">,</span></code><br></div><div><code>  <span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&lt;div&gt;Loading...&lt;/div&gt;</span></code><br></div><div><code>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&lt;div&gt;The count is now: 1&lt;/div&gt;</span></code><br></div><div><code>  <span class="token keyword">await</span> renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></code><br></div><div><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AsyncLabeledCounter</span></span> <span class="token attr-name">message</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>The count is now: <span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span></code><br></div><div><code>    document<span class="token punctuation">.</span>body<span class="token punctuation">,</span></code><br></div><div><code>  <span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&lt;div&gt;Loading...&lt;/div&gt;</span></code><br></div><div><code>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&lt;div&gt;The count is now: 2&lt;/div&gt;</span></code><br></div><div><code>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&lt;div&gt;The count is now: 2&lt;/div&gt;</span></code><br></div><div><code><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div></pre></content-area></div></div><p><code class="inline">AsyncLabeledCounter</code> is an async version of the <code class="inline">LabeledCounter</code> example introduced in <a href="./components#props-updates">the section on props updates</a>. This example demonstrates several key differences between sync and async generator components. Firstly, rather than using <code class="inline">while</code> or <code class="inline">for…of</code> loops as with sync generator components, we now use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for-await...of">a <code class="inline">for await…of</code> loop</a>. This is possible because contexts are not just an <em>iterable</em> of props, but also an <em>async iterable</em> of props as well.</p><p>Secondly, you’ll notice that the async generator yields multiple times per iteration over <code class="inline">this</code>, once to show a loading message and once to show the actual count. While it is possible for sync generators components to yield multiple times per iteration over <code class="inline">this</code>, it wouldn’t necessarily make sense to do so because generators suspend at each yield, and upon resuming a second time within the same loop, the props would be stale. In contrast, async generator components are continuously resumed. Rather than suspending at each yield, we rely on the <code class="inline">for await…of</code> loop, which suspends at its end until the next update.</p><h3>Loading Indicators</h3><p>The async components we’ve seen so far have been all or nothing, in the sense that Crank can’t show anything until all promises in the tree have fulfilled. This can be a problem when you have an async call which takes longer than expected. It would be nice if parts of the element tree could be shown without waiting, to create responsive user experiences.</p><p>However, because loading indicators which show immediately can paradoxically make your app seem less responsive, we use the async rules described previously along with async generator functions to show loading indicators which appear only when certain components take too long.</p><div class="codeblock" data-code="async function LoadingIndicator() {
  await new Promise(resolve =&gt; setTimeout(resolve, 1000));
  return &lt;div&gt;Fetching a good boy...&lt;/div&gt;;
}

async function RandomDog({throttle = false}) {
  const res = await fetch(&quot;https://dog.ceo/api/breeds/image/random&quot;);
  const data = await res.json();
  if (throttle) {
    await new Promise(resolve =&gt; setTimeout(resolve, 2000));
  }

  return (
    &lt;a href={data.message}&gt;
      &lt;img src={data.message} alt=&quot;A Random Dog&quot; width=&quot;300&quot; /&gt;
    &lt;/a&gt;
  );
}

async function *RandomDogLoader({throttle}) {
  for await ({throttle} of this) {
    yield &lt;LoadingIndicator /&gt;;
    yield &lt;RandomDog throttle={throttle} /&gt;;
  }
}

function *RandomDogApp() {
  let throttle = false;
  this.addEventListener(&quot;click&quot;, (ev) =&gt; {
    if (ev.target.tagName === &quot;BUTTON&quot;) {
      throttle = !throttle;
      this.refresh();
    }
  });

  while (true) {
    yield (
      &lt;Fragment&gt;
        &lt;div&gt;
          &lt;button&gt;Show me another dog.&lt;/button&gt;
        &lt;/div&gt;
        &lt;RandomDogLoader throttle={throttle} /&gt;
      &lt;/Fragment&gt;
    );
  }
}

renderer.render(&lt;RandomDogApp /&gt;, document.body);" data-lang="jsx"><div class="playground"><content-area><pre class="editable" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"><div><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">LoadingIndicator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div><code>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>Fetching a good boy<span class="token operator">...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span></code><br></div><div><code><span class="token punctuation">}</span></code><br></div><div><code></code><br></div><div><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">RandomDog</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>throttle <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div><code>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;https://dog.ceo/api/breeds/image/random&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>throttle<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div><code>    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token punctuation">}</span></code><br></div><div><code></code><br></div><div><code>  <span class="token keyword">return</span> <span class="token punctuation">(</span></code><br></div><div><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>data<span class="token punctuation">.</span>message<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span></code><br></div><div><code>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>data<span class="token punctuation">.</span>message<span class="token punctuation">}</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>A Random Dog<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>300<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span></code><br></div><div><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></code><br></div><div><code>  <span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code><span class="token punctuation">}</span></code><br></div><div><code></code><br></div><div><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">RandomDogLoader</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>throttle<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div><code>  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>throttle<span class="token punctuation">}</span> <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div><code>    <span class="token keyword">yield</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">LoadingIndicator</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">;</span></code><br></div><div><code>    <span class="token keyword">yield</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">RandomDog</span></span> <span class="token attr-name">throttle</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>throttle<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token punctuation">}</span></code><br></div><div><code><span class="token punctuation">}</span></code><br></div><div><code></code><br></div><div><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">RandomDogApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div><code>  <span class="token keyword">let</span> throttle <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div><code>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>target<span class="token punctuation">.</span>tagName <span class="token operator">===</span> <span class="token string">&quot;BUTTON&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div><code>      throttle <span class="token operator">=</span> <span class="token operator">!</span>throttle<span class="token punctuation">;</span></code><br></div><div><code>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>    <span class="token punctuation">}</span></code><br></div><div><code>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code></code><br></div><div><code>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div><code>    <span class="token keyword">yield</span> <span class="token punctuation">(</span></code><br></div><div><code>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Fragment</span></span><span class="token punctuation">&gt;</span></span></code><br></div><div><code>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span></code><br></div><div><code>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>Show me another dog<span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span></code><br></div><div><code>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></code><br></div><div><code>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">RandomDogLoader</span></span> <span class="token attr-name">throttle</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>throttle<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span></code><br></div><div><code>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Fragment</span></span><span class="token punctuation">&gt;</span></span></code><br></div><div><code>    <span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token punctuation">}</span></code><br></div><div><code><span class="token punctuation">}</span></code><br></div><div><code></code><br></div><div><code>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">RandomDogApp</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div></pre></content-area></div></div><p>In this example, the <code class="inline">RandomDogLoader</code> component is an async generator component which races the <code class="inline">LoadingIndicator</code> component with the <code class="inline">RandomDog</code> component. Because the async generator component resumes continuously, both components are rendered, and according to the second rule of async components, the loading indicator only shows if the <code class="inline">RandomDog</code> component takes longer than the <code class="inline">LoadingIndicator</code> component, which fulfills at a fixed interval of one second.</p><p>The preceding example hints at how we could abstract this pattern to implement the <code class="inline">Suspense</code> component from React.</p><div class="codeblock" data-code="async function Fallback({timeout = 1000, children}) {
  await new Promise((resolve) =&gt; setTimeout(resolve, timeout));
  return children;
}

async function *Suspense({timeout, fallback, children}) {
  for await ({timeout, fallback, children} of this) {
    yield &lt;Fallback timeout={timeout}&gt;{fallback}&lt;/Fallback&gt;;
    yield &lt;Fragment&gt;{children}&lt;/Fragment&gt;;
  }
}

(async () =&gt; {
  await renderer.render(
    &lt;Suspense fallback={&lt;Spinner /&gt;}&gt;
      &lt;ProfilePage /&gt;
    &lt;/Suspense&gt;,
    document.body,
  );
})();" data-lang="jsx"><div class="playground"><content-area><pre class="editable" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"><div><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Fallback</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>timeout <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span> children<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div><code>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token keyword">return</span> children<span class="token punctuation">;</span></code><br></div><div><code><span class="token punctuation">}</span></code><br></div><div><code></code><br></div><div><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">Suspense</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>timeout<span class="token punctuation">,</span> fallback<span class="token punctuation">,</span> children<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div><code>  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>timeout<span class="token punctuation">,</span> fallback<span class="token punctuation">,</span> children<span class="token punctuation">}</span> <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><br></div><div><code>    <span class="token keyword">yield</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Fallback</span></span> <span class="token attr-name">timeout</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>timeout<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>fallback<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Fallback</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span></code><br></div><div><code>    <span class="token keyword">yield</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Fragment</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Fragment</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span></code><br></div><div><code>  <span class="token punctuation">}</span></code><br></div><div><code><span class="token punctuation">}</span></code><br></div><div><code></code><br></div><div><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code><br></div><div><code>  <span class="token keyword">await</span> renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></code><br></div><div><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Suspense</span></span> <span class="token attr-name">fallback</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Spinner</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span></code><br></div><div><code>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ProfilePage</span></span> <span class="token punctuation">/&gt;</span></span></code><br></div><div><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Suspense</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span></code><br></div><div><code>    document<span class="token punctuation">.</span>body<span class="token punctuation">,</span></code><br></div><div><code>  <span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div><div><code><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><br></div></pre></content-area></div></div><p>No special tags are needed for async loading states, and the functionality to write this logic is implemented using the same element diffing algorithm that governs synchronous components. Additionally, this approach is more flexible in the sense that you can extend it; for instance, you can add another yield to the <code class="inline">for await…of</code> loop to show a second fallback state which waits ten seconds, to inform the user that something went wrong or that servers are slow to respond.</p></div></main></div><script src="/static/index-FZKVRLRI.js"></script></body></html>