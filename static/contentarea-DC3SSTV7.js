import{a as V}from"./chunk-LZNF55WU.js";import{h as j,i as K}from"./chunk-Z4NPT5MU.js";j();K();var v=Symbol.for("ContentArea._cache"),w=Symbol.for("ContentArea._observer"),D=Symbol.for("ContentArea._onselectionchange"),S=Symbol.for("ContentArea._value"),p=Symbol.for("ContentArea._selectionRange"),O=Symbol.for("ContentArea._staleValue"),b=Symbol.for("ContentArea._slateSelectionRange"),m=Symbol.for("ContentArea._compositionBuffer"),A=Symbol.for("ContentArea._compositionStartValue"),L=Symbol.for("ContentArea._compositionSelectionRange"),Y=class extends HTMLElement{constructor(){super(),this[v]=new Map,this[w]=new MutationObserver(e=>{this[m]&&this[m].push(...e),a(this,e)}),this[D]=()=>{this[p]=y(this)},this[S]="",this[p]={start:0,end:0,direction:"none"},this[O]=void 0,this[b]=void 0,this[m]=void 0,this[A]=void 0,this[L]=void 0}connectedCallback(){this[w].observe(this,{subtree:!0,childList:!0,characterData:!0,characterDataOldValue:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["data-content"]}),document.addEventListener("selectionchange",this[D],!0),a(this),this[D]();let e;this.addEventListener("compositionstart",()=>{clearTimeout(e),e==null&&(this[m]=[],this[A]=this[S],this[L]={...this[p]}),e=void 0});let i=()=>{if(this[m]&&this[m].length>0&&this[A]!==void 0&&this[L]!==void 0){let s=V.diff(this[A],this[S],this[L].start),l=new W("contentchange",{detail:{edit:s,source:null,mutations:this[m]}});this.dispatchEvent(l),this[O]=void 0,this[b]=void 0}this[m]=void 0,this[A]=void 0,this[L]=void 0,e=void 0};this.addEventListener("compositionend",()=>{clearTimeout(e),e=setTimeout(i)}),this.addEventListener("blur",()=>{clearTimeout(e),i()}),this.addEventListener("keydown",s=>{s.key==="Escape"&&this[m]&&(clearTimeout(e),i())})}disconnectedCallback(){this[v].clear(),this[S]="",this[w].disconnect(),document&&document.removeEventListener("selectionchange",this[D],!0)}get value(){return a(this),this[O]==null?this[S]:this[O]}get selectionStart(){return a(this),(this[b]||this[p]).start}set selectionStart(e){a(this);let{end:i,direction:s}=y(this);x(this,{start:e,end:i,direction:s})}get selectionEnd(){return a(this),(this[b]||this[p]).end}set selectionEnd(e){a(this);let{start:i,direction:s}=y(this);x(this,{start:i,end:e,direction:s})}get selectionDirection(){return a(this),(this[b]||this[p]).direction}set selectionDirection(e){a(this);let{start:i,end:s}=y(this);x(this,{start:i,end:s,direction:e})}getSelectionRange(){return a(this),{...this[b]||this[p]}}setSelectionRange(e,i,s="none"){a(this),x(this,{start:e,end:i,direction:s})}indexAt(e,i){return a(this),H(this,e,i)}nodeOffsetAt(e){return a(this),M(this,e)}source(e){return a(this,this[w].takeRecords(),e)}},z=Symbol.for("ContentArea.PreventDefaultSource"),W=class extends CustomEvent{constructor(e,i){super(e,{bubbles:!0,...i})}preventDefault(){if(this.defaultPrevented)return;super.preventDefault();let e=this.target;e[O]=e[S],e[b]=e[p];let i=this.detail.mutations;for(let l=i.length-1;l>=0;l--){let t=i[l];switch(t.type){case"childList":{for(let n=0;n<t.addedNodes.length;n++){let r=t.addedNodes[n];r.parentNode&&r.parentNode.removeChild(r)}for(let n=0;n<t.removedNodes.length;n++){let r=t.removedNodes[n];t.target.insertBefore(r,t.nextSibling)}break}case"characterData":{t.oldValue!==null&&(t.target.data=t.oldValue);break}case"attributes":{t.oldValue===null?t.target.removeAttribute(t.attributeName):t.target.setAttribute(t.attributeName,t.oldValue);break}}}let s=e[w].takeRecords();a(e,s,z)}},I=1,k=2,F=4,T=8,X=16,_=class{constructor(e){this.f=0,this.offset=e,this.length=0}};function a(o,e=o[w].takeRecords(),i=null){if(typeof o!="object"||o[v]==null)throw new TypeError("this is not a ContentAreaElement");if(!document.contains(o))throw new Error("ContentArea cannot be read before it is inserted into the DOM");if(!G(o,e))return!1;let s=o[S],l=J(o,s,o[p].start);if(o[S]=l.apply(s),o[p]=y(o),i!==z&&!o[m]){let t=new W("contentchange",{detail:{edit:l,source:i,mutations:e}});o.dispatchEvent(t),o[O]=void 0,o[b]=void 0}return!0}function G(o,e){let i=o[v];if(!i.get(o))return!0;let s=!1;for(let l=0;l<e.length;l++){let t=e[l];for(let r=0;r<t.addedNodes.length;r++){let c=t.addedNodes[r];P(c,i)}for(let r=0;r<t.removedNodes.length;r++)P(t.removedNodes[r],i);let n=t.target;if(n===o){s=!0;continue}else if(!o.contains(n)){P(n,i);continue}for(;n!==o&&i.has(n);n=n.parentNode){let r=i.get(n);r&&(r.f&=~k),s=!0}}if(s){let l=i.get(o);l.f&=~k}return s}function P(o,e){let i=document.createTreeWalker(o,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT);for(let s=o;s!==null;s=i.nextNode())e.delete(s)}var f=`
`;function J(o,e,i){let s=document.createTreeWalker(o,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT),l=o[v],t=[],n,r="";for(let d=o,N=!0,u=0,h=0,C=0,E=!1;;d=s.currentNode){if(N){if(n=l.get(d),n===void 0)l.set(d,n=new _(u)),U(d)&&(n.f|=F);else{let g=h-C,B=n.offset-g;if(B<0)throw new Error("cache offset error");B>0&&(h+=B),n.offset=u}if(u&&!E&&n.f&F?(E=!0,u+=f.length,r+=f,n.f&T&&(h+=f.length),n.f|=T):(n.f&T&&(h+=f.length),n.f&=~T),N=!1,n.f&k)n.length&&(r+=e.slice(h,h+n.length),h+=n.length,u+=n.length,E=e.slice(Math.max(0,h-f.length),h)===f);else if(d.nodeType===Node.TEXT_NODE){let g=d.data;g.length&&(r+=g,u+=g.length,E=g.endsWith(f)),n.f&I&&(h+=n.length)}else if(d.hasAttribute("data-content")){let g=d.getAttribute("data-content")||"";g.length&&(r+=g,u+=g.length,E=g.endsWith(f)),n.f&I&&(h+=n.length)}else d.nodeName==="BR"?(r+=f,u+=f.length,E=!0,n.f&I&&(h+=n.length)):(N=!!s.firstChild(),N&&(t.push({nodeInfo:n,oldIndexRelative:C}),u=0,C=h))}else{if(!t.length)throw new Error("Stack is empty");n.f&T&&(u+=f.length),{nodeInfo:n,oldIndexRelative:C}=t.pop(),u=n.offset+u}if(!N&&(n.f&k||(!E&&n.f&F?(r+=f,u+=f.length,E=!0,n.f|=X):n.f&=~X,n.length=u-n.offset,n.f|=k),n.f|=I,N=!!s.nextSibling(),!N)){if(s.currentNode===o)break;s.parentNode()}if(h>e.length)throw new Error("cache length error")}let c=y(o).start;return V.diff(e,r,Math.min(i,c))}var Q=new Set(["block","flex","grid","flow-root","list-item","table","table-row-group","table-header-group","table-footer-group","table-row","table-caption"]);function U(o){return o.nodeType===Node.ELEMENT_NODE&&Q.has(getComputedStyle(o).display.split(" ")[0])}function H(o,e,i){let s=o[v];if(e==null||!o.contains(e))return-1;if(!s.has(e))for(i=0;!s.has(e);)e=e.parentNode;let l;if(e.nodeType===Node.TEXT_NODE){let t=s.get(e);l=i+t.offset,e=e.parentNode}else if(i<=0)l=0;else if(i>=e.childNodes.length){let t=s.get(e);l=t.f&X?t.length-f.length:t.length}else{let t=e.childNodes[i];for(;t!==null&&!s.has(t);)t=t.previousSibling;t===null?l=0:(e=t,l=s.get(e).f&T?-1:0)}for(;e!==o;e=e.parentNode){let t=s.get(e);l+=t.offset,t.f&T&&(l+=f.length)}return l}function M(o,e){if(e<0)return[null,0];let[i,s]=Z(o,e);return i&&i.nodeName==="BR"?R(i):[i,s]}function Z(o,e){let i=o[v],s=document.createTreeWalker(o,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT);for(let t=o;t!==null;){let n=i.get(t);if(n==null)return R(t,e>0);if(n.f&T&&(e-=1),e===n.length&&t.nodeType===Node.TEXT_NODE)return[t,t.data.length];if(e>=n.length){e-=n.length;let r=s.nextSibling();if(r===null)return t===o?[t,q(t)]:R(s.currentNode,!0);t=r}else{if(t.nodeType===Node.ELEMENT_NODE&&t.hasAttribute("data-content"))return R(t,e>0);let r=s.firstChild();if(r===null){let c=t.nodeType===Node.TEXT_NODE?e:e>0?1:0;return[t,c]}else t=r}}let l=s.currentNode;return[l,q(l)]}function q(o){return o.nodeType===Node.TEXT_NODE?o.data.length:o.childNodes.length}function R(o,e=!1){let i=o.parentNode;if(i===null)return[null,0];let s=Array.from(i.childNodes).indexOf(o);return e&&s++,[i,s]}function y(o){let e=document.getSelection();if(!e)return{start:0,end:0,direction:"none"};let{focusNode:i,focusOffset:s,anchorNode:l,anchorOffset:t,isCollapsed:n}=e,r=Math.max(0,H(o,i,s)),c=n?r:Math.max(0,H(o,l,t));return{start:Math.min(r,c),end:Math.max(r,c),direction:r<c?"backward":r>c?"forward":"none"}}function x(o,{start:e,end:i,direction:s}){let l=document.getSelection();if(!l)return;e=Math.max(0,e||0),i=Math.max(0,i||0),i<e&&(e=i);let[t,n]=s==="backward"?[e,i]:[i,e];if(t===n){let[r,c]=M(o,t);l.collapse(r,c)}else{let[r,c]=M(o,n),[d,N]=M(o,t);r===null&&d===null?l.collapse(null):r===null?l.collapse(d,N):d===null?l.collapse(r,c):l.setBaseAndExtent(r,c,d,N)}}export{Y as ContentAreaElement,W as ContentEvent};
